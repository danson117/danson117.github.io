<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…„å¼Ÿé«”é‡è²¼ç´™ç´€éŒ„è¡¨ V2.0</title>
    <style>
        :root {
            --primary-color: #6366f1; /* Indigo */
            --secondary-color: #ec4899; /* Pink */
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-color: #e5e7eb;
            --highlight-bg: #fef3c7; /* Yellow for max record */
            --highlight-text: #92400e;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            position: relative;
        }

        .container {
            width: 100%;
            max-width: 900px;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            padding: 24px;
            margin-bottom: 40px; /* Space for version footer */
        }

        h1 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 24px;
            font-size: 1.8rem;
        }

        /* ç¸½çµå¡ç‰‡ */
        .summary-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .summary-card {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .summary-card.younger {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
        }

        .summary-card h2 {
            margin: 0 0 10px 0;
            font-size: 1.2rem;
            color: #3730a3;
        }
        .summary-card.younger h2 { color: #831843; }

        .total-stickers {
            font-size: 2rem;
            font-weight: 800;
            color: #312e81;
        }
        .summary-card.younger .total-stickers { color: #831843; }

        /* è¼¸å…¥å€åŸŸ */
        .input-section {
            background-color: #f8fafc;
            padding: 24px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            margin-bottom: 30px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4b5563;
        }

        .input-group input {
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .btn-container {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        button {
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-save {
            background-color: var(--primary-color);
            color: white;
        }
        .btn-save:hover { background-color: #4f46e5; transform: translateY(-1px); }

        .btn-cancel {
            background-color: #9ca3af;
            color: white;
            display: none; /* Hidden by default */
        }

        /* è¡¨æ ¼å€åŸŸ */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f1f5f9;
            font-weight: 700;
            color: #475569;
            white-space: nowrap;
        }

        tr:last-child td { border-bottom: none; }

        /* è²¼ç´™èˆ‡æ¨™è¨˜ */
        .sticker-badge {
            background-color: #fbbf24;
            color: #78350f;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .max-record-row {
            background-color: var(--highlight-bg) !important;
            position: relative;
        }
        
        .max-tag {
            font-size: 0.75em;
            background: #d97706;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 6px;
            vertical-align: middle;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 0.85em;
            margin-right: 4px;
            border-radius: 4px;
        }
        .edit-btn { background-color: #3b82f6; color: white; }
        .del-btn { background-color: #ef4444; color: white; }

        /* ç‰ˆæœ¬è™Ÿ */
        .version-footer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
        }

        .error-banner {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #b91c1c;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            text-align: center;
        }

        @media (max-width: 640px) {
            .summary-section { grid-template-columns: 1fr; }
            .input-grid { grid-template-columns: 1fr; }
            th, td { padding: 10px; font-size: 14px; }
            .sticker-badge { font-size: 0.8em; }
        }
    </style>
</head>
<body>

<div class="container">
    <div id="errorBanner" class="error-banner"></div>

    <h1>å…„å¼Ÿé«”é‡è²¼ç´™ç´€éŒ„è¡¨ âš–ï¸</h1>

    <!-- ç¸½çµ -->
    <div class="summary-section">
        <div class="summary-card">
            <h2>ğŸ‘¦ğŸ» ä¿¡å”¯ (å“¥å“¥)</h2>
            <div>ç¸½å…±ç²å¾—è²¼ç´™</div>
            <div class="total-stickers" id="totalOlder">0</div>
            <div style="font-size: 0.9em; margin-top:5px; color:#666;">ç›®å‰æœ€é«˜: <span id="currentMaxOlder">0</span> lbs</div>
        </div>
        <div class="summary-card younger">
            <h2>ğŸ‘¶ğŸ» å•Ÿæ·³ (ç´°ä½¬)</h2>
            <div>ç¸½å…±ç²å¾—è²¼ç´™</div>
            <div class="total-stickers" id="totalYounger">0</div>
            <div style="font-size: 0.9em; margin-top:5px; color:#666;">ç›®å‰æœ€é«˜: <span id="currentMaxYounger">0</span> lbs</div>
        </div>
    </div>

    <!-- è¼¸å…¥/ç·¨è¼¯å€åŸŸ -->
    <div class="input-section">
        <input type="hidden" id="editId"> <!-- éš±è—æ¬„ä½ï¼Œç”¨æ–¼å„²å­˜æ­£åœ¨ç·¨è¼¯çš„ ID -->
        <div class="input-grid">
            <div class="input-group">
                <label for="recordDate">æ—¥æœŸ</label>
                <input type="date" id="recordDate">
            </div>
            <div class="input-group">
                <label for="weightOlder">ä¿¡å”¯ é‡é‡ (kg)</label>
                <input type="number" id="weightOlder" step="0.01" placeholder="ä¾‹å¦‚ 22.5">
            </div>
            <div class="input-group">
                <label for="weightYounger">å•Ÿæ·³ é‡é‡ (kg)</label>
                <input type="number" id="weightYounger" step="0.01" placeholder="ä¾‹å¦‚ 20.3">
            </div>
        </div>
        <div class="btn-container">
            <button class="btn-save" id="saveBtn" onclick="saveRecord()">è¨˜éŒ„è³‡æ–™</button>
            <button class="btn-cancel" id="cancelBtn" onclick="cancelEdit()">å–æ¶ˆç·¨è¼¯</button>
        </div>
    </div>

    <!-- è¡¨æ ¼ -->
    <div class="table-container">
        <table id="recordTable">
            <thead>
                <tr>
                    <th>æ—¥æœŸ</th>
                    <th>ä¿¡å”¯ (kg/lbs)</th>
                    <th>è²¼ç´™</th>
                    <th>å•Ÿæ·³ (kg/lbs)</th>
                    <th>è²¼ç´™</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                <!-- JS æ¸²æŸ“ -->
            </tbody>
        </table>
    </div>
</div>

<div class="version-footer">Version 2.0</div>

<script>
    // --- è¨­å®šèˆ‡å¸¸æ•¸ ---
    const STORAGE_KEY = 'brother_weight_tracker_v2'; // æ›´æ–° Key ä»¥å€åˆ†èˆŠç‰ˆ
    const KG_TO_LBS = 2.20462;
    let records = [];
    let isEditing = false;

    // --- åˆå§‹åŒ– ---
    function init() {
        // è¨­å®šæ—¥æœŸè¼¸å…¥æ¡†é è¨­ç‚ºä»Šå¤©
        document.getElementById('recordDate').valueAsDate = new Date();
        loadData();
    }

    // --- æ•¸æ“šè™•ç† ---
    
    // è®€å–æ•¸æ“š (åŒ…å«éŒ¯èª¤è™•ç†)
    function loadData() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                records = JSON.parse(saved);
            }
            renderTable();
        } catch (e) {
            showError("ç„¡æ³•è®€å–å„²å­˜ç©ºé–“ (SecurityError)ã€‚<br>è«‹ç¢ºä¿æ‚¨ä¸æ˜¯åœ¨æ²™ç›’æ¨¡å¼(Sandbox)æˆ–é è¦½è¦–çª—ä¸­åŸ·è¡Œæ­¤æª”æ¡ˆã€‚<br>è«‹ç›´æ¥åœ¨é›»è…¦è³‡æ–™å¤¾ä¸­é›™æ“Š .html æª”æ¡ˆæ‰“é–‹ã€‚");
            console.error(e);
        }
    }

    // å„²å­˜æ•¸æ“š
    function saveDataToStorage() {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
        } catch (e) {
            showError("ç„¡æ³•å„²å­˜æ•¸æ“šï¼ç€è¦½å™¨é™åˆ¶äº†å­˜å–æ¬Šé™ã€‚");
        }
    }

    // æ–°å¢æˆ–æ›´æ–°ç´€éŒ„
    function saveRecord() {
        const dateInput = document.getElementById('recordDate').value;
        const wOlder = parseFloat(document.getElementById('weightOlder').value);
        const wYounger = parseFloat(document.getElementById('weightYounger').value);
        const editId = document.getElementById('editId').value;

        if (!dateInput || isNaN(wOlder) || isNaN(wYounger)) {
            alert("è«‹è¼¸å…¥å®Œæ•´çš„æ—¥æœŸå’Œé‡é‡æ•¸å€¼ï¼");
            return;
        }

        if (isEditing && editId) {
            // æ›´æ–°ç¾æœ‰ç´€éŒ„
            const index = records.findIndex(r => r.id == editId);
            if (index !== -1) {
                records[index].date = dateInput;
                records[index].olderKg = wOlder;
                records[index].youngerKg = wYounger;
                alert("ç´€éŒ„å·²æ›´æ–°ï¼è²¼ç´™æ•¸é‡å·²é‡æ–°è¨ˆç®—ã€‚");
            }
        } else {
            // æ–°å¢ç´€éŒ„
            const newRecord = {
                id: Date.now(), // ä½¿ç”¨æ™‚é–“æˆ³ä½œç‚ºå”¯ä¸€ ID
                date: dateInput,
                olderKg: wOlder,
                youngerKg: wYounger
            };
            records.push(newRecord);
        }

        // é‡ç½®è¡¨å–®
        cancelEdit();
        saveDataToStorage();
        renderTable();
    }

    // æº–å‚™ç·¨è¼¯
    function editRecord(id) {
        const record = records.find(r => r.id == id);
        if (!record) return;

        document.getElementById('recordDate').value = record.date;
        document.getElementById('weightOlder').value = record.olderKg;
        document.getElementById('weightYounger').value = record.youngerKg;
        document.getElementById('editId').value = record.id;
        
        // åˆ‡æ› UI ç‹€æ…‹
        isEditing = true;
        document.getElementById('saveBtn').textContent = "æ›´æ–°ç´€éŒ„";
        document.getElementById('saveBtn').style.backgroundColor = "#2563eb"; // Blue
        document.getElementById('cancelBtn').style.display = "inline-block";
        
        // æ»¾å‹•åˆ°è¼¸å…¥å€
        document.querySelector('.input-section').scrollIntoView({behavior: 'smooth'});
    }

    // å–æ¶ˆç·¨è¼¯
    function cancelEdit() {
        isEditing = false;
        document.getElementById('editId').value = '';
        document.getElementById('saveBtn').textContent = "è¨˜éŒ„è³‡æ–™";
        document.getElementById('saveBtn').style.backgroundColor = ""; // Reset to CSS default
        document.getElementById('cancelBtn').style.display = "none";
        
        // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦é‡è¨­æ—¥æœŸç‚ºä»Šå¤©
        document.getElementById('weightOlder').value = '';
        document.getElementById('weightYounger').value = '';
        document.getElementById('recordDate').valueAsDate = new Date();
    }

    // åˆªé™¤ç´€éŒ„
    function deleteRecord(id) {
        if(confirm("ç¢ºå®šè¦åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿåˆªé™¤å¾Œè²¼ç´™æœƒé‡æ–°è¨ˆç®—ã€‚")) {
            records = records.filter(r => r.id != id);
            saveDataToStorage();
            renderTable();
        }
    }

    // --- æ ¸å¿ƒé‚è¼¯ï¼šè¨ˆç®—èˆ‡æ¸²æŸ“ ---
    function renderTable() {
        const tbody = document.querySelector('#recordTable tbody');
        tbody.innerHTML = '';

        // 1. æ’åºï¼šç¢ºä¿æŒ‰æ—¥æœŸé †åºè¨ˆç®— (èˆŠ -> æ–°)
        records.sort((a, b) => new Date(a.date) - new Date(b.date));

        // 2. è®Šæ•¸åˆå§‹åŒ–
        let maxOlderLbs = 0;
        let maxYoungerLbs = 0;
        let totalStickersOlder = 0;
        let totalStickersYounger = 0;

        // æ‰¾å‡ºçµ•å°æœ€å¤§å€¼ (ç”¨æ–¼ Highlight é¡¯ç¤º)
        // é€™è£¡å…ˆè¨ˆç®—æ‰€æœ‰æ•¸æ“šè½‰æ›å¾Œçš„ lbs
        const allOlderLbs = records.map(r => toLbs(r.olderKg));
        const allYoungerLbs = records.map(r => toLbs(r.youngerKg));
        const absoluteMaxOlder = allOlderLbs.length > 0 ? Math.max(...allOlderLbs) : 0;
        const absoluteMaxYounger = allYoungerLbs.length > 0 ? Math.max(...allYoungerLbs) : 0;

        // 3. éæ­·æ¯ä¸€æ¢ç´€éŒ„é€²è¡Œè¨ˆç®—
        records.forEach((rec, index) => {
            const currentOlderLbs = toLbs(rec.olderKg);
            const currentYoungerLbs = toLbs(rec.youngerKg);
            
            // è¨ˆç®—ä¿¡å”¯è²¼ç´™
            let stickersOlder = 0;
            if (index === 0) {
                maxOlderLbs = currentOlderLbs; // ç¬¬ä¸€å¤©è¨­ç‚ºåŸºæº–
            } else {
                if (currentOlderLbs > maxOlderLbs) {
                    const diff = currentOlderLbs - maxOlderLbs;
                    stickersOlder = Math.floor(diff / 0.1);
                    maxOlderLbs = currentOlderLbs; // æ›´æ–°æ­·å²æœ€é«˜
                }
            }
            totalStickersOlder += stickersOlder;

            // è¨ˆç®—å•Ÿæ·³è²¼ç´™
            let stickersYounger = 0;
            if (index === 0) {
                maxYoungerLbs = currentYoungerLbs; // ç¬¬ä¸€å¤©è¨­ç‚ºåŸºæº–
            } else {
                if (currentYoungerLbs > maxYoungerLbs) {
                    const diff = currentYoungerLbs - maxYoungerLbs;
                    stickersYounger = Math.floor(diff / 0.1);
                    maxYoungerLbs = currentYoungerLbs; // æ›´æ–°æ­·å²æœ€é«˜
                }
            }
            totalStickersYounger += stickersYounger;

            // åˆ¤æ–·æ˜¯å¦ç‚ºç”Ÿæ¶¯æœ€é«˜ (ç”¨æ–¼ Highlight)
            const isMaxOlder = (currentOlderLbs === absoluteMaxOlder && absoluteMaxOlder > 0);
            const isMaxYounger = (currentYoungerLbs === absoluteMaxYounger && absoluteMaxYounger > 0);

            // å»ºç«‹ HTML è¡Œ
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${rec.date}</td>
                
                <td class="${isMaxOlder ? 'max-record-row' : ''}">
                    ${rec.olderKg} kg <br>
                    <span style="color:#666;font-size:0.85em">(${currentOlderLbs} lbs)</span>
                    ${isMaxOlder ? '<span class="max-tag">æœ€é«˜</span>' : ''}
                </td>
                
                <td>${stickersOlder > 0 ? `<span class="sticker-badge">ğŸŒŸ +${stickersOlder}</span>` : '<span style="color:#ccc">-</span>'}</td>
                
                <td class="${isMaxYounger ? 'max-record-row' : ''}">
                    ${rec.youngerKg} kg <br>
                    <span style="color:#666;font-size:0.85em">(${currentYoungerLbs} lbs)</span>
                    ${isMaxYounger ? '<span class="max-tag">æœ€é«˜</span>' : ''}
                </td>
                
                <td>${stickersYounger > 0 ? `<span class="sticker-badge">ğŸŒŸ +${stickersYounger}</span>` : '<span style="color:#ccc">-</span>'}</td>
                
                <td>
                    <button class="action-btn edit-btn" onclick="editRecord(${rec.id})">æ”¹</button>
                    <button class="action-btn del-btn" onclick="deleteRecord(${rec.id})">åˆª</button>
                </td>
            `;
            tbody.prepend(tr); // ä½¿ç”¨ prepend è®“æœ€æ–°çš„æ—¥æœŸé¡¯ç¤ºåœ¨æœ€ä¸Šé¢ (ä½†è¨ˆç®—æ˜¯å¾èˆŠåˆ°æ–°)
        });

        // 4. æ›´æ–°ç¸½çµå¡ç‰‡
        document.getElementById('totalOlder').textContent = totalStickersOlder;
        document.getElementById('totalYounger').textContent = totalStickersYounger;
        document.getElementById('currentMaxOlder').textContent = maxOlderLbs.toFixed(2);
        document.getElementById('currentMaxYounger').textContent = maxYoungerLbs.toFixed(2);
    }

    // è¼”åŠ©åŠŸèƒ½ï¼šå…¬æ–¤è½‰ç£…
    function toLbs(kg) {
        return parseFloat((kg * KG_TO_LBS).toFixed(2));
    }

    // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showError(msg) {
        const banner = document.getElementById('errorBanner');
        banner.innerHTML = msg;
        banner.style.display = 'block';
    }

    // å•Ÿå‹•
    init();

</script>

</body>
</html>
