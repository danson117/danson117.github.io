<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶åº­è—¥ç®±æ™ºèƒ½è¡¨ v8.0 (æ™ºèƒ½åŠ‘é‡ç‰ˆ)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .sort-icon { display: inline-block; vertical-align: middle; margin-left: 2px; opacity: 0.4; font-size: 0.8em; }
        .sort-active { opacity: 1; color: #2563eb; }
        th { user-select: none; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        th:hover { background-color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .cat-btn { transition: all 0.2s; }
        .cat-btn:active { transform: scale(0.95); }

        .member-tab { transition: all 0.2s; }
        .member-tab-active { background-color: #2563eb; color: white; border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .member-tab-inactive { background-color: #1e293b; color: #94a3b8; border-color: #334155; }
        .member-tab-inactive:hover { background-color: #334155; color: white; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const APP_VERSION = "v8.0";

    // --- è¼”åŠ©å‡½æ•¸ï¼šè¨ˆç®—å¹´é½¡ ---
    const calculateAge = (birthDateStr) => {
        if (!birthDateStr) return 30; // é»˜èªæˆäºº
        const birthDate = new Date(birthDateStr);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    };

    // --- è¼”åŠ©å‡½æ•¸ï¼šæ™ºèƒ½åŠ‘é‡è¨ˆç®— ---
    // é€™è£¡å®šç¾©è—¥ç‰©çš„è¨ˆç®—é‚è¼¯
    // type: 'weight' (æŒ‰é«”é‡), 'age' (æŒ‰å¹´é½¡), 'fixed' (å›ºå®š), 'adult_only' (æˆäººå°ˆç”¨)
    const calculateDynamicDose = (med, member) => {
        const age = calculateAge(member.birthDate);
        const weight = member.weight || 20;
        const isChild = age < 12;

        // å¦‚æœæ˜¯æˆäººï¼Œç›´æ¥è¿”å›æ¨™æº–åŠ‘é‡ (å¦‚æœæ•¸æ“šåº«æœ‰å€åˆ† kidDose å’Œ adultDose æ›´å¥½ï¼Œé€™è£¡æš«æ™‚å‡è¨­åŸ kidDose æ¬„ä½å­˜çš„æ˜¯å…’ç«¥åƒè€ƒï¼Œæˆ‘å€‘éœ€è¦ä¸€å€‹æ¨™æº–åŠ‘é‡æ¬„ä½ï¼Œé€™è£¡æš«æ™‚ç”¨ med.note æˆ–é»˜èªé‚è¼¯)
        // ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å‡è¨­å¦‚æœä¸æ˜¯å…’ç«¥ï¼Œé¡¯ç¤º "æˆäººæ¨™æº–" æˆ–æ‰‹å‹•è¼¸å…¥çš„æˆäººé‡ã€‚
        // *ç”±æ–¼åŸå§‹æ•¸æ“šçµæ§‹é™åˆ¶ï¼Œæˆ‘å€‘é€™è£¡åšä¸€å€‹é‚è¼¯è½‰æ›ï¼š
        // å¦‚æœæ˜¯æˆäººï¼Œæˆ‘å€‘é¡¯ç¤º "åƒç…§åŒ…è£/é†«å›‘" æˆ–è€…å¦‚æœæˆ‘å€‘æœ‰æˆäººæ•¸æ“šã€‚
        // ç‚ºäº†æ¼”ç¤ºï¼Œæˆ‘å€‘å‡è¨­æˆäººé¡¯ç¤º "æˆäººåŠ‘é‡"ã€‚
        
        if (!isChild) {
            return { text: "æˆäººæ¨™æº–é‡", isSafe: true };
        }

        if (med.kid === 'no') {
            return { text: "ä¸é©åˆå…’ç«¥", isSafe: false };
        }

        // ç‰¹æ®Šè—¥ç‰©è¨ˆç®—é‚è¼¯ (æ¨¡æ“¬)
        // Ibuprofen (Brufen): ä¸€èˆ¬ 5-10mg/kg, è—¥æ°´é€šå¸¸ 20mg/ml (100mg/5ml)
        if (med.name.includes('Brufen') && med.name.includes('è—¥æ°´')) {
            // å‡è¨­ 10mg/kg
            const doseMg = weight * 10; 
            const doseMl = (doseMg / 20).toFixed(1); // 20mg per ml
            return { text: `${doseMl}ml (10mg/kg)`, isSafe: true };
        }

        // Paracetamol (Progesic): ä¸€èˆ¬ 10-15mg/kg, è—¥æ°´é€šå¸¸ 24mg/ml (120mg/5ml) or 50mg/ml (250mg/5ml)
        // å‡è¨­ Progesic æ˜¯ 120mg/5ml (24mg/ml)
        if (med.name.includes('Progesic')) {
            const doseMg = weight * 15;
            const doseMl = (doseMg / 24).toFixed(1);
            return { text: `${doseMl}ml (15mg/kg)`, isSafe: true };
        }

        // æŠ—æ•è—¥æ°´ (Aerius/Adezio) é€šå¸¸æŒ‰å¹´é½¡æˆ–é«”é‡åˆ†ç´š
        if (med.name.includes('Aerius') || med.name.includes('Adezio')) {
            if (age < 2) return { text: "éµé†«å›‘", isSafe: true };
            if (age < 6) return { text: "2.5ml", isSafe: true };
            return { text: "5ml", isSafe: true };
        }

        // å¦‚æœæ²’æœ‰ç‰¹å®šå…¬å¼ï¼Œè¿”å›æ•¸æ“šåº«åŸæœ¬çš„ kidDose
        return { text: med.kidDose || "éµé†«å›‘", isSafe: true };
    };

    // --- åˆå§‹æ•¸æ“šåº« ---
    // ç‚ºäº†æ¼”ç¤ºåˆä½µåŠŸèƒ½ï¼Œæˆ‘ä¿ç•™äº† 'throat' é¡åˆ¥ï¼Œåªæœ‰ä¸€å€‹è—¥ç‰©ã€‚
    // å¢åŠ äº† adultDose æ¬„ä½ (æ¨¡æ“¬)
    const INITIAL_MEDICATIONS = [
        // --- æ°£ç®¡ / æ°£å–˜ ---
        { id: 32, name: 'Meptin Syrup', category: 'trachea', tags: ['æ°£å–˜', 'æ“´å¼µæ°£ç®¡'], strength: 'å°ˆç”¨', strengthVal: 4.5, rec: 'best', sleep: 'none', sideEffect: 'å¿ƒè·³/æ‰‹éœ‡', food: 'empty', price: 'med', kid: 'ok', kidDose: '5ml x 2æ¬¡', gen: 'Procaterol', note: 'è‡¨ç”¨å‰æ–å‹»' },
        { id: 26, name: 'Beclazone å™´åŠ‘', category: 'trachea', tags: ['æ°£ç®¡æ•æ„Ÿ', 'é é˜²'], strength: 'å¼·æ•ˆ', strengthVal: 4.5, rec: 'good', sleep: 'none', sideEffect: 'éµå£ç˜¡', food: 'empty', price: 'med', kid: 'caution', kidDose: '1å™´ x 2æ¬¡', gen: 'N/A', note: 'é¡å›ºé†‡ï¼Œç”¨å¾Œå¿…é ˆæ¼±å£' },
        { id: 28, name: 'Singulair 5mg', category: 'trachea', tags: ['æ°£ç®¡', 'é¼»æ•æ„Ÿ'], strength: 'ä¸­å¼·', strengthVal: 3.5, rec: 'good', sleep: 'none', sideEffect: 'æƒ…ç·’', food: 'empty', price: 'high', kid: 'ok', kidDose: '1ç²’ x 1æ¬¡', gen: 'N/A', note: 'é•·æœŸæ§åˆ¶ç”¨(é †çˆ¾å¯§)' },

        // --- æ­¢å’³ / åŒ–ç—° ---
        { id: 31, name: 'Fluimucil A 100', category: 'cough', tags: ['åŒ–ç—°', 'æ©™æ¨¹ç²‰'], strength: 'ä¸­å¼·', strengthVal: 3.5, rec: 'best', sleep: 'none', sideEffect: 'èƒƒæ°£', food: 'full', price: 'med', kid: 'ok', kidDose: '1åŒ… x 2-3æ¬¡', gen: 'N/A', note: 'éœ€æ²–æ°´é£²' },
        { id: 21, name: 'Fluifort Syrup', category: 'cough', tags: ['å¼·åŠ›åŒ–ç—°'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'è…¸èƒƒ', food: 'full', price: 'med', kid: 'ok', kidDose: '5ml x 2æ¬¡', gen: '-', note: 'é‡å°æ¿ƒç—°' },
        { id: 30, name: 'Actein é¡†ç²’', category: 'cough', tags: ['åŒ–ç—°', 'æ©™æ¨¹é¡'], strength: 'ä¸­ç­‰', strengthVal: 3, rec: 'good', sleep: 'none', sideEffect: 'èƒƒä¸é©', food: 'full', price: 'med', kid: 'ok', kidDose: 'åŠåŒ… x 2æ¬¡', gen: 'N/A', note: 'éœ€æ²–æ°´é£²' },
        { id: 11, name: 'Tussidex Forte', category: 'cough', tags: ['æ­¢å’³'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'good', sleep: 'med', sideEffect: 'é ­æšˆ', food: 'full', price: 'med', kid: 'ok', kidDose: '5ml x 3æ¬¡', gen: '-', note: 'ä¹¾å’³é©ç”¨' },

        // --- æ”¶é¼»æ°´ / æŠ—æ• ---
        { id: 2, name: 'Bendrol ç´«æ°´', category: 'nose_run', tags: ['æ”¶é¼»æ°´', 'æ•æ„Ÿ'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'neutral', sleep: 'high', sideEffect: 'å£ä¹¾', food: 'empty', price: 'low', kid: 'ok', kidDose: '5ml x 3æ¬¡', gen: '1ä»£', note: 'ç¡å‰ç”¨ä½³' },
        { id: 7, name: 'Aerius ä¸¸', category: 'nose_run', tags: ['æ”¶é¼»æ°´', 'æŠ—æ•'], strength: 'ä¸­ç­‰', strengthVal: 3, rec: 'best', sleep: 'none', sideEffect: 'æ¥µå°‘', food: 'empty', price: 'high', kid: 'caution', kidDose: 'è—¥æ°´ä½³', gen: '3ä»£', note: 'é•·æ•ˆ24å°æ™‚' },
        { id: 6, name: 'Adezio è—¥æ°´', category: 'nose_run', tags: ['æ”¶é¼»æ°´', 'æŠ—æ•'], strength: 'ä¸­ç­‰', strengthVal: 3, rec: 'good', sleep: 'low', sideEffect: 'å¾®å€¦', food: 'empty', price: 'med', kid: 'ok', kidDose: '5ml x 1æ¬¡', gen: '2ä»£', note: 'ç¡å‰é£Ÿ' },
        { id: 4, name: 'é»ƒä¸¸ (Chlor)', category: 'nose_run', tags: ['æ”¶é¼»æ°´', 'æŠ—æ•'], strength: 'æ¨™æº–', strengthVal: 2, rec: 'neutral', sleep: 'med', sideEffect: 'å£ä¹¾', food: 'empty', price: 'low', kid: 'ok', kidDose: '2.5ml x 3æ¬¡', gen: '1ä»£', note: 'å‚³çµ±æŠ—æ•' },

        // --- é€šé¼»å¡ ---
        { id: 3, name: 'Actifed é»ƒæ°´', category: 'nose_block', tags: ['é€šé¼»å¡', 'æ”¶é¼»æ°´'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'neutral', sleep: 'med', sideEffect: 'å¿ƒè·³', food: 'empty', price: 'low', kid: 'ok', kidDose: '5ml x 3æ¬¡', gen: '1ä»£', note: 'å¿ƒè‡Ÿä¸å¥½æ…ç”¨' },
        { id: 27, name: 'Avamys é¼»å™´åŠ‘', category: 'nose_block', tags: ['é¼»æ•æ„Ÿ', 'é€šé¼»'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'æµé¼»è¡€', food: 'empty', price: 'high', kid: 'ok', kidDose: '1å™´ x 1æ¬¡', gen: '2ä»£', note: 'é¡å›ºé†‡å™´åŠ‘' },

        // --- å–‰åš¨ç—› / æ¶ˆè…« (åªæœ‰ä¸€å€‹ï¼Œæœƒè¢«åˆä½µ) ---
        { id: 16, name: 'Flemizyme ä¸¸', category: 'throat', tags: ['æ¶ˆè…«', 'å–‰åš¨ç—›'], strength: 'è¼”åŠ©', strengthVal: 1, rec: 'good', sleep: 'none', sideEffect: 'æ¥µå°‘', food: 'full', price: 'low', kid: 'ok', kidDose: '1ç²’ x 3æ¬¡', gen: '-', note: 'é…µç´ é¡ï¼Œåæœ' },
        
        // --- ç™¼ç‡’ / æ­¢ç—› ---
        { id: 17, name: 'Brufen ä¸¸', category: 'fever', tags: ['æ­¢ç—›', 'é€€ç‡’'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'å‚·èƒƒ', food: 'full', price: 'low', kid: 'caution', kidDose: 'è—¥æ°´ä½³', gen: '-', note: 'å–‰åš¨ç—›/é«˜ç‡’é¦–é¸' },
        { id: 18, name: 'Brufen è—¥æ°´', category: 'fever', tags: ['æ­¢ç—›', 'é€€ç‡’'], strength: 'å¼·æ•ˆ', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'å‚·èƒƒ', food: 'full', price: 'med', kid: 'ok', kidDose: '7ml x 3æ¬¡', gen: '-', note: 'éœ€é£½è‚šæœ' },
        { id: 19, name: 'Progesic æ°´', category: 'fever', tags: ['æ­¢ç—›', 'é€€ç‡’'], strength: 'ä¸­ç­‰', strengthVal: 3, rec: 'good', sleep: 'none', sideEffect: 'å‚·è‚', food: 'empty', price: 'low', kid: 'ok', kidDose: '10ml x 4æ¬¡', gen: '-', note: 'Panadolæˆä»½' },
        { id: 20, name: 'Pabron Gold A', category: 'fever', tags: ['ç¶œåˆæ„Ÿå†’'], strength: 'ä¸­ç­‰', strengthVal: 3, rec: 'bad', sleep: 'med', sideEffect: 'ä¾è³´', food: 'full', price: 'med', kid: 'caution', kidDose: 'æŒ‰åŒ…è£', gen: '-', note: 'æˆä»½é›œï¼Œä¸å¯æ··åƒ' },

        // --- å¤–ç”¨ / å…¶ä»– ---
        { id: 22, name: 'æŠ—æ•é¼»ç‚å‡è† ', category: 'external', tags: ['é¼»æ•æ„Ÿ', 'ç‰©ç†'], strength: 'è¼”åŠ©', strengthVal: 2, rec: 'good', sleep: 'none', sideEffect: 'æ¥µå°‘', food: 'empty', price: 'med', kid: 'ok', kidDose: 'é©é‡ x 3æ¬¡', gen: '-', note: 'ç‰©ç†æ€§é˜»éš”' },
        { id: 23, name: 'Hypromellose', category: 'external', tags: ['çœ¼ä¹¾', 'æ»‹æ½¤'], strength: 'æº«å’Œ', strengthVal: 1, rec: 'good', sleep: 'none', sideEffect: 'ç„¡', food: 'empty', price: 'low', kid: 'ok', kidDose: '1æ»´ x 4æ¬¡', gen: '-', note: 'äººé€ æ·šæ°´' },
        { id: 25, name: 'LCRxx é¼»å®‰èˆ’', category: 'external', tags: ['æ´—é¼»', 'æ¸…æ½”'], strength: 'æº«å’Œ', strengthVal: 1, rec: 'good', sleep: 'none', sideEffect: 'ç„¡', food: 'empty', price: 'med', kid: 'ok', kidDose: 'é©é‡ x 2æ¬¡', gen: '-', note: 'éè—¥æ€§' },
    ];

    const STORAGE_KEY_MEMBERS = 'famBox_members_v8'; 
    const STORAGE_KEY_HIDDEN = 'famBox_hidden_v8';

    const safeGetItem = (key, defaultValue) => {
        try {
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : defaultValue;
        } catch (e) {
            return defaultValue;
        }
    };

    const safeSetItem = (key, value) => {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.warn('LocalStorage save failed');
        }
    };

    const App = () => {
        // --- State ---
        // 1. è™•ç†è—¥ç‰©åˆ†é¡åˆä½µ (Requirement 1)
        const [medications, setMedications] = useState(() => {
            // æª¢æŸ¥åˆ†é¡æ•¸é‡
            const counts = {};
            INITIAL_MEDICATIONS.forEach(m => {
                counts[m.category] = (counts[m.category] || 0) + 1;
            });
            
            return INITIAL_MEDICATIONS.map(m => {
                // å¦‚æœè©²åˆ†é¡åªæœ‰1å€‹æˆ–æ›´å°‘ï¼Œä¸”ä¸æ˜¯ 'external'ï¼Œå‰‡æ­¸å…¥ 'external'
                if (counts[m.category] <= 1 && m.category !== 'external') {
                    return { ...m, category: 'external' };
                }
                return m;
            });
        });
        
        const [hiddenIds, setHiddenIds] = useState(() => safeGetItem(STORAGE_KEY_HIDDEN, []));
        const [viewMode, setViewMode] = useState('active');
        
        // 2. æˆå“¡åå–®èˆ‡è©³ç´°è³‡æ–™ (Requirement 2)
        const [members, setMembers] = useState(() => safeGetItem(STORAGE_KEY_MEMBERS, [
            { id: 1, name: 'Alpha', birthDate: '2016-04-01', weight: 23, items: [] },
            { id: 2, name: 'Karson', birthDate: '2019-03-01', weight: 20, items: [] },
            { id: 3, name: 'Danson', birthDate: '1984-01-01', weight: 70, items: [] },
            { id: 4, name: 'Yan', birthDate: '1992-08-01', weight: 50, items: [] }
        ]));

        const [activeMemberId, setActiveMemberId] = useState(members[0]?.id || 1);
        
        // ç·¨è¼¯æˆå“¡ç‹€æ…‹
        const [editingMember, setEditingMember] = useState(null); // { id, name, weight, birthDate }

        const [searchTerm, setSearchTerm] = useState('');
        const [selectedCategory, setSelectedCategory] = useState('all');
        const [filterNoSleep, setFilterNoSleep] = useState(false);
        const [filterKidSafe, setFilterKidSafe] = useState(false);

        const [sortConfig, setSortConfig] = useState({ key: 'strengthVal', direction: 'desc' });

        // --- Persistence ---
        useEffect(() => { safeSetItem(STORAGE_KEY_MEMBERS, members); }, [members]);
        useEffect(() => { safeSetItem(STORAGE_KEY_HIDDEN, hiddenIds); }, [hiddenIds]);

        const activeMember = members.find(m => m.id === activeMemberId) || members[0];
        const activeAge = calculateAge(activeMember.birthDate);
        const isChildActive = activeAge < 12;

        // --- Logic ---
        const filteredData = useMemo(() => {
            let data = medications.filter(med => {
                if (viewMode === 'active' && hiddenIds.includes(med.id)) return false;
                if (viewMode === 'deleted' && !hiddenIds.includes(med.id)) return false;

                const matchesSearch = med.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                      med.note.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      med.tags.some(t => t.includes(searchTerm));
                if (!matchesSearch) return false;

                if (selectedCategory !== 'all') {
                    if (selectedCategory === 'nose_all') {
                        if (!['nose_run', 'nose_block'].includes(med.category)) return false;
                    } else {
                        if (med.category !== selectedCategory) return false;
                    }
                }

                if (filterNoSleep && med.sleep !== 'none') return false;
                if (filterKidSafe && med.kid === 'no') return false;

                return true;
            });

            data.sort((a, b) => {
                let aValue = a[sortConfig.key];
                let bValue = b[sortConfig.key];

                if (sortConfig.key === 'rec') {
                    const score = { 'best': 3, 'good': 2, 'neutral': 1, 'bad': 0 };
                    aValue = score[a.rec] || 0; 
                    bValue = score[b.rec] || 0;
                }
                if (sortConfig.key === 'sleep') {
                    const score = { 'none': 0, 'low': 1, 'med': 2, 'high': 3 };
                    aValue = score[a.sleep] || 0;
                    bValue = score[b.sleep] || 0;
                }
                if (sortConfig.key === 'kid') {
                    const score = { 'ok': 2, 'caution': 1, 'no': 0 };
                    aValue = score[a.kid] || 0;
                    bValue = score[b.kid] || 0;
                }

                if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
            return data;
        }, [medications, hiddenIds, viewMode, searchTerm, selectedCategory, sortConfig, filterNoSleep, filterKidSafe]);

        // --- Actions ---
        const createMember = () => {
            const newId = Date.now();
            const newMembers = [...members, { id: newId, name: `æˆå“¡`, birthDate: '2000-01-01', weight: 50, items: [] }];
            setMembers(newMembers);
            setActiveMemberId(newId);
            setEditingMember({ ...newMembers[newMembers.length-1] }); // Immediately edit
        };

        const deleteMember = (id, e) => {
            e.stopPropagation();
            if (members.length <= 1) { alert("æœ€å°‘ä¿ç•™ä¸€å€‹æˆå“¡åå–®"); return; }
            if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æˆå“¡çš„åå–®å—ï¼Ÿ")) return;
            const newMembers = members.filter(m => m.id !== id);
            setMembers(newMembers);
            if (activeMemberId === id) setActiveMemberId(newMembers[0].id);
        };

        const saveMemberEdit = () => {
            setMembers(members.map(m => m.id === editingMember.id ? editingMember : m));
            setEditingMember(null);
        };

        const toggleItemInMember = (medId) => {
            setMembers(members.map(member => {
                if (member.id === activeMemberId) {
                    const exists = member.items.includes(medId);
                    return {
                        ...member,
                        items: exists ? member.items.filter(id => id !== medId) : [...member.items, medId]
                    };
                }
                return member;
            }));
        };

        const softDelete = (id) => setHiddenIds([...hiddenIds, id]);
        const restore = (id) => setHiddenIds(hiddenIds.filter(hid => hid !== id));
        const handleSort = (key) => setSortConfig(current => ({ key, direction: current.key === key && current.direction === 'desc' ? 'asc' : 'desc' }));
        
        const getSortIcon = (key) => {
            if (sortConfig.key !== key) return <i className="ph ph-arrows-down-up sort-icon"></i>;
            return sortConfig.direction === 'asc' 
                ? <i className="ph ph-arrow-up sort-icon sort-active"></i> 
                : <i className="ph ph-arrow-down sort-icon sort-active"></i>;
        };

        const getGoogleImageLink = (name) => `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name + ' medicine packaging')}`;

        // --- Filter Buttons Configuration ---
        // Dynamically hide categories that don't exist anymore (merged into external)
        const activeCategories = new Set(medications.map(m => m.category));
        
        const allFilters = [
            { id: 'nose_run', label: 'æ”¶é¼»æ°´/æŠ—æ•', icon: 'ph-drop', color: 'blue' },
            { id: 'nose_block', label: 'é€šé¼»å¡', icon: 'ph-wind', color: 'sky' },
            { id: 'cough', label: 'æ­¢å’³/åŒ–ç—°', icon: 'ph-cloud-rain', color: 'teal' },
            { id: 'trachea', label: 'æ°£ç®¡/æ°£å–˜', icon: 'ph-lungs', color: 'cyan' },
            { id: 'throat', label: 'å–‰åš¨ç—›/æ¶ˆè…«', icon: 'ph-microphone-slash', color: 'indigo' },
            { id: 'fever', label: 'ç™¼ç‡’/æ­¢ç—›', icon: 'ph-thermometer', color: 'red' },
            { id: 'external', label: 'å¤–ç”¨/å…¶ä»–', icon: 'ph-bandaids', color: 'amber' },
        ];
        
        const filters = allFilters.filter(f => activeCategories.has(f.id));

        return (
            <div className="w-full max-w-[1400px] mx-auto bg-white shadow-2xl min-h-screen flex flex-col relative">
                
                {/* 1. é ‚éƒ¨å°èˆªèˆ‡æˆå“¡ç®¡ç†å™¨ */}
                <div className="bg-slate-900 text-white p-4 sticky top-0 z-30 shadow-lg">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div>
                            <h1 className="text-2xl font-bold flex items-center gap-2 text-blue-400">
                                <i className="ph ph-first-aid-kit text-3xl"></i> å®¶åº­è—¥ç®±æ™ºèƒ½è¡¨
                            </h1>
                        </div>
                        
                        <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                            <button onClick={() => setViewMode('active')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'active' ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>
                                è—¥ç‰©åº«
                            </button>
                            <button onClick={() => setViewMode('deleted')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-1 ${viewMode === 'deleted' ? 'bg-red-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>
                                <i className="ph ph-trash"></i> å·²ç§»é™¤ ({hiddenIds.length})
                            </button>
                        </div>
                    </div>

                    {/* æˆå“¡ Tabs (Requirement 5) */}
                    <div className="flex flex-wrap items-end gap-2 mb-0">
                        {members.map(m => (
                            <div key={m.id} 
                                onClick={() => setActiveMemberId(m.id)}
                                className={`member-tab cursor-pointer px-4 py-2 rounded-t-lg border-t border-x flex items-center gap-2 relative group ${activeMemberId === m.id ? 'member-tab-active z-10' : 'member-tab-inactive z-0'}`}>
                                <span className="font-bold">{m.name}</span>
                                {activeMemberId === m.id && (
                                    <button onClick={(e) => { e.stopPropagation(); setEditingMember({...m}); }} className="text-blue-200 hover:text-white ml-1">
                                        <i className="ph ph-pencil-simple"></i>
                                    </button>
                                )}
                                {/* åˆªé™¤æŒ‰éˆ• (Hoveræ™‚é¡¯ç¤º) */}
                                <button onClick={(e) => deleteMember(m.id, e)} className="opacity-0 group-hover:opacity-100 hover:text-red-400 transition-opacity ml-1">
                                    <i className="ph ph-x-circle"></i>
                                </button>
                            </div>
                        ))}
                        <button onClick={createMember} className="px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-t-lg transition-colors">
                            <i className="ph ph-plus text-lg"></i>
                        </button>
                    </div>

                    {/* ç•¶å‰æˆå“¡è³‡è¨Šé¢æ¿ (é¡¯ç¤ºå¹´é½¡é«”é‡) */}
                    <div className="bg-blue-600 text-white p-3 rounded-b-lg rounded-tr-lg shadow-inner flex flex-wrap gap-4 items-center justify-between -mt-[1px] z-20 relative border-t border-blue-500">
                        <div className="flex items-center gap-4 text-sm">
                            <div className="flex items-center gap-1 bg-blue-700/50 px-2 py-1 rounded">
                                <i className="ph ph-cake"></i>
                                <span>{activeAge} æ­²</span>
                            </div>
                            <div className="flex items-center gap-1 bg-blue-700/50 px-2 py-1 rounded">
                                <i className="ph ph-scales"></i>
                                <span>{activeMember.weight} kg</span>
                            </div>
                            <div className="flex items-center gap-1 bg-blue-700/50 px-2 py-1 rounded">
                                <i className="ph ph-pill"></i>
                                <span>å·²é¸: {activeMember.items.length}</span>
                            </div>
                        </div>
                        
                        {/* ç·¨è¼¯ Modal */}
                        {editingMember && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white text-slate-900 p-6 rounded-xl shadow-2xl w-full max-w-sm animate-fade-in">
                                    <h3 className="text-lg font-bold mb-4">ç·¨è¼¯æˆå“¡è³‡æ–™</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">åç¨±</label>
                                            <input type="text" value={editingMember.name} onChange={e => setEditingMember({...editingMember, name: e.target.value})} className="w-full border p-2 rounded" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">å‡ºç”Ÿæ—¥æœŸ</label>
                                            <input type="date" value={editingMember.birthDate} onChange={e => setEditingMember({...editingMember, birthDate: e.target.value})} className="w-full border p-2 rounded" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">é«”é‡ (kg)</label>
                                            <input type="number" value={editingMember.weight} onChange={e => setEditingMember({...editingMember, weight: Number(e.target.value)})} className="w-full border p-2 rounded" />
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mt-6 justify-end">
                                        <button onClick={() => setEditingMember(null)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">å–æ¶ˆ</button>
                                        <button onClick={saveMemberEdit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">å„²å­˜</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeMember.items.length > 0 && (
                            <div className="flex flex-wrap gap-2">
                                {activeMember.items.map(itemId => {
                                    const item = medications.find(m => m.id === itemId);
                                    if (!item) return null;
                                    const isDeleted = hiddenIds.includes(itemId);
                                    return (
                                        <span key={itemId} className={`text-xs px-2 py-1 rounded flex items-center gap-1 border shadow-sm ${
                                            isDeleted ? 'bg-red-100 border-red-200 text-red-800' : 'bg-white text-blue-800 border-blue-200'
                                        }`}>
                                            {item.name}
                                            <button onClick={() => toggleItemInMember(itemId)} className="hover:text-red-500 ml-1"><i className="ph ph-x"></i></button>
                                        </span>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>

                {/* 2. ç¯©é¸å·¥å…·åˆ— */}
                <div className="p-4 bg-white border-b border-gray-200 space-y-4">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        <div className="relative flex-1">
                            <i className="ph ph-magnifying-glass absolute left-3 top-2.5 text-gray-400"></i>
                            <input type="text" placeholder="æœå°‹è—¥åã€åŠŸæ•ˆ..."
                                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                                value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setFilterNoSleep(!filterNoSleep)}
                                className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border transition-all ${filterNoSleep ? 'bg-green-100 border-green-300 text-green-800' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                <i className={`ph ${filterNoSleep ? 'ph-check-square' : 'ph-square'}`}></i> ğŸŸ¢ ç„¡ç¡æ„
                            </button>
                            <button onClick={() => setFilterKidSafe(!filterKidSafe)}
                                className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border transition-all ${filterKidSafe ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                <i className={`ph ${filterKidSafe ? 'ph-check-square' : 'ph-square'}`}></i> ğŸ‘¶ å°ç«¥é©ç”¨
                            </button>
                        </div>
                    </div>

                    <div className="flex flex-wrap gap-2">
                        <button onClick={() => setSelectedCategory('all')} 
                            className={`cat-btn px-3 py-1.5 rounded-full text-xs font-medium border ${selectedCategory === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`}>
                            å…¨éƒ¨
                        </button>
                        {filters.map(cat => (
                            <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} 
                                className={`cat-btn px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 border ${selectedCategory === cat.id ? `bg-${cat.color}-600 text-white border-${cat.color}-600` : `bg-white text-gray-600 hover:bg-${cat.color}-50`}`}>
                                <i className={`ph ${cat.icon}`}></i> {cat.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* 3. ä¸»è¡¨æ ¼ */}
                <div className="flex-1 overflow-x-auto bg-gray-50 pb-8">
                    <table className="w-full text-left border-collapse min-w-[1100px]">
                        <thead className="bg-gray-200 text-gray-700 uppercase text-xs sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th className="p-3 w-14 text-center">åœ–ç‰‡</th>
                                <th className="p-3 w-10 text-center">é¸å–</th>
                                <th className="p-3 w-[14%]" onClick={() => handleSort('name')}>è—¥å / æ¨™ç±¤ {getSortIcon('name')}</th>
                                <th className="p-3 w-16" onClick={() => handleSort('rec')}>æ¨è–¦ {getSortIcon('rec')}</th>
                                <th className="p-3 w-16" onClick={() => handleSort('strengthVal')}>å¼·åº¦ {getSortIcon('strengthVal')}</th>
                                <th className="p-3 w-20" onClick={() => handleSort('sleep')}>ç¡æ„ {getSortIcon('sleep')}</th>
                                <th className="p-3 w-16" onClick={() => handleSort('food')}>é£½è‚š {getSortIcon('food')}</th>
                                <th className="p-3 w-28" onClick={() => handleSort('kid')}>
                                    {isChildActive ? `å»ºè­°åŠ‘é‡ (${activeMember.weight}kg)` : 'å…’ç«¥é©ç”¨'} {getSortIcon('kid')}
                                </th>
                                <th className="p-3 w-auto" onClick={() => handleSort('note')}>å‚™è¨» / å‰¯ä½œç”¨ {getSortIcon('note')}</th>
                                <th className="p-3 w-12 text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200 text-sm bg-white">
                            {filteredData.map(med => {
                                const isInList = activeMember.items.includes(med.id);
                                
                                // Dynamic Dose Calculation
                                const doseInfo = calculateDynamicDose(med, activeMember);
                                
                                // Highlight Row Logic (Requirement 2)
                                const isHighlighted = isChildActive && med.kid === 'ok';
                                
                                return (
                                    <tr key={med.id} className={`transition-colors ${
                                        isInList ? 'bg-blue-100/70' : 
                                        isHighlighted ? 'bg-green-50 hover:bg-green-100' : 
                                        'hover:bg-gray-50'
                                    }`}>
                                        <td className="p-2 text-center">
                                            <a href={getGoogleImageLink(med.name)} target="_blank" className="block w-10 h-10 bg-gray-100 rounded flex items-center justify-center mx-auto hover:bg-blue-100 hover:text-blue-600 border border-gray-200 text-gray-400">
                                                <i className="ph ph-image text-xl"></i>
                                            </a>
                                        </td>
                                        <td className="p-2 text-center">
                                            {viewMode === 'active' && (
                                                <button onClick={() => toggleItemInMember(med.id)} 
                                                    className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${isInList ? 'bg-blue-600 text-white shadow-md scale-110' : 'bg-gray-100 text-gray-400 hover:bg-blue-200 hover:text-blue-600'}`}>
                                                    {isInList ? <i className="ph ph-check text-lg"></i> : <i className="ph ph-plus text-lg"></i>}
                                                </button>
                                            )}
                                        </td>
                                        <td className="p-3">
                                            <div className="font-bold text-gray-800 text-base leading-tight">{med.name}</div>
                                            <div className="flex flex-wrap gap-1 mt-1">
                                                {med.tags.map((tag, i) => (
                                                    <span key={i} className={`text-[10px] px-1.5 py-0.5 rounded border ${
                                                        tag.includes('é€€ç‡’') ? 'bg-red-50 text-red-700 border-red-100' :
                                                        tag.includes('æ­¢ç—›') ? 'bg-orange-50 text-orange-700 border-orange-100' :
                                                        tag.includes('æ°£ç®¡') ? 'bg-cyan-50 text-cyan-700 border-cyan-100' :
                                                        'bg-gray-100 text-gray-600 border-gray-200'
                                                    }`}>{tag}</span>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-center">
                                            {med.rec === 'best' ? <i className="ph ph-thumbs-up text-green-600 text-xl"></i> :
                                             med.rec === 'bad' ? <i className="ph ph-thumbs-down text-red-500 text-xl"></i> : 
                                             <span className="text-gray-300">-</span>}
                                        </td>
                                        <td className={`p-3 font-medium ${med.strengthVal >= 4 ? 'text-red-600' : 'text-gray-700'}`}>{med.strength}</td>
                                        <td className="p-3">
                                            {med.sleep === 'high' ? <span className="text-red-600 font-bold text-xs">æ¥µçœ¼ç“</span> :
                                             med.sleep === 'med' ? <span className="text-orange-500 font-bold text-xs">æœ‰ç¡æ„</span> :
                                             med.sleep === 'low' ? <span className="text-yellow-600 font-bold text-xs">å¾®ç¡æ„</span> :
                                             <span className="text-green-600 font-bold text-xs">ç„¡</span>}
                                        </td>
                                        <td className="p-3 text-xs">
                                            {med.food === 'full' ? <span className="text-blue-600 font-bold">é£½è‚š</span> : <span className="text-gray-400">å¯ç©º</span>}
                                        </td>
                                        <td className="p-3">
                                            {/* æ™ºèƒ½åŠ‘é‡é¡¯ç¤ºå€åŸŸ (Requirement 2) */}
                                            {isChildActive ? (
                                                med.kid === 'no' ? (
                                                    <span className="text-red-500 text-xs font-bold">ä¸å¯</span>
                                                ) : (
                                                    <div className={`flex flex-col p-1 rounded ${med.kid === 'ok' ? 'bg-green-100/80 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                                                        <span className={`text-xs font-bold ${med.kid === 'ok' ? 'text-green-700' : 'text-yellow-700'}`}>
                                                            {doseInfo.text}
                                                        </span>
                                                        {med.kid === 'caution' && <span className="text-[10px] text-yellow-600">æ…ç”¨</span>}
                                                    </div>
                                                )
                                            ) : (
                                                // æˆäººè¦–è§’
                                                med.kid === 'no' ? <span className="text-red-500 text-xs font-bold">å°ç«¥ä¸å¯</span> : (
                                                <div className="flex flex-col">
                                                    <span className={`text-xs font-bold ${med.kid === 'ok' ? 'text-green-600' : 'text-yellow-600'}`}>
                                                        {med.kid === 'ok' ? 'OK' : 'æ…ç”¨'}
                                                    </span>
                                                </div>
                                                )
                                            )}
                                        </td>
                                        <td className="p-3 text-xs">
                                            <div className="text-gray-800">{med.note}</div>
                                            {med.sideEffect !== 'ç„¡' && med.sideEffect !== 'æ¥µå°‘' && med.sideEffect !== 'æœªçŸ¥' && <div className="text-red-500 mt-0.5">âš  {med.sideEffect}</div>}
                                        </td>
                                        <td className="p-3 text-center">
                                            {viewMode === 'active' ? (
                                                <button onClick={() => softDelete(med.id)} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded transition-colors" title="ç§»é™¤">
                                                    <i className="ph ph-trash text-lg"></i>
                                                </button>
                                            ) : (
                                                <button onClick={() => restore(med.id)} className="text-green-500 hover:text-green-700 hover:bg-green-50 p-2 rounded transition-colors mx-auto" title="é‚„åŸ">
                                                    <i className="ph ph-arrow-counter-clockwise text-lg"></i>
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    {filteredData.length === 0 && (
                        <div className="p-12 text-center text-gray-400 flex flex-col items-center">
                            <i className="ph ph-ghost text-4xl mb-2"></i>
                            <p>{viewMode === 'active' ? 'æ²’æœ‰æ‰¾åˆ°ç›¸é—œè—¥ç‰©' : 'å›æ”¶ç­’æ˜¯ç©ºçš„'}</p>
                        </div>
                    )}
                </div>
                
                {/* 4. ç‰ˆæœ¬è™Ÿ (Requirement 4) */}
                <div className="absolute bottom-1 right-2 text-[10px] text-slate-300 pointer-events-none z-0">
                    {APP_VERSION}
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);

    /* 
     * VERSION CONTROL LOG:
     * v1.0 - Initial Release
     * ...
     * v7.0 - Refined Categories, Member List Persistence
     * v8.0 - (Current) 
     *      - Added dynamic age/weight calculation.
     *      - Added 'calculateDynamicDose' function for weight-based dosing (Brufen, Progesic).
     *      - Implemented automatic category merging (Throat -> External if count <= 1).
     *      - Changed member selection to Tabs.
     *      - Added visual highlighting for child-safe meds when child profile is active.
     *      - Added version label in UI.
     */
</script>

</body>
</html>
