<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ∂Â∫≠Ëó•ÁÆ±Êô∫ËÉΩË°® v8.2 (Adult Dose Update)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .sort-icon { display: inline-block; vertical-align: middle; margin-left: 2px; opacity: 0.4; font-size: 0.8em; }
        .sort-active { opacity: 1; color: #2563eb; }
        th { user-select: none; cursor: pointer; transition: background-color 0.2s; white-space: nowrap; }
        th:hover { background-color: #e2e8f0; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .cat-btn { transition: all 0.2s; }
        .cat-btn:active { transform: scale(0.95); }

        .member-tab { transition: all 0.2s; }
        .member-tab-active { background-color: #2563eb; color: white; border-color: #2563eb; transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .member-tab-inactive { background-color: #1e293b; color: #94a3b8; border-color: #334155; }
        .member-tab-inactive:hover { background-color: #334155; color: white; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel">
    const { useState, useMemo, useEffect } = React;

    const APP_VERSION = "v8.2";

    // --- ËºîÂä©ÂáΩÊï∏ÔºöË®àÁÆóÂπ¥ÈΩ° ---
    const calculateAge = (birthDateStr) => {
        if (!birthDateStr) return 30; // ÈªòË™çÊàê‰∫∫
        const birthDate = new Date(birthDateStr);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const m = today.getMonth() - birthDate.getMonth();
        if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        return age;
    };

    // --- ËºîÂä©ÂáΩÊï∏ÔºöÊô∫ËÉΩÂäëÈáèË®àÁÆó ---
    const calculateDynamicDose = (med, member) => {
        const age = calculateAge(member.birthDate);
        const weight = member.weight || 20;
        const isChild = age < 12;

        // --- Êàê‰∫∫ÈÇèËºØ (Êñ∞Â¢û) ---
        if (!isChild) {
            // Áõ¥Êé•ËÆÄÂèñÊï∏ÊìöÂ∫´‰∏≠ÁöÑ adultDose Â≠óÊÆµ
            return { text: med.adultDose || "ÈÅµÈÜ´Âõë", isSafe: true };
        }

        // --- ÂÖíÁ´•ÈÇèËºØ ---
        if (med.kid === 'no') {
            return { text: "‰∏çÈÅ©ÂêàÂÖíÁ´•", isSafe: false };
        }

        // 1. Bronal Syrup (Ê†πÊìöÂúñÁâáÊâãÂØ´Ê®ôÁ±§)
        // Ê®ôÁ±§ÂØ´: 20-30kg (5ml)
        if (med.name.includes('Bronal')) {
            if (weight < 20) return { text: "2.5ml (‰º∞ÁÆó)", isSafe: true }; // ËºïÈÅé20kgÊ∏õÂçä
            if (weight <= 30) return { text: "5ml", isSafe: true }; // ÂúñÁâáÊåáÂÆöÁØÑÂúç
            return { text: "7.5ml", isSafe: true }; // Ë∂ÖÈÅé30kg
        }

        // 2. Ibuprofen (Brufen)
        if (med.name.includes('Brufen') && med.name.includes('Ëó•Ê∞¥')) {
            const doseMg = weight * 10; 
            const doseMl = (doseMg / 20).toFixed(1); // 20mg per ml
            return { text: `${doseMl}ml (10mg/kg)`, isSafe: true };
        }

        // 3. Paracetamol (Progesic)
        if (med.name.includes('Progesic')) {
            const doseMg = weight * 15;
            const doseMl = (doseMg / 24).toFixed(1);
            return { text: `${doseMl}ml (15mg/kg)`, isSafe: true };
        }

        // 4. ÊäóÊïèËó•Ê∞¥
        if (med.name.includes('Aerius') || med.name.includes('Adezio')) {
            if (age < 2) return { text: "ÈÅµÈÜ´Âõë", isSafe: true };
            if (age < 6) return { text: "2.5ml", isSafe: true };
            return { text: "5ml", isSafe: true };
        }

        // ÈªòË™çËøîÂõûÊï∏ÊìöÂ∫´ÂéüÊú¨ÁöÑ kidDose
        return { text: med.kidDose || "ÈÅµÈÜ´Âõë", isSafe: true };
    };

    // --- ÂàùÂßãÊï∏ÊìöÂ∫´ (Â∑≤Âä†ÂÖ• adultDose) ---
    const INITIAL_MEDICATIONS = [
        // --- Ê∞£ÁÆ° / Ê∞£Âñò ---
        { id: 32, name: 'Meptin Syrup', category: 'trachea', tags: ['Ê∞£Âñò', 'Êì¥ÂºµÊ∞£ÁÆ°'], strength: 'Â∞àÁî®', strengthVal: 4.5, rec: 'best', sleep: 'none', sideEffect: 'ÂøÉË∑≥/ÊâãÈúá', food: 'empty', price: 'med', kid: 'ok', kidDose: '5ml x 2Ê¨°', adultDose: '10ml x 2Ê¨°', gen: 'Procaterol', note: 'Ëá®Áî®ÂâçÊêñÂãª' },
        { id: 26, name: 'Beclazone Âô¥Âäë', category: 'trachea', tags: ['Ê∞£ÁÆ°ÊïèÊÑü', 'È†êÈò≤'], strength: 'Âº∑Êïà', strengthVal: 4.5, rec: 'good', sleep: 'none', sideEffect: 'ÈµùÂè£Áò°', food: 'empty', price: 'med', kid: 'caution', kidDose: '1Âô¥ x 2Ê¨°', adultDose: '2Âô¥ x 2Ê¨°', gen: 'N/A', note: 'È°ûÂõ∫ÈÜáÔºåÁî®ÂæåÂøÖÈ†àÊº±Âè£' },
        { id: 28, name: 'Singulair 5mg', category: 'trachea', tags: ['Ê∞£ÁÆ°', 'ÈºªÊïèÊÑü'], strength: '‰∏≠Âº∑', strengthVal: 3.5, rec: 'good', sleep: 'none', sideEffect: 'ÊÉÖÁ∑í', food: 'empty', price: 'high', kid: 'ok', kidDose: '1Á≤í x 1Ê¨°', adultDose: '2Á≤í(10mg) x 1Ê¨°', gen: 'N/A', note: 'Èï∑ÊúüÊéßÂà∂Áî®(È†ÜÁàæÂØß)' },

        // --- Ê≠¢Âí≥ / ÂåñÁó∞ ---
        { id: 33, name: 'Bronal Syrup', category: 'cough', tags: ['Ê≠¢Âí≥', '‰πæÂí≥'], strength: '‰∏≠Á≠â', strengthVal: 3, rec: 'good', sleep: 'none', sideEffect: 'Ê•µÂ∞ë', food: 'empty', price: 'med', kid: 'ok', kidDose: '5ml (20-30kg)', adultDose: '10ml x 3Ê¨°', gen: 'Levodropropizine', note: 'ÈùûÈ∫ªÈÜâÊÄßÔºåÈáùÂ∞ç‰πæÂí≥' },
        { id: 31, name: 'Fluimucil A 100', category: 'cough', tags: ['ÂåñÁó∞', 'Ê©ôÊ®πÁ≤â'], strength: '‰∏≠Âº∑', strengthVal: 3.5, rec: 'best', sleep: 'none', sideEffect: 'ËÉÉÊ∞£', food: 'full', price: 'med', kid: 'ok', kidDose: '1ÂåÖ x 2-3Ê¨°', adultDose: '2ÂåÖ x 3Ê¨°', gen: 'N/A', note: 'ÈúÄÊ≤ñÊ∞¥È£≤' },
        { id: 21, name: 'Fluifort Syrup', category: 'cough', tags: ['Âº∑ÂäõÂåñÁó∞'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'ËÖ∏ËÉÉ', food: 'full', price: 'med', kid: 'ok', kidDose: '5ml x 2Ê¨°', adultDose: '10ml x 2Ê¨°', gen: '-', note: 'ÈáùÂ∞çÊøÉÁó∞' },
        { id: 30, name: 'Actein È°ÜÁ≤í', category: 'cough', tags: ['ÂåñÁó∞', 'Ê©ôÊ®πÈ°û'], strength: '‰∏≠Á≠â', strengthVal: 3, rec: 'good', sleep: 'none', sideEffect: 'ËÉÉ‰∏çÈÅ©', food: 'full', price: 'med', kid: 'ok', kidDose: 'ÂçäÂåÖ x 2Ê¨°', adultDose: '1ÂåÖ x 2Ê¨°', gen: 'N/A', note: 'ÈúÄÊ≤ñÊ∞¥È£≤' },
        { id: 11, name: 'Tussidex Forte', category: 'cough', tags: ['Ê≠¢Âí≥'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'good', sleep: 'med', sideEffect: 'È†≠Êöà', food: 'full', price: 'med', kid: 'ok', kidDose: '5ml x 3Ê¨°', adultDose: '10ml x 3Ê¨°', gen: '-', note: '‰πæÂí≥ÈÅ©Áî®' },

        // --- Êî∂ÈºªÊ∞¥ / ÊäóÊïè ---
        { id: 2, name: 'Bendrol Á¥´Ê∞¥', category: 'nose_run', tags: ['Êî∂ÈºªÊ∞¥', 'ÊïèÊÑü'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'neutral', sleep: 'high', sideEffect: 'Âè£‰πæ', food: 'empty', price: 'low', kid: 'ok', kidDose: '5ml x 3Ê¨°', adultDose: '10ml x 3Ê¨°', gen: '1‰ª£', note: 'Áù°ÂâçÁî®‰Ω≥' },
        { id: 7, name: 'Aerius ‰∏∏', category: 'nose_run', tags: ['Êî∂ÈºªÊ∞¥', 'ÊäóÊïè'], strength: '‰∏≠Á≠â', strengthVal: 3, rec: 'best', sleep: 'none', sideEffect: 'Ê•µÂ∞ë', food: 'empty', price: 'high', kid: 'caution', kidDose: 'Ëó•Ê∞¥‰Ω≥', adultDose: '1Á≤í x 1Ê¨°', gen: '3‰ª£', note: 'Èï∑Êïà24Â∞èÊôÇ' },
        { id: 6, name: 'Adezio Ëó•Ê∞¥', category: 'nose_run', tags: ['Êî∂ÈºªÊ∞¥', 'ÊäóÊïè'], strength: '‰∏≠Á≠â', strengthVal: 3, rec: 'good', sleep: 'low', sideEffect: 'ÂæÆÂÄ¶', food: 'empty', price: 'med', kid: 'ok', kidDose: '5ml x 1Ê¨°', adultDose: '10ml x 1Ê¨°', gen: '2‰ª£', note: 'Áù°ÂâçÈ£ü' },
        { id: 4, name: 'ÈªÉ‰∏∏ (Chlor)', category: 'nose_run', tags: ['Êî∂ÈºªÊ∞¥', 'ÊäóÊïè'], strength: 'Ê®ôÊ∫ñ', strengthVal: 2, rec: 'neutral', sleep: 'med', sideEffect: 'Âè£‰πæ', food: 'empty', price: 'low', kid: 'ok', kidDose: '2.5ml x 3Ê¨°', adultDose: '1Á≤í(4mg) x 3Ê¨°', gen: '1‰ª£', note: 'ÂÇ≥Áµ±ÊäóÊïè' },

        // --- ÈÄöÈºªÂ°û ---
        { id: 3, name: 'Actifed ÈªÉÊ∞¥', category: 'nose_block', tags: ['ÈÄöÈºªÂ°û', 'Êî∂ÈºªÊ∞¥'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'neutral', sleep: 'med', sideEffect: 'ÂøÉË∑≥', food: 'empty', price: 'low', kid: 'ok', kidDose: '5ml x 3Ê¨°', adultDose: '10ml x 3Ê¨°', gen: '1‰ª£', note: 'ÂøÉËáü‰∏çÂ•ΩÊÖéÁî®' },
        { id: 27, name: 'Avamys ÈºªÂô¥Âäë', category: 'nose_block', tags: ['ÈºªÊïèÊÑü', 'ÈÄöÈºª'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'ÊµÅÈºªË°Ä', food: 'empty', price: 'high', kid: 'ok', kidDose: '1Âô¥ x 1Ê¨°', adultDose: '2Âô¥ x 1Ê¨°', gen: '2‰ª£', note: 'È°ûÂõ∫ÈÜáÂô¥Âäë' },

        // --- ÂñâÂö®Áóõ / Ê∂àËÖ´ ---
        { id: 16, name: 'Flemizyme ‰∏∏', category: 'throat', tags: ['Ê∂àËÖ´', 'ÂñâÂö®Áóõ'], strength: 'ËºîÂä©', strengthVal: 1, rec: 'good', sleep: 'none', sideEffect: 'Ê•µÂ∞ë', food: 'full', price: 'low', kid: 'ok', kidDose: '1Á≤í x 3Ê¨°', adultDose: '2Á≤í x 3Ê¨°', gen: '-', note: 'ÈÖµÁ¥†È°ûÔºåÂêûÊúç' },
        
        // --- ÁôºÁáí / Ê≠¢Áóõ ---
        { id: 17, name: 'Brufen ‰∏∏', category: 'fever', tags: ['Ê≠¢Áóõ', 'ÈÄÄÁáí'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'ÂÇ∑ËÉÉ', food: 'full', price: 'low', kid: 'caution', kidDose: 'Ëó•Ê∞¥‰Ω≥', adultDose: '1-2Á≤í x 3Ê¨°', gen: '-', note: 'ÂñâÂö®Áóõ/È´òÁáíÈ¶ñÈÅ∏' },
        { id: 18, name: 'Brufen Ëó•Ê∞¥', category: 'fever', tags: ['Ê≠¢Áóõ', 'ÈÄÄÁáí'], strength: 'Âº∑Êïà', strengthVal: 4, rec: 'best', sleep: 'none', sideEffect: 'ÂÇ∑ËÉÉ', food: 'full', price: 'med', kid: 'ok', kidDose: '7ml x 3Ê¨°', adultDose: '15-20ml x 3Ê¨°', gen: '-', note: 'ÈúÄÈ£ΩËÇöÊúç' },
        { id: 19, name: 'Progesic Ê∞¥', category: 'fever', tags: ['Ê≠¢Áóõ', 'ÈÄÄÁáí'], strength: '‰∏≠Á≠â', strengthVal: 3, rec: 'good', sleep: 'none', sideEffect: 'ÂÇ∑ËÇù', food: 'empty', price: 'low', kid: 'ok', kidDose: '10ml x 4Ê¨°', adultDose: '20ml x 4Ê¨°', gen: '-', note: 'PanadolÊàê‰ªΩ' },
        { id: 20, name: 'Pabron Gold A', category: 'fever', tags: ['Á∂úÂêàÊÑüÂÜí'], strength: '‰∏≠Á≠â', strengthVal: 3, rec: 'bad', sleep: 'med', sideEffect: '‰æùË≥¥', food: 'full', price: 'med', kid: 'caution', kidDose: 'ÊåâÂåÖË£ù', adultDose: '3Á≤í/1ÂåÖ x 3Ê¨°', gen: '-', note: 'Êàê‰ªΩÈõúÔºå‰∏çÂèØÊ∑∑ÂêÉ' },

        // --- Â§ñÁî® / ÂÖ∂‰ªñ ---
        { id: 22, name: 'ÊäóÊïèÈºªÁÇéÂáùËÜ†', category: 'external', tags: ['ÈºªÊïèÊÑü', 'Áâ©ÁêÜ'], strength: 'ËºîÂä©', strengthVal: 2, rec: 'good', sleep: 'none', sideEffect: 'Ê•µÂ∞ë', food: 'empty', price: 'med', kid: 'ok', kidDose: 'ÈÅ©Èáè x 3Ê¨°', adultDose: 'ÈÅ©Èáè x 3Ê¨°', gen: '-', note: 'Áâ©ÁêÜÊÄßÈòªÈöî' },
        { id: 23, name: 'Hypromellose', category: 'external', tags: ['Áúº‰πæ', 'ÊªãÊΩ§'], strength: 'Ê∫´Âíå', strengthVal: 1, rec: 'good', sleep: 'none', sideEffect: 'ÁÑ°', food: 'empty', price: 'low', kid: 'ok', kidDose: '1Êª¥ x 4Ê¨°', adultDose: '1Êª¥ x 4Ê¨°', gen: '-', note: '‰∫∫ÈÄ†Ê∑öÊ∞¥' },
        { id: 25, name: 'LCRxx ÈºªÂÆâËàí', category: 'external', tags: ['Ê¥óÈºª', 'Ê∏ÖÊΩî'], strength: 'Ê∫´Âíå', strengthVal: 1, rec: 'good', sleep: 'none', sideEffect: 'ÁÑ°', food: 'empty', price: 'med', kid: 'ok', kidDose: 'ÈÅ©Èáè x 2Ê¨°', adultDose: 'ÈÅ©Èáè x 2Ê¨°', gen: '-', note: 'ÈùûËó•ÊÄß' },
    ];

    const STORAGE_KEY_MEMBERS = 'famBox_members_v8'; 
    const STORAGE_KEY_HIDDEN = 'famBox_hidden_v8';

    const safeGetItem = (key, defaultValue) => {
        try {
            const saved = localStorage.getItem(key);
            return saved ? JSON.parse(saved) : defaultValue;
        } catch (e) {
            return defaultValue;
        }
    };

    const safeSetItem = (key, value) => {
        try {
            localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
            console.warn('LocalStorage save failed');
        }
    };

    const App = () => {
        // --- State ---
        const [medications, setMedications] = useState(() => {
            // Ê™¢Êü•ÂàÜÈ°ûÊï∏Èáè (Requirement 1)
            const counts = {};
            INITIAL_MEDICATIONS.forEach(m => {
                counts[m.category] = (counts[m.category] || 0) + 1;
            });
            
            return INITIAL_MEDICATIONS.map(m => {
                // Â¶ÇÊûúË©≤ÂàÜÈ°ûÂè™Êúâ1ÂÄãÊàñÊõ¥Â∞ëÔºå‰∏î‰∏çÊòØ 'external'ÔºåÂâáÊ≠∏ÂÖ• 'external'
                if (counts[m.category] <= 1 && m.category !== 'external') {
                    return { ...m, category: 'external' };
                }
                return m;
            });
        });
        
        const [hiddenIds, setHiddenIds] = useState(() => safeGetItem(STORAGE_KEY_HIDDEN, []));
        const [viewMode, setViewMode] = useState('active');
        
        const [members, setMembers] = useState(() => safeGetItem(STORAGE_KEY_MEMBERS, [
            { id: 1, name: 'Alpha', birthDate: '2016-04-01', weight: 23, items: [] },
            { id: 2, name: 'Karson', birthDate: '2019-03-01', weight: 20, items: [] },
            { id: 3, name: 'Danson', birthDate: '1984-01-01', weight: 70, items: [] },
            { id: 4, name: 'Yan', birthDate: '1992-08-01', weight: 50, items: [] }
        ]));

        const [activeMemberId, setActiveMemberId] = useState(members[0]?.id || 1);
        const [editingMember, setEditingMember] = useState(null);

        const [searchTerm, setSearchTerm] = useState('');
        const [selectedCategory, setSelectedCategory] = useState('all');
        const [filterNoSleep, setFilterNoSleep] = useState(false);
        const [filterKidSafe, setFilterKidSafe] = useState(false);

        const [sortConfig, setSortConfig] = useState({ key: 'strengthVal', direction: 'desc' });

        // --- Persistence ---
        useEffect(() => { safeSetItem(STORAGE_KEY_MEMBERS, members); }, [members]);
        useEffect(() => { safeSetItem(STORAGE_KEY_HIDDEN, hiddenIds); }, [hiddenIds]);

        const activeMember = members.find(m => m.id === activeMemberId) || members[0];
        const activeAge = calculateAge(activeMember.birthDate);
        const isChildActive = activeAge < 12;

        // --- Logic ---
        const filteredData = useMemo(() => {
            let data = medications.filter(med => {
                if (viewMode === 'active' && hiddenIds.includes(med.id)) return false;
                if (viewMode === 'deleted' && !hiddenIds.includes(med.id)) return false;

                const matchesSearch = med.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                      med.note.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                      med.tags.some(t => t.includes(searchTerm));
                if (!matchesSearch) return false;

                if (selectedCategory !== 'all') {
                    if (selectedCategory === 'nose_all') {
                        if (!['nose_run', 'nose_block'].includes(med.category)) return false;
                    } else {
                        if (med.category !== selectedCategory) return false;
                    }
                }

                if (filterNoSleep && med.sleep !== 'none') return false;
                if (filterKidSafe && med.kid === 'no') return false;

                return true;
            });

            data.sort((a, b) => {
                let aValue = a[sortConfig.key];
                let bValue = b[sortConfig.key];

                if (sortConfig.key === 'rec') {
                    const score = { 'best': 3, 'good': 2, 'neutral': 1, 'bad': 0 };
                    aValue = score[a.rec] || 0; 
                    bValue = score[b.rec] || 0;
                }
                if (sortConfig.key === 'sleep') {
                    const score = { 'none': 0, 'low': 1, 'med': 2, 'high': 3 };
                    aValue = score[a.sleep] || 0;
                    bValue = score[b.sleep] || 0;
                }
                if (sortConfig.key === 'kid') {
                    const score = { 'ok': 2, 'caution': 1, 'no': 0 };
                    aValue = score[a.kid] || 0;
                    bValue = score[b.kid] || 0;
                }

                if (aValue < bValue) return sortConfig.direction === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortConfig.direction === 'asc' ? 1 : -1;
                return 0;
            });
            return data;
        }, [medications, hiddenIds, viewMode, searchTerm, selectedCategory, sortConfig, filterNoSleep, filterKidSafe]);

        // --- Actions ---
        const createMember = () => {
            const newId = Date.now();
            const newMembers = [...members, { id: newId, name: `ÊàêÂì°`, birthDate: '2000-01-01', weight: 50, items: [] }];
            setMembers(newMembers);
            setActiveMemberId(newId);
            setEditingMember({ ...newMembers[newMembers.length-1] });
        };

        const deleteMember = (id, e) => {
            e.stopPropagation();
            if (members.length <= 1) { alert("ÊúÄÂ∞ë‰øùÁïô‰∏ÄÂÄãÊàêÂì°ÂêçÂñÆ"); return; }
            if (!confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÊàêÂì°ÁöÑÂêçÂñÆÂóéÔºü")) return;
            const newMembers = members.filter(m => m.id !== id);
            setMembers(newMembers);
            if (activeMemberId === id) setActiveMemberId(newMembers[0].id);
        };

        const saveMemberEdit = () => {
            setMembers(members.map(m => m.id === editingMember.id ? editingMember : m));
            setEditingMember(null);
        };

        const toggleItemInMember = (medId) => {
            setMembers(members.map(member => {
                if (member.id === activeMemberId) {
                    const exists = member.items.includes(medId);
                    return {
                        ...member,
                        items: exists ? member.items.filter(id => id !== medId) : [...member.items, medId]
                    };
                }
                return member;
            }));
        };

        const softDelete = (id) => setHiddenIds([...hiddenIds, id]);
        const restore = (id) => setHiddenIds(hiddenIds.filter(hid => hid !== id));
        const handleSort = (key) => setSortConfig(current => ({ key, direction: current.key === key && current.direction === 'desc' ? 'asc' : 'desc' }));
        
        const getSortIcon = (key) => {
            if (sortConfig.key !== key) return <i className="ph ph-arrows-down-up sort-icon"></i>;
            return sortConfig.direction === 'asc' 
                ? <i className="ph ph-arrow-up sort-icon sort-active"></i> 
                : <i className="ph ph-arrow-down sort-icon sort-active"></i>;
        };

        const getGoogleImageLink = (name) => `https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name + ' medicine packaging')}`;

        // --- Filter Buttons Configuration ---
        const activeCategories = new Set(medications.map(m => m.category));
        
        const allFilters = [
            { id: 'nose_run', label: 'Êî∂ÈºªÊ∞¥/ÊäóÊïè', icon: 'ph-drop', color: 'blue' },
            { id: 'nose_block', label: 'ÈÄöÈºªÂ°û', icon: 'ph-wind', color: 'sky' },
            { id: 'cough', label: 'Ê≠¢Âí≥/ÂåñÁó∞', icon: 'ph-cloud-rain', color: 'teal' },
            { id: 'trachea', label: 'Ê∞£ÁÆ°/Ê∞£Âñò', icon: 'ph-lungs', color: 'cyan' },
            { id: 'throat', label: 'ÂñâÂö®Áóõ/Ê∂àËÖ´', icon: 'ph-microphone-slash', color: 'indigo' },
            { id: 'fever', label: 'ÁôºÁáí/Ê≠¢Áóõ', icon: 'ph-thermometer', color: 'red' },
            { id: 'external', label: 'Â§ñÁî®/ÂÖ∂‰ªñ', icon: 'ph-bandaids', color: 'amber' },
        ];
        
        const filters = allFilters.filter(f => activeCategories.has(f.id));

        return (
            <div className="w-full max-w-[1400px] mx-auto bg-white shadow-2xl min-h-screen flex flex-col relative">
                
                {/* 1. È†ÇÈÉ®Â∞éËà™ËàáÊàêÂì°ÁÆ°ÁêÜÂô® */}
                <div className="bg-slate-900 text-white p-4 sticky top-0 z-30 shadow-lg">
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
                        <div>
                            <h1 className="text-2xl font-bold flex items-center gap-2 text-blue-400">
                                <i className="ph ph-first-aid-kit text-3xl"></i> ÂÆ∂Â∫≠Ëó•ÁÆ±Êô∫ËÉΩË°®
                            </h1>
                        </div>
                        
                        <div className="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                            <button onClick={() => setViewMode('active')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all ${viewMode === 'active' ? 'bg-blue-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>
                                Ëó•Áâ©Â∫´
                            </button>
                            <button onClick={() => setViewMode('deleted')} className={`px-4 py-1.5 rounded-md text-sm font-medium transition-all flex items-center gap-1 ${viewMode === 'deleted' ? 'bg-red-600 text-white shadow' : 'text-gray-400 hover:text-white'}`}>
                                <i className="ph ph-trash"></i> Â∑≤ÁßªÈô§ ({hiddenIds.length})
                            </button>
                        </div>
                    </div>

                    {/* ÊàêÂì° Tabs */}
                    <div className="flex flex-wrap items-end gap-2 mb-0">
                        {members.map(m => (
                            <div key={m.id} 
                                onClick={() => setActiveMemberId(m.id)}
                                className={`member-tab cursor-pointer px-4 py-2 rounded-t-lg border-t border-x flex items-center gap-2 relative group ${activeMemberId === m.id ? 'member-tab-active z-10' : 'member-tab-inactive z-0'}`}>
                                <span className="font-bold">{m.name}</span>
                                {activeMemberId === m.id && (
                                    <button onClick={(e) => { e.stopPropagation(); setEditingMember({...m}); }} className="text-blue-200 hover:text-white ml-1">
                                        <i className="ph ph-pencil-simple"></i>
                                    </button>
                                )}
                                <button onClick={(e) => deleteMember(m.id, e)} className="opacity-0 group-hover:opacity-100 hover:text-red-400 transition-opacity ml-1">
                                    <i className="ph ph-x-circle"></i>
                                </button>
                            </div>
                        ))}
                        <button onClick={createMember} className="px-3 py-2 text-slate-400 hover:text-white hover:bg-slate-800 rounded-t-lg transition-colors">
                            <i className="ph ph-plus text-lg"></i>
                        </button>
                    </div>

                    {/* Áï∂ÂâçÊàêÂì°Ë≥áË®äÈù¢Êùø */}
                    <div className="bg-blue-600 text-white p-3 rounded-b-lg rounded-tr-lg shadow-inner flex flex-wrap gap-4 items-center justify-between -mt-[1px] z-20 relative border-t border-blue-500">
                        <div className="flex items-center gap-4 text-sm">
                            <div className="flex items-center gap-1 bg-blue-700/50 px-2 py-1 rounded">
                                <i className="ph ph-cake"></i>
                                <span>{activeAge} Ê≠≤</span>
                            </div>
                            <div className="flex items-center gap-1 bg-blue-700/50 px-2 py-1 rounded">
                                <i className="ph ph-scales"></i>
                                <span>{activeMember.weight} kg</span>
                            </div>
                            <div className="flex items-center gap-1 bg-blue-700/50 px-2 py-1 rounded">
                                <i className="ph ph-pill"></i>
                                <span>Â∑≤ÈÅ∏: {activeMember.items.length}</span>
                            </div>
                        </div>
                        
                        {/* Á∑®ËºØ Modal */}
                        {editingMember && (
                            <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white text-slate-900 p-6 rounded-xl shadow-2xl w-full max-w-sm animate-fade-in">
                                    <h3 className="text-lg font-bold mb-4">Á∑®ËºØÊàêÂì°Ë≥áÊñô</h3>
                                    <div className="space-y-3">
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">ÂêçÁ®±</label>
                                            <input type="text" value={editingMember.name} onChange={e => setEditingMember({...editingMember, name: e.target.value})} className="w-full border p-2 rounded" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">Âá∫ÁîüÊó•Êúü</label>
                                            <input type="date" value={editingMember.birthDate} onChange={e => setEditingMember({...editingMember, birthDate: e.target.value})} className="w-full border p-2 rounded" />
                                        </div>
                                        <div>
                                            <label className="block text-xs text-gray-500 mb-1">È´îÈáç (kg)</label>
                                            <input type="number" value={editingMember.weight} onChange={e => setEditingMember({...editingMember, weight: Number(e.target.value)})} className="w-full border p-2 rounded" />
                                        </div>
                                    </div>
                                    <div className="flex gap-2 mt-6 justify-end">
                                        <button onClick={() => setEditingMember(null)} className="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">ÂèñÊ∂à</button>
                                        <button onClick={saveMemberEdit} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ÂÑ≤Â≠ò</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeMember.items.length > 0 && (
                            <div className="flex flex-wrap gap-2">
                                {activeMember.items.map(itemId => {
                                    const item = medications.find(m => m.id === itemId);
                                    if (!item) return null;
                                    const isDeleted = hiddenIds.includes(itemId);
                                    return (
                                        <span key={itemId} className={`text-xs px-2 py-1 rounded flex items-center gap-1 border shadow-sm ${
                                            isDeleted ? 'bg-red-100 border-red-200 text-red-800' : 'bg-white text-blue-800 border-blue-200'
                                        }`}>
                                            {item.name}
                                            <button onClick={() => toggleItemInMember(itemId)} className="hover:text-red-500 ml-1"><i className="ph ph-x"></i></button>
                                        </span>
                                    );
                                })}
                            </div>
                        )}
                    </div>
                </div>

                {/* 2. ÁØ©ÈÅ∏Â∑•ÂÖ∑Âàó */}
                <div className="p-4 bg-white border-b border-gray-200 space-y-4">
                    <div className="flex flex-col md:flex-row gap-4 justify-between">
                        <div className="relative flex-1">
                            <i className="ph ph-magnifying-glass absolute left-3 top-2.5 text-gray-400"></i>
                            <input type="text" placeholder="ÊêúÂ∞ãËó•Âêç„ÄÅÂäüÊïà..."
                                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50"
                                value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} />
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setFilterNoSleep(!filterNoSleep)}
                                className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border transition-all ${filterNoSleep ? 'bg-green-100 border-green-300 text-green-800' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                <i className={`ph ${filterNoSleep ? 'ph-check-square' : 'ph-square'}`}></i> üü¢ ÁÑ°Áù°ÊÑè
                            </button>
                            <button onClick={() => setFilterKidSafe(!filterKidSafe)}
                                className={`px-3 py-2 rounded-lg text-sm font-medium flex items-center gap-2 border transition-all ${filterKidSafe ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-white border-gray-200 text-gray-500 hover:bg-gray-50'}`}>
                                <i className={`ph ${filterKidSafe ? 'ph-check-square' : 'ph-square'}`}></i> üë∂ Â∞èÁ´•ÈÅ©Áî®
                            </button>
                        </div>
                    </div>

                    <div className="flex flex-wrap gap-2">
                        <button onClick={() => setSelectedCategory('all')} 
                            className={`cat-btn px-3 py-1.5 rounded-full text-xs font-medium border ${selectedCategory === 'all' ? 'bg-gray-800 text-white' : 'bg-white text-gray-600 hover:bg-gray-100'}`}>
                            ÂÖ®ÈÉ®
                        </button>
                        {filters.map(cat => (
                            <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} 
                                className={`cat-btn px-3 py-1.5 rounded-full text-xs font-medium flex items-center gap-1 border ${selectedCategory === cat.id ? `bg-${cat.color}-600 text-white border-${cat.color}-600` : `bg-white text-gray-600 hover:bg-${cat.color}-50`}`}>
                                <i className={`ph ${cat.icon}`}></i> {cat.label}
                            </button>
                        ))}
                    </div>
                </div>

                {/* 3. ‰∏ªË°®Ê†º */}
                <div className="flex-1 overflow-x-auto bg-gray-50 pb-8">
                    <table className="w-full text-left border-collapse min-w-[1100px]">
                        <thead className="bg-gray-200 text-gray-700 uppercase text-xs sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th className="p-3 w-14 text-center">ÂúñÁâá</th>
                                <th className="p-3 w-10 text-center">ÈÅ∏Âèñ</th>
                                <th className="p-3 w-[14%]" onClick={() => handleSort('name')}>Ëó•Âêç / Ê®ôÁ±§ {getSortIcon('name')}</th>
                                <th className="p-3 w-16" onClick={() => handleSort('rec')}>Êé®Ëñ¶ {getSortIcon('rec')}</th>
                                <th className="p-3 w-16" onClick={() => handleSort('strengthVal')}>Âº∑Â∫¶ {getSortIcon('strengthVal')}</th>
                                <th className="p-3 w-20" onClick={() => handleSort('sleep')}>Áù°ÊÑè {getSortIcon('sleep')}</th>
                                <th className="p-3 w-16" onClick={() => handleSort('food')}>È£ΩËÇö {getSortIcon('food')}</th>
                                <th className="p-3 w-28" onClick={() => handleSort('kid')}>
                                    {isChildActive ? `Âª∫Ë≠∞ÂäëÈáè (${activeMember.weight}kg)` : 'Âª∫Ë≠∞ÂäëÈáè (Êàê‰∫∫)'} {getSortIcon('kid')}
                                </th>
                                <th className="p-3 w-auto" onClick={() => handleSort('note')}>ÂÇôË®ª / ÂâØ‰ΩúÁî® {getSortIcon('note')}</th>
                                <th className="p-3 w-12 text-center">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-gray-200 text-sm bg-white">
                            {filteredData.map(med => {
                                const isInList = activeMember.items.includes(med.id);
                                const doseInfo = calculateDynamicDose(med, activeMember);
                                const isHighlighted = isChildActive && med.kid === 'ok';
                                
                                return (
                                    <tr key={med.id} className={`transition-colors ${
                                        isInList ? 'bg-blue-100/70' : 
                                        isHighlighted ? 'bg-green-50 hover:bg-green-100' : 
                                        'hover:bg-gray-50'
                                    }`}>
                                        <td className="p-2 text-center">
                                            <a href={getGoogleImageLink(med.name)} target="_blank" className="block w-10 h-10 bg-gray-100 rounded flex items-center justify-center mx-auto hover:bg-blue-100 hover:text-blue-600 border border-gray-200 text-gray-400">
                                                <i className="ph ph-image text-xl"></i>
                                            </a>
                                        </td>
                                        <td className="p-2 text-center">
                                            {viewMode === 'active' && (
                                                <button onClick={() => toggleItemInMember(med.id)} 
                                                    className={`w-8 h-8 rounded-full flex items-center justify-center transition-all ${isInList ? 'bg-blue-600 text-white shadow-md scale-110' : 'bg-gray-100 text-gray-400 hover:bg-blue-200 hover:text-blue-600'}`}>
                                                    {isInList ? <i className="ph ph-check text-lg"></i> : <i className="ph ph-plus text-lg"></i>}
                                                </button>
                                            )}
                                        </td>
                                        <td className="p-3">
                                            <div className="font-bold text-gray-800 text-base leading-tight">{med.name}</div>
                                            <div className="flex flex-wrap gap-1 mt-1">
                                                {med.tags.map((tag, i) => (
                                                    <span key={i} className={`text-[10px] px-1.5 py-0.5 rounded border ${
                                                        tag.includes('ÈÄÄÁáí') ? 'bg-red-50 text-red-700 border-red-100' :
                                                        tag.includes('Ê≠¢Áóõ') ? 'bg-orange-50 text-orange-700 border-orange-100' :
                                                        tag.includes('Ê∞£ÁÆ°') ? 'bg-cyan-50 text-cyan-700 border-cyan-100' :
                                                        'bg-gray-100 text-gray-600 border-gray-200'
                                                    }`}>{tag}</span>
                                                ))}
                                            </div>
                                        </td>
                                        <td className="p-3 text-center">
                                            {med.rec === 'best' ? <i className="ph ph-thumbs-up text-green-600 text-xl"></i> :
                                             med.rec === 'bad' ? <i className="ph ph-thumbs-down text-red-500 text-xl"></i> : 
                                             <span className="text-gray-300">-</span>}
                                        </td>
                                        <td className={`p-3 font-medium ${med.strengthVal >= 4 ? 'text-red-600' : 'text-gray-700'}`}>{med.strength}</td>
                                        <td className="p-3">
                                            {med.sleep === 'high' ? <span className="text-red-600 font-bold text-xs">Ê•µÁúºÁûì</span> :
                                             med.sleep === 'med' ? <span className="text-orange-500 font-bold text-xs">ÊúâÁù°ÊÑè</span> :
                                             med.sleep === 'low' ? <span className="text-yellow-600 font-bold text-xs">ÂæÆÁù°ÊÑè</span> :
                                             <span className="text-green-600 font-bold text-xs">ÁÑ°</span>}
                                        </td>
                                        <td className="p-3 text-xs">
                                            {med.food === 'full' ? <span className="text-blue-600 font-bold">È£ΩËÇö</span> : <span className="text-gray-400">ÂèØÁ©∫</span>}
                                        </td>
                                        <td className="p-3">
                                            {isChildActive ? (
                                                med.kid === 'no' ? (
                                                    <span className="text-red-500 text-xs font-bold">‰∏çÂèØ</span>
                                                ) : (
                                                    <div className={`flex flex-col p-1 rounded ${med.kid === 'ok' ? 'bg-green-100/80 border border-green-200' : 'bg-yellow-50 border border-yellow-200'}`}>
                                                        <span className={`text-xs font-bold ${med.kid === 'ok' ? 'text-green-700' : 'text-yellow-700'}`}>
                                                            {doseInfo.text}
                                                        </span>
                                                        {med.kid === 'caution' && <span className="text-[10px] text-yellow-600">ÊÖéÁî®</span>}
                                                    </div>
                                                )
                                            ) : (
                                                <div className="flex flex-col p-1 rounded bg-blue-50 border border-blue-100">
                                                    <span className="text-xs font-bold text-blue-800">
                                                        {doseInfo.text}
                                                    </span>
                                                </div>
                                            )}
                                        </td>
                                        <td className="p-3 text-xs">
                                            <div className="text-gray-800">{med.note}</div>
                                            {med.sideEffect !== 'ÁÑ°' && med.sideEffect !== 'Ê•µÂ∞ë' && med.sideEffect !== 'Êú™Áü•' && <div className="text-red-500 mt-0.5">‚ö† {med.sideEffect}</div>}
                                        </td>
                                        <td className="p-3 text-center">
                                            {viewMode === 'active' ? (
                                                <button onClick={() => softDelete(med.id)} className="text-gray-300 hover:text-red-500 hover:bg-red-50 p-2 rounded transition-colors" title="ÁßªÈô§">
                                                    <i className="ph ph-trash text-lg"></i>
                                                </button>
                                            ) : (
                                                <button onClick={() => restore(med.id)} className="text-green-500 hover:text-green-700 hover:bg-green-50 p-2 rounded transition-colors mx-auto" title="ÈÇÑÂéü">
                                                    <i className="ph ph-arrow-counter-clockwise text-lg"></i>
                                                </button>
                                            )}
                                        </td>
                                    </tr>
                                );
                            })}
                        </tbody>
                    </table>
                    {filteredData.length === 0 && (
                        <div className="p-12 text-center text-gray-400 flex flex-col items-center">
                            <i className="ph ph-ghost text-4xl mb-2"></i>
                            <p>{viewMode === 'active' ? 'Ê≤íÊúâÊâæÂà∞Áõ∏ÈóúËó•Áâ©' : 'ÂõûÊî∂Á≠íÊòØÁ©∫ÁöÑ'}</p>
                        </div>
                    )}
                </div>
                
                <div className="absolute bottom-1 right-2 text-[10px] text-slate-300 pointer-events-none z-0">
                    {APP_VERSION}
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
