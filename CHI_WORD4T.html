<!DOCTYPE html>
<html lang="zh-HK">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ä¸­è‹±é–ƒå¡ v4.1 (å­¸ç”Ÿç®¡ç†å¢å¼·ç‰ˆ)</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Serif+HK:wght@500;700;900&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
<style>
:root {
    --bg-primary: #e0f7fa;
    --bg-secondary: #ffffff;
    --text-primary: #37474f;
    --text-secondary: #78909c;

    --accent: #ff7043;
    --btn-speak: #42a5f5;
    --btn-record: #ef5350;
    --btn-pause: #ffca28;
    --btn-pause-text: #37474f;
    --btn-master: #66bb6a;
    --danger: #ef5350;
    --import-btn: #fdd835;
    --reset-btn: #78909c;
    --review-color: #ff9800;

    --card-border: #b2ebf2;
    --font-ui: 'M PLUS Rounded 1c', sans-serif;
    --font-learn-zh: 'Kaiti TC', 'STKaiti', 'BiaoKai', 'Noto Serif HK', serif;
    --font-learn-en: 'Nunito', sans-serif;

    --progress-color: #c8e6c9;
}

* { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

body {
    font-family: var(--font-ui);
    background: var(--bg-primary);
    color: var(--text-primary);
    height: 100vh;
    height: 100dvh;
    overflow: hidden;
    padding: 15px;
    padding-top: max(15px, env(safe-area-inset-top));
    display: flex;
    flex-direction: column;
}

/* --- å¼·åŠ›éš±è—æ–‡å­—æ¨¡å¼ CSS --- */
body.hide-text-mode .word-display {
    filter: blur(70px); opacity: 0.3;
    transition: filter 0.3s ease;
    user-select: none; pointer-events: none;
    transform: scale(0.8);
}
body.hide-text-mode .word-tag span,
body.hide-text-mode .word-tag i {
    filter: blur(15px); opacity: 0.4; pointer-events: none;
}

/* --- ä½ˆå±€ç³»çµ± --- */
.main-layout {
    display: flex; gap: 20px; height: 100%; width: 100%;
    position: relative; z-index: 10; overflow: hidden;
}

.sidebar {
    flex: 0 0 380px;
    display: flex; flex-direction: column; gap: 10px;
    height: 100%; min-height: 0;
}

/* å­¸ç”Ÿåˆ‡æ›æ¬„ */
.profile-bar {
    background: #fff; padding: 8px 12px; border-radius: 16px;
    display: flex; align-items: center; gap: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid var(--card-border);
    flex-shrink: 0;
}
.profile-select {
    flex: 1; border: none; background: #f5f5f5; padding: 8px;
    border-radius: 8px; font-weight: bold; color: var(--text-primary);
    font-family: var(--font-ui); font-size: 1rem; outline: none;
}
.profile-btn {
    width: 36px; height: 36px; border-radius: 8px; border: none;
    background: #eceff1; color: #546e7a; font-size: 1.2rem; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
}

.learning-area {
    flex: 1; display: flex; flex-direction: column; align-items: center;
    justify-content: center; height: 100%; position: relative;
    background: rgba(255,255,255,0.3); border-radius: 24px; padding: 10px;
    min-width: 0;
}

.panel {
    background: var(--bg-secondary);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid var(--card-border);
    display: flex; flex-direction: column;
    overflow: hidden;
}

.panel-header {
    padding: 8px 12px; background: #fff; z-index: 5;
    border-bottom: 1px solid #eee; flex-shrink: 0;
    display: flex; justify-content: space-between; align-items: center;
}
.panel-body {
    flex: 1; overflow-y: auto; padding: 8px;
    min-height: 0; -webkit-overflow-scrolling: touch;
}

.panel-words { flex: 3; min-height: 0; }
.panel-review { flex: 2; border-color: #ffe0b2; background-color: #fff3e0; min-height: 0; }
.panel-review .panel-header { background-color: #fff3e0; border-bottom-color: #ffe0b2; }

.panel-mastered { flex: 2; border-color: #a5d6a7; background-color: #f1f8e9; min-height: 0; }
.panel-mastered .panel-header { background-color: #f1f8e9; border-bottom-color: #dcedc8; }

.panel-title {
    font-size: 1.0rem; color: var(--text-primary); font-weight: 800;
    display: flex; justify-content: space-between; align-items: center; width: 100%;
}

.word-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
    gap: 4px; align-content: start; width: 100%;
}

.word-tag {
    background: #f5f5f5; aspect-ratio: 1 / 1; border-radius: 12px;
    border: 2px solid transparent; cursor: pointer; position: relative;
    transition: transform 0.1s, border-color 0.2s;
    display: flex; align-items: center; justify-content: center;
    text-align: center; font-family: var(--font-learn-zh);
    color: #333; font-weight: bold; padding: 2px; overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}
.word-tag:active { transform: scale(0.95); }
.word-tag.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 112, 67, 0.3); z-index: 2; }

.has-audio-dot {
    position: absolute; top: 4px; right: 4px; width: 8px; height: 8px;
    background-color: var(--btn-record); border-radius: 50%; z-index: 3;
    box-shadow: 0 0 2px rgba(0,0,0,0.3); border: 1px solid white;
}

.word-tag-bg {
    position: absolute; bottom: 0; left: 0; width: 100%; background: var(--progress-color);
    z-index: 0; transition: height 0.5s ease; opacity: 0.6; pointer-events: none;
}

.word-tag-content { position: relative; z-index: 1; width: 100%; pointer-events: none; }
.word-tag span { line-height: 1.1; width: 100%; display: block; }

.len-1 span, .len-2 span { font-size: 1.2rem; }
.len-3 span { font-size: 0.8rem; }
.len-4 span { font-size: 0.9rem; display: flex; flex-direction: column; }
.len-4 span i { font-style: normal; width: 100%; display: block; line-height: 1.0; }
.len-long span { font-size: 0.7rem; word-break: break-word; }

.is-english { font-family: var(--font-learn-en) !important; }
.is-english.len-1 span, .is-english.len-2 span { font-size: 1.0rem; }
.is-english.len-long span { font-size: 0.6rem; }

.view-count {
    position: absolute; bottom: 1px; left: 3px; font-size: 0.55rem;
    color: #78909c; font-family: var(--font-ui); font-weight: 700; z-index: 2;
}

.add-tag {
    background: #eceff1; color: #90a4ae; font-size: 2.5rem; border: 2px dashed #cfd8dc;
}
.grid-input {
    width: 100%; height: 100%; border: none; background: #fff;
    text-align: center; font-size: 1.2rem; font-family: var(--font-learn-zh);
    outline: none; border-radius: 10px; color: var(--text-primary); padding: 0;
}

.progress-container { width: 100%; max-width: 500px; margin-bottom: 10px; text-align: center; flex-shrink: 0; }
.progress-bar { height: 8px; background: #eceff1; border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #ffca28, #ffa000); transition: width 0.3s; }
.progress-text { font-size: 0.9rem; font-weight: bold; color: var(--text-secondary); margin-top: 5px; }

.flashcard {
    background: rgba(255, 255, 255, 0.95);
    width: 100%; max-width: 700px; flex: 1; max-height: 50vh;
    border-radius: 24px; border: 4px solid var(--card-border);
    box-shadow: 0 8px 0 rgba(0,0,0,0.05);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    margin-bottom: 15px; position: relative; z-index: 20;
    min-height: 150px;
}

.word-display {
    font-size: 8rem; font-weight: 700; color: var(--text-primary);
    text-align: center; line-height: 1.2; font-family: var(--font-learn-zh);
    padding: 10px; width: 100%; word-break: break-word;
}
.word-display.en-font { font-family: var(--font-learn-en); font-weight: 800; }

.status-badge {
    position: absolute; top: 15px; padding: 6px 16px; border-radius: 20px;
    font-weight: bold; font-size: 1.2rem; opacity: 0; transition: opacity 0.2s; pointer-events: none;
}
.status-waiting { background: #fff9c4; color: #f9a825; opacity: 1; border: 2px solid #fff59d; }
.status-reading { background: #e3f2fd; color: #1565c0; opacity: 1; border: 2px solid #bbdefb; }
.status-recording { background: #ffebee; color: #c62828; opacity: 1; border: 2px solid #ffcdd2; animation: pulse 1.5s infinite; }
.status-paused { background: #ffe0b2; color: #e65100; opacity: 1; border: 2px solid #ffcc80; }

@keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

.card-info-bl {
    position: absolute; bottom: 20px; left: 25px;
    font-size: 2rem; color: #90a4ae; font-weight: 800;
    display: flex; align-items: center; gap: 5px;
    text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
}
.card-info-br {
    position: absolute; bottom: 20px; right: 25px;
    font-size: 2rem; color: #90a4ae; font-weight: 800;
    display: flex; align-items: center; gap: 5px;
    text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
}

.controls-grid {
    display: grid; grid-template-columns: 1fr 0.4fr 1fr; gap: 10px;
    width: 100%; max-width: 600px; z-index: 20; flex-shrink: 0;
}

.big-btn {
    border: none; padding: 14px; border-radius: 18px; font-size: 1.1rem;
    font-weight: 800; cursor: pointer; color: white;
    display: flex; align-items: center; justify-content: center; gap: 8px;
    transition: all 0.1s; position: relative; top: 0;
    font-family: var(--font-ui); box-shadow: 0 5px 0 rgba(0,0,0,0.15);
}
.big-btn:active { top: 5px; box-shadow: none !important; }
.big-btn:disabled { background: #cfd8dc !important; box-shadow: none !important; color: #fff; cursor: not-allowed; top: 0; }

.btn-speak { background: var(--btn-speak); box-shadow: 0 5px 0 #1e88e5; }
.btn-speak.paused { background: var(--btn-pause); box-shadow: 0 5px 0 #ffb300; color: var(--btn-pause-text); }

.btn-record { background: var(--btn-record); box-shadow: 0 5px 0 #c62828; font-size: 1.5rem; }
.btn-record.recording { background: #b71c1c; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); top: 5px; }

.btn-master { background: var(--btn-master); box-shadow: 0 5px 0 #43a047; }

.nav-row {
    display: flex; gap: 15px; width: 100%; max-width: 600px; margin-top: 10px;
}
.nav-btn {
    flex: 1; background: #fff; color: var(--text-primary); border: 2px solid #cfd8dc;
    box-shadow: 0 5px 0 #b0bec5; font-size: 1rem; padding: 10px;
}

.toggles-area {
    margin-top: 10px; display: flex; gap: 15px; background: rgba(255,255,255,0.6);
    padding: 8px 20px; border-radius: 16px; flex-wrap: wrap; justify-content: center; flex-shrink: 0;
}
.toggle-item { display: flex; align-items: center; gap: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; }
.toggle-item input { accent-color: var(--accent); width: 20px; height: 20px; }

.parents-bar {
    margin-top: auto; display: flex; gap: 10px; justify-content: center; padding-top: 10px; flex-shrink: 0;
}
.mini-btn {
    padding: 10px 14px; font-size: 0.85rem; border-radius: 10px; border: 1px solid #cfd8dc;
    background: #fff; cursor: pointer; font-weight: bold; color: #546e7a;
}

.save-status {
    position: fixed; bottom: 10px; right: 10px; font-size: 0.75rem;
    background: rgba(255,255,255,0.9); padding: 6px 12px; border-radius: 20px;
    color: #78909c; font-weight: bold; pointer-events: none; z-index: 1000;
    display: flex; align-items: center; gap: 6px; opacity: 0; transition: opacity 0.3s;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 1px solid #eceff1;
}

.version-tag {
    position: fixed; bottom: 5px; right: 8px; font-size: 0.65rem;
    color: #b0bec5; font-weight: bold; z-index: 5000; pointer-events: none;
    font-family: var(--font-ui);
}

/* Modal */
.custom-modal {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(4px);
}
.modal-content {
    background: white; width: 90%; max-width: 500px; border-radius: 24px;
    padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.25);
    text-align: center; display: flex; flex-direction: column; max-height: 85vh;
    overflow-y: auto;
}

.import-textarea {
    width: 100%; height: 30vh;
    border: 2px solid #cfd8dc; border-radius: 12px;
    padding: 15px; font-size: 1.1rem; resize: none; font-family: var(--font-ui);
    margin: 10px 0;
}

.modal-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
.modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 0.95rem; cursor: pointer; white-space: nowrap;}
.btn-save { background: var(--accent); color: white; }
.btn-paste { background: var(--import-btn); color: #333; }
.btn-no { background: #eceff1; color: #455a64; }
.btn-danger { background: var(--danger); color: white; }

/* Profile Manager Styles */
.profile-list-container {
    max-height: 50vh; overflow-y: auto; margin: 10px 0;
    border: 1px solid #eee; border-radius: 12px; padding: 5px;
}
.profile-row {
    display: flex; align-items: center; gap: 5px; padding: 8px;
    background: #f9f9f9; border-radius: 8px; margin-bottom: 6px;
    border: 1px solid #eee;
}
.profile-row.active-profile {
    border-color: var(--accent); background: #fff3e0;
}
.profile-name-input {
    flex: 1; border: 1px solid transparent; background: transparent;
    font-size: 1rem; font-weight: bold; color: #333; padding: 4px;
    border-radius: 4px; font-family: var(--font-ui);
}
.profile-name-input:focus {
    background: #fff; border-color: var(--accent); outline: none;
}
.profile-action-btn {
    width: 30px; height: 30px; border-radius: 6px; border: none;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 0.9rem; flex-shrink: 0;
}
.btn-move { background: #eceff1; color: #546e7a; }
.btn-del { background: #ffebee; color: #c62828; }

/* New Settings Grid */
.settings-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;
}
.btn-setting-action {
    width: 100%; padding: 15px 5px; border-radius: 12px; border: none;
    font-weight: bold; font-size: 0.9rem; cursor: pointer; color: white;
    display: flex; flex-direction: column; align-items: center; gap: 5px;
}

.setting-row {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 15px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 10px;
    flex-wrap: wrap; gap: 5px;
}
.setting-label { flex: 1; padding-right: 10px; font-size: 0.95rem; font-weight: bold; color: #546e7a; min-width: 150px; }
.setting-input { width: 80px; padding: 8px; border-radius: 10px; border: 1px solid #cfd8dc; text-align: center; font-size: 1.1rem; }
.setting-input:focus { border-color: var(--accent); outline: none; background: #fff3e0; }

.toast {
    position: fixed;
    top: 15%; left: 50%; transform: translate(-50%, 0);
    background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
    border-radius: 40px; font-weight: bold; font-size: 1.1rem;
    z-index: 4000; opacity: 0; pointer-events: none;
    transition: opacity 0.3s; text-align: center;
    width: max-content; max-width: 90%;
}

.select-mode-active .panel-words { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent) inset; }
.delete-mode-active .panel-mastered { border-color: var(--danger); box-shadow: 0 0 0 2px var(--danger) inset; }
.review-mode-active .panel-review { border-color: #ff9800; box-shadow: 0 0 0 2px #ff9800 inset; }

.select-checkbox {
    position: absolute; top: 2px; right: 2px; width: 22px; height: 22px;
    z-index: 10; cursor: pointer;
}
.select-mode-active .word-tag, .delete-mode-active .word-tag, .review-mode-active .word-tag { cursor: default; }

.mode-controls { display: none; gap: 5px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
.mode-btn { padding: 4px 6px; border-radius: 6px; border: none; font-size: 0.65rem; font-weight: bold; cursor: pointer; color: white; margin-left: 2px; }

#confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2500; }

@media (orientation: portrait) {
    .main-layout { flex-direction: column; gap: 10px; }
    .sidebar { flex: none; height: 50%; width: 100%; }
    .learning-area { height: 50%; border-radius: 24px 24px 0 0; }
    .word-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); }
    .flashcard { max-height: 30vh; }
    .word-display { font-size: 6rem; }
    .controls-grid { margin-bottom: 5px; }
    .card-info-bl, .card-info-br { font-size: 1.5rem; bottom: 10px; }
}

@media (max-width: 600px) {
    .word-display { font-size: 4rem; }
    .big-btn { font-size: 0.9rem; padding: 10px; }
    .sidebar { height: 45%; }
    .learning-area { height: 55%; }
}
</style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>
    <div class="version-tag">v4.1</div>

    <div class="main-layout">
        <div class="sidebar">
            <!-- å­¸ç”Ÿæª”æ¡ˆåˆ‡æ› -->
            <div class="profile-bar">
                <span style="font-size:1.2rem">ğŸ‘¤</span>
                <select id="profileSelect" class="profile-select" onchange="switchProfile(this.value)">
                    <option value="default">é è¨­å­¸ç”Ÿ</option>
                </select>
                <!-- æ”¹ç‚ºç®¡ç†æŒ‰éˆ• -->
                <button class="profile-btn" onclick="openProfileManager()">âš™ï¸</button>
            </div>

            <!-- è©èªè¡¨ -->
            <div class="panel panel-words">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ“– è©èªè¡¨ <small id="wordCount">(0)</small></span>
                        <div id="wordSelectControls" class="mode-controls">
                            <button class="mode-btn" style="background:var(--review-color)" onclick="confirmBatchMoveFromWordsToReview()">ç§»è‡³é‚„è¦ç·´</button>
                            <button class="mode-btn" style="background:var(--btn-master)" onclick="confirmBatchMove()">ç§»è‡³å·²å­¸è­˜</button>
                            <button class="mode-btn" style="background:#cfd8dc; color:#555" onclick="exitWordSelectMode()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="word-grid" id="wordList"></div>
                </div>
            </div>

            <!-- é‚„è¦ç·´ -->
            <div class="panel panel-review">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ’ª é‚„è¦ç·´ <small id="reviewCount">(0)</small></span>
                        <div id="reviewControls" class="mode-controls">
                            <button class="mode-btn" style="background:var(--btn-speak)" onclick="confirmBatchMoveFromReviewToWords()">é€€å›è©èªè¡¨</button>
                            <button class="mode-btn" style="background:var(--btn-master)" onclick="confirmBatchMoveFromReviewToMastered()">æ™‰ç´šå·²å­¸è­˜</button>
                            <button class="mode-btn" style="background:#cfd8dc; color:#555" onclick="exitReviewMode()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="word-grid" id="reviewList"></div>
                </div>
            </div>

            <!-- å·²å­¸è­˜ -->
            <div class="panel panel-mastered">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ† å·²å­¸è­˜ <small id="masteredCount">(0)</small></span>
                        <div id="deleteControls" class="mode-controls">
                            <button class="mode-btn" style="background:var(--btn-speak)" onclick="confirmBatchRestore()">é‚„åŸè©èªè¡¨</button>
                            <button class="mode-btn" style="background:var(--review-color)" onclick="confirmBatchMoveFromMasteredToReview()">ç§»è‡³é‚„è¦ç·´</button>
                            <button class="mode-btn" style="background:var(--danger)" onclick="confirmBatchDelete()">åˆªé™¤</button>
                            <button class="mode-btn" style="background:#cfd8dc; color:#555" onclick="exitDeleteMode()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="word-grid" id="masteredList"></div>
                    <div style="text-align:center; font-size:0.75rem; color:#90a4ae; margin-top:8px;">(é•·æŒ‰ç®¡ç†)</div>
                </div>
            </div>

            <div class="parents-bar">
                <button class="mini-btn" onclick="openEditModal()">ğŸ“ ç·¨è¼¯/å°å…¥</button>
                <button class="mini-btn" onclick="exportData()">ğŸ“¤ å°å‡º</button>
                <button class="mini-btn" onclick="openSettingsModal()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <div class="learning-area">
            <div class="progress-container">
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
                <div class="progress-text" id="progressText">æº–å‚™é–‹å§‹</div>
            </div>

            <div class="flashcard" id="flashcard">
                <div class="status-badge" id="statusBadge">ğŸ‘€ æº–å‚™</div>
                <div class="word-display" id="currentWord">...</div>
                <div class="card-info-bl" id="cardViewCount">ğŸ‘‚ 0</div>
                <div class="card-info-br" id="cardMasteryProgress">ğŸ¯ 0/2</div>
            </div>

            <div class="controls-grid">
                <button class="big-btn btn-speak" id="speakBtn" onclick="toggleSpeak()">ğŸ”Š æœ—è®€</button>
                <button class="big-btn btn-record" id="recordBtn">ğŸ¤</button>
                <button class="big-btn btn-master" id="masteredBtn" onclick="handleMasteryClick(event)">âœ… æˆ‘è­˜è®€!</button>
            </div>

            <div class="nav-row">
                <button class="big-btn nav-btn" id="prevBtn" onclick="manualPrev()">ğŸ‘ˆ ä¸Šä¸€å€‹</button>
                <button class="big-btn nav-btn" id="nextBtn" onclick="manualNext()">ä¸‹ä¸€å€‹ ğŸ‘‰</button>
            </div>

            <div class="toggles-area">
                <label class="toggle-item"><input type="checkbox" id="autoPlayNext"> â–¶ï¸ è‡ªå‹•æ¨¡å¼</label>
                <label class="toggle-item"><input type="checkbox" id="repeatThreeTimes"> ğŸ” è®€ä¸‰æ¬¡</label>
                <label class="toggle-item"><input type="checkbox" id="randomOrder"> ğŸ”€ æ´—ç‰Œæ¨¡å¼</label>
                <label class="toggle-item"><input type="checkbox" id="hideTextMode"> ğŸ™ˆ éš±è—æ–‡å­—</label>
            </div>
        </div>
    </div>

    <div id="saveStatus" class="save-status">â˜ï¸ æº–å‚™ä¸­...</div>
    <div id="toast" class="toast">æç¤ºè¨Šæ¯</div>

    <!-- å­¸ç”Ÿç®¡ç†è¦–çª— (æ–°ç‰ˆ) -->
    <div id="profileManagerModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ‘¤ å­¸ç”Ÿç®¡ç†</div>
            <p style="font-size:0.85rem; color:#888; margin-bottom:10px;">å¯ä¿®æ”¹åå­—ã€èª¿æ•´æ¬¡åºæˆ–åˆªé™¤</p>
            
            <div id="profileListContainer" class="profile-list-container">
                <!-- JS ç”Ÿæˆåˆ—è¡¨ -->
            </div>

            <div class="modal-actions" style="margin-top:5px;">
                <button class="modal-btn btn-save" onclick="openAddProfileModal()">â• æ–°å¢å­¸ç”Ÿ</button>
                <button class="modal-btn btn-no" onclick="closeModal('profileManagerModal')">å®Œæˆ</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢å­¸ç”Ÿè¦–çª— (ç°¡åŒ–) -->
    <div id="addProfileModal" class="custom-modal" style="z-index: 3100;">
        <div class="modal-content">
            <div class="modal-title">â• æ–°å¢å­¸ç”Ÿ</div>
            <input type="text" id="newProfileNameInput" class="import-textarea" style="height:50px; text-align:center;" placeholder="è¼¸å…¥åå­—">
            <div class="modal-actions">
                <button class="modal-btn btn-save" onclick="confirmAddProfile()">å»ºç«‹</button>
                <button class="modal-btn btn-no" onclick="closeModal('addProfileModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯è¦–çª— -->
    <div id="importModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ ç·¨è¼¯/å°å…¥</div>
            <p style="font-size:0.9rem; color:#666; margin-bottom:5px;">ç›´æ¥ä¿®æ”¹æˆ–ç”±å‰ªè²¼ç°¿å°å…¥ã€‚</p>
            <textarea id="importTextarea" class="import-textarea"></textarea>
            <div class="modal-actions">
                <button class="modal-btn btn-paste" onclick="selectAllImportText()">âœ¨ å…¨é¸ (æ–¹ä¾¿è²¼ä¸Š)</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">ğŸ’¾ ä¿å­˜</button>
                <button class="modal-btn btn-no" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šè¦–çª— -->
    <div id="settingsModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ è¨­å®š</div>
            <div class="setting-row">
                <div class="setting-label">è‡ªå‹•æ¨¡å¼å€’æ•¸ (ç§’)</div>
                <input type="number" id="settingAutoDelay" class="setting-input" value="4" min="1" max="10" onchange="autoSaveSettings()">
            </div>
            <div class="setting-row">
                <div class="setting-label">é‡è¤‡æœ—è®€é–“éš” (ç§’)</div>
                <input type="number" id="settingRepeatDelay" class="setting-input" value="3" min="1" max="5" onchange="autoSaveSettings()">
            </div>
            <div class="setting-row">
                <div class="setting-label">ã€Œæˆ‘è­˜è®€ã€é–€æª» (æ¬¡)</div>
                <input type="number" id="settingMasteryThreshold" class="setting-input" value="2" min="1" max="20" onchange="autoSaveSettings()">
            </div>
            <div class="setting-row">
                <div class="setting-label">ã€Œç†Ÿç·´åº¦åˆ¤æ–·ã€è½è®€æ¬¡æ•¸ä¸Šé™</div>
                <input type="number" id="settingMasteryViewLimit" class="setting-input" value="1" min="1" max="50" onchange="autoSaveSettings()">
            </div>

            <div class="settings-grid">
                <button class="btn-setting-action" style="background:#5c6bc0;" onclick="confirmAction('resetStats')">
                    <span>ğŸ“Š é‡ç½®çµ±è¨ˆ</span><span style="font-size:0.7rem; opacity:0.8; font-weight:normal">è½è®€æ¬¡æ•¸æ­¸é›¶</span>
                </button>
                <button class="btn-setting-action" style="background:#78909c;" onclick="confirmAction('resetSettings')">
                    <span>â†©ï¸ é‚„åŸè¨­å®š</span><span style="font-size:0.7rem; opacity:0.8; font-weight:normal">åˆå§‹å€¼</span>
                </button>
                <button class="btn-setting-action" style="background:#ff9800;" onclick="confirmAction('clearAudio')">
                    <span>ğŸ—‘ï¸ æ¸…é™¤éŒ„éŸ³</span><span style="font-size:0.7rem; opacity:0.8; font-weight:normal">ä¿ç•™æ–‡å­—</span>
                </button>
            </div>
            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn btn-no" onclick="closeModal('settingsModal')">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨ç¢ºèªè¦–çª— -->
    <div id="confirmModal" class="custom-modal" style="z-index: 3500;">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title" style="font-size: 1.2rem; margin-bottom: 10px;">âš ï¸ ç¢ºèªæ“ä½œ</div>
            <p id="confirmMessage" style="color: #555; margin-bottom: 20px;">ç¢ºå®šè¦åŸ·è¡Œå—ï¼Ÿ</p>
            <div class="modal-actions">
                <button id="confirmBtn" class="modal-btn btn-save" style="margin-top:0">ç¢ºå®š</button>
                <button class="modal-btn btn-no" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        // --- å…¨å±€è®Šæ•¸ ---
        let words = [];
        let reviewWords = [];
        let masteredWords = [];
        
        // å¤šå­¸ç”Ÿç³»çµ±
        let profiles = JSON.parse(localStorage.getItem('flashcard_profiles')) || [{id: 'default', name: 'é è¨­å­¸ç”Ÿ'}];
        let currentProfileId = localStorage.getItem('flashcard_current_profile') || 'default';

        const initialWords = ["éƒ½æ˜¯", "Apple", "é€™å€‹", "Banana", "åˆæˆ", "Orange", "å…±æœ‰"];
        const initialReview = [];
        const initialMastered = ["å’Œ", "é«˜", "Cat"];

        let currentIndex = 0;
        let cantoneseVoice = null;
        let englishVoice = null;
        let availableVoices = [];

        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimerInterval = null;
        let recordingSeconds = 0;
        let globalAudioPlayer = new Audio();

        let state = { status: 'idle', timerId: null, watchdogId: null, countdownRemaining: 0, countdownCallback: null, countdownLabel: '', repeatCount: 0 };
        let currentRoundId = 1;

        let isDeleteMode = false;
        let isWordSelectMode = false;
        let isReviewMode = false;

        let settings = { autoDelay: 4, repeatDelay: 3, masteryThreshold: 2, masteryViewLimit: 1 };

        const DB_NAME = 'FlashcardDB_v4.0';
        const DB_VERSION = 1;
        let db = null;
        let isDirty = false;
        let saveTimeout = null;
        let mediaUnlocked = false;

        // --- è¼”åŠ©å‡½æ•¸ ---
        function getDBKey(type) {
            return `${currentProfileId}_${type}`;
        }

        function updateProfileSelectUI() {
            const select = document.getElementById('profileSelect');
            select.innerHTML = '';
            profiles.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = p.name;
                if(p.id === currentProfileId) opt.selected = true;
                select.appendChild(opt);
            });
        }

        // --- å­¸ç”Ÿç®¡ç†ç³»çµ± (v4.1 æ–°å¢) ---
        function openProfileManager() {
            renderProfileManagerList();
            document.getElementById('profileManagerModal').style.display = 'flex';
        }

        function renderProfileManagerList() {
            const container = document.getElementById('profileListContainer');
            container.innerHTML = '';
            
            profiles.forEach((p, index) => {
                const row = document.createElement('div');
                row.className = 'profile-row';
                if(p.id === currentProfileId) row.classList.add('active-profile');

                // åå­—è¼¸å…¥æ¡†
                const input = document.createElement('input');
                input.className = 'profile-name-input';
                input.value = p.name;
                input.onchange = (e) => renameProfile(index, e.target.value);

                // ä¸Šç§»æŒ‰éˆ•
                const upBtn = document.createElement('button');
                upBtn.className = 'profile-action-btn btn-move';
                upBtn.innerHTML = 'â¬†ï¸';
                upBtn.disabled = index === 0;
                upBtn.onclick = () => moveProfile(index, -1);
                if(index === 0) upBtn.style.opacity = 0.3;

                // ä¸‹ç§»æŒ‰éˆ•
                const downBtn = document.createElement('button');
                downBtn.className = 'profile-action-btn btn-move';
                downBtn.innerHTML = 'â¬‡ï¸';
                downBtn.disabled = index === profiles.length - 1;
                downBtn.onclick = () => moveProfile(index, 1);
                if(index === profiles.length - 1) downBtn.style.opacity = 0.3;

                // åˆªé™¤æŒ‰éˆ•
                const delBtn = document.createElement('button');
                delBtn.className = 'profile-action-btn btn-del';
                delBtn.innerHTML = 'âŒ';
                delBtn.onclick = () => deleteProfileSpecific(index);

                row.appendChild(input);
                row.appendChild(upBtn);
                row.appendChild(downBtn);
                row.appendChild(delBtn);
                container.appendChild(row);
            });
        }

        function renameProfile(index, newName) {
            if(!newName.trim()) {
                renderProfileManagerList(); // é‚„åŸ
                return;
            }
            profiles[index].name = newName.trim();
            saveProfiles();
            updateProfileSelectUI();
        }

        function moveProfile(index, direction) {
            const targetIndex = index + direction;
            if(targetIndex < 0 || targetIndex >= profiles.length) return;
            
            // Swap
            const temp = profiles[index];
            profiles[index] = profiles[targetIndex];
            profiles[targetIndex] = temp;
            
            saveProfiles();
            renderProfileManagerList();
            updateProfileSelectUI();
        }

        function deleteProfileSpecific(index) {
            if(profiles.length <= 1) {
                showToast("æœ€å°‘è¦ä¿ç•™ä¸€å€‹å­¸ç”Ÿ");
                return;
            }
            const p = profiles[index];
            if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${p.name}ã€å—ï¼Ÿè³‡æ–™å°‡ç„¡æ³•å¾©åŸã€‚`)) return;

            const isCurrent = (p.id === currentProfileId);
            profiles.splice(index, 1);
            saveProfiles();
            
            if(isCurrent) {
                switchProfile(profiles[0].id);
            } else {
                updateProfileSelectUI();
            }
            renderProfileManagerList();
            showToast("å·²åˆªé™¤å­¸ç”Ÿ");
        }

        function saveProfiles() {
            localStorage.setItem('flashcard_profiles', JSON.stringify(profiles));
        }

        function openAddProfileModal() {
            document.getElementById('newProfileNameInput').value = '';
            document.getElementById('addProfileModal').style.display = 'flex';
            document.getElementById('newProfileNameInput').focus();
        }

        function confirmAddProfile() {
            const name = document.getElementById('newProfileNameInput').value.trim();
            if(!name) return;
            const id = 'student_' + Date.now();
            profiles.push({id, name});
            saveProfiles();
            
            switchProfile(id);
            updateProfileSelectUI();
            renderProfileManagerList();
            closeModal('addProfileModal');
            showToast(`å·²å»ºç«‹æ–°å­¸ç”Ÿï¼š${name}`);
        }

        async function switchProfile(newId) {
            if(newId === currentProfileId) return;
            // å…ˆå„²å­˜ç•¶å‰
            if(isDirty) {
                await new Promise(resolve => {
                    saveDataToDB();
                    setTimeout(resolve, 500); // ç°¡å–®ç­‰å¾…å¯«å…¥
                });
            }
            
            currentProfileId = newId;
            localStorage.setItem('flashcard_current_profile', currentProfileId);
            
            // é‡ç½®ç‹€æ…‹
            words = []; reviewWords = []; masteredWords = [];
            currentIndex = 0;
            currentRoundId = 1;
            stopEverything();
            
            await loadDataFromDB();
            updateProfileSelectUI();
            renderLists();
            updateCard();
            
            // å¦‚æœç®¡ç†ä»‹é¢é–‹è‘—ï¼Œé‡æ–°æ¸²æŸ“ä»¥æ›´æ–°é«˜äº®
            if(document.getElementById('profileManagerModal').style.display === 'flex') {
                renderProfileManagerList();
            }
            showToast("å·²åˆ‡æ›å­¸ç”Ÿæª”æ¡ˆ");
        }

        // --- éŸ³é »è§£é– ---
        function makeSilentWavBlob(durationMs = 120, sampleRate = 44100) {
            const numSamples = Math.floor(sampleRate * (durationMs / 1000));
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);
            const writeString = (o, s) => { for (let i=0; i<s.length; i++) view.setUint8(o+i, s.charCodeAt(i)); };
            writeString(0, 'RIFF'); view.setUint32(4, 36 + numSamples*2, true); writeString(8, 'WAVE');
            writeString(12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate*2, true);
            view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(36, 'data');
            view.setUint32(40, numSamples*2, true);
            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function unlockAudioAndSpeech() {
            if (mediaUnlocked) return;
            try {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(' '); u.volume = 0;
                    window.speechSynthesis.speak(u);
                }
                const silent = makeSilentWavBlob(120);
                const url = URL.createObjectURL(silent);
                globalAudioPlayer.muted = true; globalAudioPlayer.src = url;
                await globalAudioPlayer.play().catch(() => {});
                globalAudioPlayer.pause(); globalAudioPlayer.muted = false;
                URL.revokeObjectURL(url);
                mediaUnlocked = true;
            } catch (e) { console.warn('Unlock failed', e); }
        }

        function initGestureUnlock() {
            const handler = async () => {
                await unlockAudioAndSpeech();
                document.removeEventListener('touchstart', handler);
                document.removeEventListener('mousedown', handler);
                document.removeEventListener('keydown', handler);
            };
            document.addEventListener('touchstart', handler, { passive: true });
            document.addEventListener('mousedown', handler);
            document.addEventListener('keydown', handler);
        }

        // --- DB ç³»çµ± ---
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("DB_OPEN_FAIL");
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('data')) db.createObjectStore('data', { keyPath: 'id' });
                };
                request.onsuccess = (event) => { db = event.target.result; resolve(db); };
            });
        }

        async function loadDataFromDB() {
            if (!db) return false;
            return new Promise((resolve) => {
                const transaction = db.transaction(['data'], 'readonly');
                const store = transaction.objectStore('data');
                
                let keyPrefix = currentProfileId === 'default' ? '' : (currentProfileId + '_');
                
                const getWords = store.get(getDBKey('words'));
                const getReview = store.get(getDBKey('review'));
                const getMastered = store.get(getDBKey('mastered'));
                const getSettings = store.get(getDBKey('settings'));
                
                const getOldWords = store.get('words');
                const getOldReview = store.get('review');
                const getOldMastered = store.get('mastered');
                const getOldSettings = store.get('settings');

                transaction.oncomplete = () => {
                    if (getWords.result) words = getWords.result.value;
                    else if (currentProfileId === 'default' && getOldWords.result) words = getOldWords.result.value;
                    else words = (currentProfileId === 'default') ? [...initialWords].map(w => ({ text: w, views: 0, hits: 0, audioBlob: null, roundId: 0 })) : [];

                    if (getReview.result) reviewWords = getReview.result.value;
                    else if (currentProfileId === 'default' && getOldReview.result) reviewWords = getOldReview.result.value;
                    else reviewWords = (currentProfileId === 'default') ? [...initialReview].map(w => ({ text: w, views: 0, hits: 0, audioBlob: null, roundId: 0 })) : [];

                    if (getMastered.result) masteredWords = getMastered.result.value;
                    else if (currentProfileId === 'default' && getOldMastered.result) masteredWords = getOldMastered.result.value;
                    else masteredWords = (currentProfileId === 'default') ? [...initialMastered].map(w => ({ text: w, views: 0, hits: 0, audioBlob: null, roundId: 0 })) : [];

                    if (getSettings.result) settings = { ...settings, ...getSettings.result.value };
                    else if (currentProfileId === 'default' && getOldSettings.result) settings = { ...settings, ...getOldSettings.result.value };

                    words.forEach(w => { if (typeof w.roundId !== 'number') w.roundId = 0; });
                    resolve(true);
                };
                transaction.onerror = () => resolve(false);
            });
        }

        function saveDataToDB() {
            if (!db || !isDirty) return;
            if (saveTimeout) clearTimeout(saveTimeout);
            updateSaveStatus('saving');
            saveTimeout = setTimeout(() => {
                try {
                    const transaction = db.transaction(['data'], 'readwrite');
                    const store = transaction.objectStore('data');
                    store.put({ id: getDBKey('words'), value: words });
                    store.put({ id: getDBKey('review'), value: reviewWords });
                    store.put({ id: getDBKey('mastered'), value: masteredWords });
                    store.put({ id: getDBKey('settings'), value: settings });
                    
                    if (currentProfileId === 'default') {
                        store.put({ id: 'words', value: words });
                        store.put({ id: 'review', value: reviewWords });
                        store.put({ id: 'mastered', value: masteredWords });
                        store.put({ id: 'settings', value: settings });
                    }

                    transaction.oncomplete = () => { updateSaveStatus('saved'); isDirty = false; };
                    transaction.onerror = () => updateSaveStatus('error');
                } catch (e) { updateSaveStatus('error'); }
            }, 1000);
        }

        function updateSaveStatus(status) {
            const el = document.getElementById('saveStatus');
            el.style.opacity = 1;
            if (status === 'saving') { el.textContent = 'ğŸ’¾ å„²å­˜ä¸­...'; el.style.color = '#ffa000'; }
            else if (status === 'saved') {
                el.textContent = 'â˜ï¸ å·²å„²å­˜'; el.style.color = '#4caf50';
                setTimeout(() => { if(!isDirty) el.style.opacity = 0; }, 2000);
            }
            else if (status === 'error') { el.textContent = 'âš ï¸ ç„¡æ³•å„²å­˜'; el.style.color = '#f44336'; }
        }

        function markDirty() { isDirty = true; updateSaveStatus('saving'); saveDataToDB(); }

        // --- åˆå§‹åŒ– ---
        async function init() {
            initGestureUnlock();
            updateProfileSelectUI(); 
            
            try {
                await initDB();
                await loadDataFromDB();
                updateSaveStatus('saved');
            } catch (e) {
                console.warn("DB Init failed", e);
                words = initialWords.map(w => ({ text: w, views: 0, hits: 0, audioBlob: null, roundId: 0 }));
                updateSaveStatus('error');
            }

            renderLists();
            updateCard();

            if ('speechSynthesis' in window) {
                window.speechSynthesis.onvoiceschanged = loadVoices;
                loadVoices();
            }

            document.getElementById('autoPlayNext').addEventListener('change', async (e) => {
                stopEverything();
                if (!e.target.checked) return;
                await unlockAudioAndSpeech();
                if (words.length > 0) {
                    if (document.getElementById('randomOrder').checked) { currentIndex = pickNextIndexRandom(true); updateCard(); }
                    startSequence();
                }
            });

            document.getElementById('randomOrder').addEventListener('change', () => {
                currentRoundId++; words.forEach(w => w.roundId = 0);
                if (document.getElementById('randomOrder').checked && words.length > 0) currentIndex = pickNextIndexRandom(true);
                updateCard();
            });

            document.getElementById('hideTextMode').addEventListener('change', (e) => {
                if(e.target.checked) document.body.classList.add('hide-text-mode');
                else document.body.classList.remove('hide-text-mode');
            });

            const recBtn = document.getElementById('recordBtn');
            const handleRecStart = (e) => { e.preventDefault(); startRecording(); };
            const handleRecStop = (e) => { e.preventDefault(); stopRecording(); };
            recBtn.addEventListener('mousedown', handleRecStart); recBtn.addEventListener('mouseup', handleRecStop);
            recBtn.addEventListener('touchstart', handleRecStart); recBtn.addEventListener('touchend', handleRecStop);
            
            window.onbeforeunload = function () { if (isDirty) return "æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´"; };
        }

        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices();
            if (availableVoices.length === 0) return;
            cantoneseVoice = availableVoices.find(v => v.lang === 'zh-HK' && v.name.includes('Google')) || availableVoices.find(v => v.lang === 'zh-HK');
            englishVoice = availableVoices.find(v => v.name.includes('Moira')) || availableVoices.find(v => v.lang.startsWith('en'));
        }

        function isEnglish(text) { return /^[A-Za-z0-9\s\.,\?!'"]+$/.test(text); }

        function pickNextIndexRandom(allowSameAsCurrent = false) {
            if (words.length === 0) return 0;
            let candidates = [];
            for (let i = 0; i < words.length; i++) {
                if (words[i].roundId !== currentRoundId) candidates.push(i);
            }
            if (candidates.length === 0) {
                currentRoundId++;
                candidates = words.map((_, i) => i);
            }
            if (!allowSameAsCurrent && words.length > 1) {
                candidates = candidates.filter(i => i !== currentIndex);
                if (candidates.length === 0) candidates = [currentIndex];
            }
            const idx = candidates[Math.floor(Math.random() * candidates.length)];
            words[idx].roundId = currentRoundId;
            return idx;
        }

        function startAutoIfEnabled() { if (document.getElementById('autoPlayNext').checked) startSequence(); }

        function advanceNextForAuto() {
            if (words.length === 0) return;
            if (document.getElementById('randomOrder').checked) currentIndex = pickNextIndexRandom(false);
            else currentIndex = (currentIndex + 1) % words.length;
            updateCard(); startAutoIfEnabled();
        }

        async function manualNext() {
            if (words.length === 0) return;
            await unlockAudioAndSpeech(); stopEverything();
            if (document.getElementById('randomOrder').checked) currentIndex = pickNextIndexRandom(false);
            else currentIndex = (currentIndex + 1) % words.length;
            updateCard(); speakWordFlow();
        }

        async function manualPrev() {
            if (words.length === 0) return;
            await unlockAudioAndSpeech(); stopEverything();
            currentIndex = (currentIndex - 1 + words.length) % words.length;
            updateCard(); speakWordFlow();
        }

        function startRecording() {
            if (words.length === 0 || isRecording) return;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { alert("ä¸æ”¯æ´éŒ„éŸ³"); return; }
            window.speechSynthesis.cancel(); stopEverything();

            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                let options = MediaRecorder.isTypeSupported('audio/webm') ? { mimeType: 'audio/webm' } : {};
                try { mediaRecorder = new MediaRecorder(stream, options); } catch (e) { mediaRecorder = new MediaRecorder(stream); }
                audioChunks = [];
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                mediaRecorder.onstop = () => {
                    const blob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                    words[currentIndex].audioBlob = blob;
                    showToast("éŒ„éŸ³å·²ä¿å­˜ï¼"); markDirty(); renderLists();
                };
                mediaRecorder.start(); isRecording = true;
                document.getElementById('recordBtn').classList.add('recording');
                recordingSeconds = 0; updateRecordingUI();
                recordingTimerInterval = setInterval(() => { recordingSeconds++; updateRecordingUI(); }, 1000);
            }).catch(() => alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨"));
        }

        function updateRecordingUI() {
            const badge = document.getElementById('statusBadge');
            badge.textContent = `ğŸ”´ éŒ„éŸ³ä¸­ (${recordingSeconds}s)...`;
            badge.className = 'status-badge status-recording'; badge.style.opacity = '1';
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            mediaRecorder.stop(); isRecording = false;
            clearInterval(recordingTimerInterval);
            document.getElementById('recordBtn').classList.remove('recording');
            if (mediaRecorder.stream) mediaRecorder.stream.getTracks().forEach(track => track.stop());
            updateStatusUI();
        }

        function stopEverything() {
            clearTimeout(state.timerId); clearInterval(state.timerId); clearTimeout(state.watchdogId);
            window.speechSynthesis.cancel(); globalAudioPlayer.pause();
            state.status = 'idle'; state.repeatCount = 0; updateStatusUI();
        }

        async function toggleSpeak() {
            if (words.length === 0) return;
            await unlockAudioAndSpeech();
            if (state.status === 'paused') resumeFlow();
            else if (state.status === 'countdown' || state.status === 'speaking') pauseFlow();
            else { if (document.getElementById('autoPlayNext').checked) startSequence(); else speakWordFlow(); }
        }

        function pauseFlow() { stopEverything(); state.status = 'paused'; updateStatusUI(); }
        function resumeFlow() { if (state.countdownCallback) runCountdown(state.countdownRemaining, state.countdownLabel, state.countdownCallback); else speakWordFlow(); }

        function startSequence() {
            stopEverything(); if (words.length === 0) return;
            runCountdown(settings.autoDelay, "è©¦ä¸‹è‡ªå·±è®€", () => setTimeout(() => speakWordFlow(), 0));
        }

        function runCountdown(seconds, text, callback) {
            state.status = 'countdown'; state.countdownRemaining = seconds; state.countdownLabel = text; state.countdownCallback = callback;
            updateStatusUI();
            state.timerId = setInterval(() => {
                state.countdownRemaining--;
                if (state.countdownRemaining > 0) updateStatusUI();
                else { clearInterval(state.timerId); state.countdownCallback = null; callback(); }
            }, 1000);
        }

        function speakWordFlow() {
            if (words.length === 0) return;
            state.status = 'speaking'; updateStatusUI();
            if (state.repeatCount === 0) { words[currentIndex].views++; markDirty(); renderLists(); updateCard(); }
            const item = words[currentIndex];
            window.speechSynthesis.cancel(); globalAudioPlayer.pause(); globalAudioPlayer.currentTime = 0;
            clearTimeout(state.watchdogId);
            state.watchdogId = setTimeout(() => handleSpeakEnd(), 10000);

            if (item.audioBlob) {
                const url = URL.createObjectURL(item.audioBlob);
                globalAudioPlayer.src = url; globalAudioPlayer.volume = 1.0;
                globalAudioPlayer.onended = () => { handleSpeakEnd(); URL.revokeObjectURL(url); };
                globalAudioPlayer.play().catch(() => { if (state.repeatCount === 0) speakTTS(item.text); else handleSpeakEnd(); });
            } else speakTTS(item.text);
        }

        function speakTTS(text) {
            const u = new SpeechSynthesisUtterance(text);
            if (isEnglish(text)) { u.lang = 'en-IE'; if (englishVoice) u.voice = englishVoice; u.rate = 0.9; }
            else { u.lang = 'zh-HK'; if (cantoneseVoice) u.voice = cantoneseVoice; u.rate = 0.8; }
            u.onend = u.onerror = () => handleSpeakEnd();
            window.speechSynthesis.speak(u);
        }

        function handleSpeakEnd() {
            clearTimeout(state.watchdogId);
            if (state.status === 'paused') return;
            if (document.getElementById('repeatThreeTimes').checked && state.repeatCount < 2) {
                state.repeatCount++;
                runCountdown(settings.repeatDelay, `æº–å‚™å†è®€ (${state.repeatCount}/2)`, () => speakWordFlow());
            } else {
                state.status = 'idle'; state.repeatCount = 0; updateStatusUI();
                if (document.getElementById('autoPlayNext').checked) state.timerId = setTimeout(() => advanceNextForAuto(), 500);
            }
        }

        function updateStatusUI() {
            const badge = document.getElementById('statusBadge');
            const btn = document.getElementById('speakBtn');
            badge.style.opacity = '0';
            if (state.status === 'paused') {
                btn.innerHTML = "â–¶ï¸ ç¹¼çºŒ"; btn.classList.add('paused');
                badge.textContent = `â¸ å·²æš«åœ`; badge.className = 'status-badge status-paused'; badge.style.opacity = '1';
            } else if (state.status === 'countdown') {
                btn.innerHTML = "â¸ æš«åœ"; btn.classList.add('paused');
                badge.textContent = `${state.countdownLabel} (${state.countdownRemaining})`; badge.className = 'status-badge status-waiting'; badge.style.opacity = '1';
            } else if (state.status === 'speaking') {
                btn.innerHTML = "â¸ æš«åœ"; btn.classList.add('paused');
                badge.textContent = 'ğŸ”Š è½ä¸‹è®€éŸ³'; badge.className = 'status-badge status-reading'; badge.style.opacity = '1';
            } else {
                btn.innerHTML = "ğŸ”Š æœ—è®€"; btn.classList.remove('paused');
            }
        }

        function renderLists() {
            const wordList = document.getElementById('wordList');
            const reviewList = document.getElementById('reviewList');
            const mList = document.getElementById('masteredList');
            document.getElementById('wordCount').textContent = `(${words.length})`;
            document.getElementById('reviewCount').textContent = `(${reviewWords.length})`;
            document.getElementById('masteredCount').textContent = `(${masteredWords.length})`;
            wordList.innerHTML = ''; reviewList.innerHTML = ''; mList.innerHTML = '';

            words.forEach((item, index) => {
                const tag = createTag(item, index, 'word');
                if (index === currentIndex && !isWordSelectMode) tag.classList.add('active');
                wordList.appendChild(tag);
            });

            if (!isWordSelectMode) {
                const addBtn = document.createElement('div'); addBtn.className = 'word-tag add-tag'; addBtn.innerHTML = '<span>+</span>';
                addBtn.onclick = () => convertToAddInput(addBtn);
                wordList.appendChild(addBtn);
            }

            reviewWords.forEach((item, index) => reviewList.appendChild(createTag(item, index, 'review')));
            masteredWords.forEach((item, index) => mList.appendChild(createTag(item, index, 'mastered')));
        }

        function createTag(item, index, type) {
            const div = document.createElement('div'); div.className = 'word-tag';
            const pct = Math.min(100, (item.hits / settings.masteryThreshold) * 100);
            const bg = document.createElement('div'); bg.className = 'word-tag-bg'; bg.style.height = `${pct}%`;
            div.appendChild(bg);
            if (item.audioBlob) { const dot = document.createElement('div'); dot.className = 'has-audio-dot'; div.appendChild(dot); }
            
            const content = document.createElement('div'); content.className = 'word-tag-content';
            const word = item.text;
            if (isEnglish(word)) div.classList.add('is-english');
            const len = word.length;
            if (len <= 2) div.classList.add('len-2'); else if (len === 3) div.classList.add('len-3'); else if (len === 4) div.classList.add('len-4'); else div.classList.add('len-long');
            content.innerHTML = len === 4 && !isEnglish(word) ? `<span><i>${word.substring(0,2)}</i><i>${word.substring(2,4)}</i></span>` : `<span>${word}</span>`;
            div.appendChild(content);
            
            const viewCount = document.createElement('div'); viewCount.className = 'view-count'; viewCount.textContent = item.views;
            div.appendChild(viewCount);
            handleInteraction(div, index, item, type);
            return div;
        }

        function convertToAddInput(element) {
            element.innerHTML = '';
            const input = document.createElement('input'); input.type = 'text'; input.className = 'grid-input'; input.placeholder = 'è¼¸å…¥';
            element.appendChild(input); input.focus();
            const save = () => {
                const val = input.value.trim();
                if (val) { words.push({ text: val, views: 0, hits: 0, audioBlob: null, roundId: 0 }); markDirty(); renderLists(); updateCard(); }
                else renderLists();
            };
            input.addEventListener('blur', save); input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
        }

        // --- äº’å‹•èˆ‡é•·æŒ‰è‡ªå‹•é¸å– ---
        function handleInteraction(div, index, item, type) {
            let isModeActive = (type === 'word' && isWordSelectMode) || (type === 'review' && isReviewMode) || (type === 'mastered' && isDeleteMode);
            
            if (isModeActive) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.className = 'select-checkbox'; checkbox.dataset.index = index;
                div.appendChild(checkbox);
                div.onclick = (e) => { if(e.target !== checkbox) checkbox.checked = !checkbox.checked; };
            } else {
                if (type === 'word') {
                    div.onclick = () => { if (state.status === 'idle' || state.status === 'paused') { currentIndex = index; updateCard(); } };
                }
                let pressTimer;
                const startPress = () => { 
                    pressTimer = setTimeout(() => {
                        if (type === 'word') enterWordSelectMode(index);
                        if (type === 'review') enterReviewMode(index);
                        if (type === 'mastered') enterDeleteMode(index);
                    }, 600); 
                };
                const cancelPress = () => clearTimeout(pressTimer);
                div.addEventListener('touchstart', startPress); div.addEventListener('touchend', cancelPress);
                div.addEventListener('mousedown', startPress); div.addEventListener('mouseup', cancelPress);
            }
        }

        // --- æ¨¡å¼ç®¡ç† ---
        function enterWordSelectMode(initialIndex) { 
            isWordSelectMode = true; document.body.classList.add('select-mode-active'); 
            document.getElementById('wordSelectControls').style.display = 'flex'; 
            renderLists(); 
            if(initialIndex !== undefined) checkItem(initialIndex, '#wordList');
            showToast("æ‰¹é‡æ¨¡å¼ (è©èªè¡¨)"); 
        }
        function exitWordSelectMode() { isWordSelectMode = false; document.body.classList.remove('select-mode-active'); document.getElementById('wordSelectControls').style.display = 'none'; renderLists(); }

        function enterReviewMode(initialIndex) { 
            isReviewMode = true; document.body.classList.add('review-mode-active'); 
            document.getElementById('reviewControls').style.display = 'flex'; 
            renderLists(); 
            if(initialIndex !== undefined) checkItem(initialIndex, '#reviewList');
            showToast("æ‰¹é‡æ¨¡å¼ (é‚„è¦ç·´)"); 
        }
        function exitReviewMode() { isReviewMode = false; document.body.classList.remove('review-mode-active'); document.getElementById('reviewControls').style.display = 'none'; renderLists(); }

        function enterDeleteMode(initialIndex) { 
            isDeleteMode = true; document.body.classList.add('delete-mode-active'); 
            document.getElementById('deleteControls').style.display = 'flex'; 
            renderLists(); 
            if(initialIndex !== undefined) checkItem(initialIndex, '#masteredList');
            showToast("æ‰¹é‡æ¨¡å¼ (å·²å­¸è­˜)"); 
        }
        function exitDeleteMode() { isDeleteMode = false; document.body.classList.remove('delete-mode-active'); document.getElementById('deleteControls').style.display = 'none'; renderLists(); }

        function checkItem(index, selector) {
            const cb = document.querySelector(`${selector} .select-checkbox[data-index="${index}"]`);
            if(cb) cb.checked = true;
        }

        // --- ç§»å‹•é‚è¼¯ ---
        function getSelectedIndices(selector) {
            return Array.from(document.querySelectorAll(`${selector} .select-checkbox:checked`))
                .map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
        }

        function confirmBatchMove() {
            const indices = getSelectedIndices('#wordList'); if (!indices.length) return;
            indices.forEach(idx => { masteredWords.push(words[idx]); words.splice(idx, 1); });
            if (currentIndex >= words.length) currentIndex = 0;
            showToast(`å·²ç§»å‹• ${indices.length} å€‹åˆ°å·²å­¸è­˜`); markDirty(); exitWordSelectMode(); updateCard();
        }
        function confirmBatchMoveFromWordsToReview() {
            const indices = getSelectedIndices('#wordList'); if (!indices.length) return;
            indices.forEach(idx => { reviewWords.push(words[idx]); words.splice(idx, 1); });
            if (currentIndex >= words.length) currentIndex = 0;
            showToast(`å·²ç§»å‹• ${indices.length} å€‹åˆ°é‚„è¦ç·´`); markDirty(); exitWordSelectMode(); updateCard();
        }

        function confirmBatchMoveFromReviewToWords() {
            const indices = getSelectedIndices('#reviewList'); if (!indices.length) return;
            indices.forEach(idx => { let w = reviewWords[idx]; w.views=0; w.hits=0; w.roundId=0; words.push(w); reviewWords.splice(idx, 1); });
            showToast(`å·²é€€å› ${indices.length} å€‹åˆ°è©èªè¡¨`); markDirty(); exitReviewMode(); updateCard();
        }
        function confirmBatchMoveFromReviewToMastered() {
            const indices = getSelectedIndices('#reviewList'); if (!indices.length) return;
            indices.forEach(idx => { masteredWords.push(reviewWords[idx]); reviewWords.splice(idx, 1); });
            showToast(`å·²æ™‰ç´š ${indices.length} å€‹åˆ°å·²å­¸è­˜`); markDirty(); exitReviewMode();
        }

        function confirmBatchDelete() {
            const indices = getSelectedIndices('#masteredList'); if (!indices.length) return;
            indices.forEach(idx => masteredWords.splice(idx, 1));
            showToast(`å·²åˆªé™¤ ${indices.length} å€‹è©èª`); markDirty(); exitDeleteMode();
        }
        function confirmBatchRestore() {
            const indices = getSelectedIndices('#masteredList'); if (!indices.length) return;
            indices.forEach(idx => { let w = masteredWords[idx]; w.views=0; w.hits=0; w.roundId=0; words.push(w); masteredWords.splice(idx, 1); });
            showToast(`å·²é‚„åŸ ${indices.length} å€‹åˆ°è©èªè¡¨`); markDirty(); exitDeleteMode(); updateCard();
        }
        function confirmBatchMoveFromMasteredToReview() {
            const indices = getSelectedIndices('#masteredList'); if (!indices.length) return;
            indices.forEach(idx => { let w = masteredWords[idx]; w.views=0; w.hits=0; reviewWords.push(w); masteredWords.splice(idx, 1); });
            showToast(`å·²ç§»å‹• ${indices.length} å€‹åˆ°é‚„è¦ç·´`); markDirty(); exitDeleteMode();
        }

        function updateCard() {
            const display = document.getElementById('currentWord');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const viewCountDisplay = document.getElementById('cardViewCount');
            const masteryDisplay = document.getElementById('cardMasteryProgress');
            const isRandom = document.getElementById('randomOrder').checked;

            if (words.length === 0) {
                display.textContent = "åŠ å­—å…ˆï¼"; display.style.fontSize = "3rem"; display.classList.remove('en-font');
                document.getElementById('speakBtn').disabled = true; document.getElementById('recordBtn').disabled = true; document.getElementById('masteredBtn').disabled = true;
                progressFill.style.width = `100%`; progressText.textContent = `å…¨éƒ¨å®Œæˆï¼`;
                viewCountDisplay.textContent = ""; masteryDisplay.textContent = "";
                renderLists(); return;
            }

            if (currentIndex >= words.length) currentIndex = 0;
            document.getElementById('speakBtn').disabled = false; document.getElementById('recordBtn').disabled = false; document.getElementById('masteredBtn').disabled = false;
            const item = words[currentIndex];
            if (isRandom && item.roundId !== currentRoundId) item.roundId = currentRoundId;
            display.textContent = item.text;
            if (isEnglish(item.text)) { display.classList.add('en-font'); display.style.fontSize = item.text.length > 8 ? "4rem" : "6rem"; }
            else { display.classList.remove('en-font'); display.style.fontSize = item.text.length > 3 ? "5rem" : "8rem"; }
            
            if (isRandom) {
                const remainingInRound = words.filter(w => w.roundId !== currentRoundId).length;
                progressFill.style.width = '100%'; progressText.textContent = `éš¨æ©Ÿæ¨¡å¼ (æœ¬è¼ªå‰© ${remainingInRound})`;
            } else {
                const pct = ((currentIndex + 1) / words.length) * 100;
                progressFill.style.width = `${pct}%`; progressText.textContent = `${currentIndex + 1} / ${words.length}`;
            }
            viewCountDisplay.textContent = `ğŸ‘‚ ${item.views}`; masteryDisplay.textContent = `ğŸ¯ ${item.hits}/${settings.masteryThreshold}`;
            renderLists();
        }

        function handleMasteryClick(e) {
            if (words.length === 0) return;
            stopEverything();
            const item = words[currentIndex]; item.hits++;
            if (item.hits >= settings.masteryThreshold) {
                words.splice(currentIndex, 1);
                if (item.views > settings.masteryViewLimit) {
                    reviewWords.push(item); showToast(`ğŸ‘ è­˜å’—ï¼Œä½†è¦å¤šç·´ä¸‹ã€Œ${item.text}ã€`);
                } else {
                    masteredWords.push(item); showToast(`ğŸ‰ å¤ªæ£’äº†ï¼è¼•é¬†å­¸è­˜ã€Œ${item.text}ã€`);
                    triggerConfetti(null, null, 1.0);
                }
                if (currentIndex >= words.length) currentIndex = 0;
                markDirty(); renderLists();
                if (words.length > 0) {
                    if (document.getElementById('randomOrder').checked) currentIndex = pickNextIndexRandom(true);
                    updateCard(); startAutoIfEnabled();
                } else updateCard();
            } else {
                const rect = e.target.getBoundingClientRect();
                triggerConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2, 0.4);
                markDirty(); renderLists(); updateCard(); manualNext();
            }
        }

        // --- Settings & Modal ---
        function openSettingsModal() {
            document.getElementById('settingAutoDelay').value = settings.autoDelay;
            document.getElementById('settingRepeatDelay').value = settings.repeatDelay;
            document.getElementById('settingMasteryThreshold').value = settings.masteryThreshold;
            document.getElementById('settingMasteryViewLimit').value = settings.masteryViewLimit;
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function autoSaveSettings() {
            settings.autoDelay = parseInt(document.getElementById('settingAutoDelay').value) || 4;
            settings.repeatDelay = parseInt(document.getElementById('settingRepeatDelay').value) || 3;
            settings.masteryThreshold = parseInt(document.getElementById('settingMasteryThreshold').value) || 2;
            settings.masteryViewLimit = parseInt(document.getElementById('settingMasteryViewLimit').value) || 1;
            markDirty(); updateCard(); showToast("è¨­å®šå·²æ›´æ–°");
        }

        let pendingAction = null;
        function confirmAction(actionType) {
            pendingAction = actionType;
            const msgEl = document.getElementById('confirmMessage');
            const btnEl = document.getElementById('confirmBtn');
            document.getElementById('confirmModal').style.display = 'flex';
            if (actionType === 'resetStats') { msgEl.textContent = "ç¢ºå®šè¦å°‡æ‰€æœ‰è©èªçš„è½è®€æ¬¡æ•¸å’Œç†Ÿç·´åº¦æ­¸é›¶å—ï¼Ÿ"; btnEl.className = "modal-btn btn-save"; btnEl.style.background = "#5c6bc0"; }
            else if (actionType === 'resetSettings') { msgEl.textContent = "ç¢ºå®šè¦é‚„åŸè¨­å®šåˆ°åˆå§‹å€¼å—ï¼Ÿ"; btnEl.className = "modal-btn btn-save"; btnEl.style.background = "#78909c"; }
            else if (actionType === 'clearAudio') { msgEl.textContent = "ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è‡ªè£½éŒ„éŸ³å—ï¼Ÿæ–‡å­—æœƒä¿ç•™ã€‚"; btnEl.className = "modal-btn btn-save"; btnEl.style.background = "#ff9800"; }
        }

        document.getElementById('confirmBtn').onclick = async () => {
            if (!pendingAction) return;
            if (pendingAction === 'resetStats') {
                [words, reviewWords, masteredWords].forEach(list => list.forEach(w => { w.views = 0; w.hits = 0; }));
                markDirty(); renderLists(); updateCard(); showToast("çµ±è¨ˆå·²é‡ç½®");
            } else if (pendingAction === 'resetSettings') {
                settings = { autoDelay: 4, repeatDelay: 3, masteryThreshold: 2, masteryViewLimit: 1 };
                openSettingsModal(); markDirty(); showToast("è¨­å®šå·²é‚„åŸ");
            } else if (pendingAction === 'clearAudio') {
                let count = 0; [words, reviewWords, masteredWords].forEach(list => list.forEach(w => { if(w.audioBlob) { w.audioBlob = null; count++; } }));
                markDirty(); renderLists(); updateCard(); showToast(`å·²æ¸…é™¤ ${count} å€‹éŒ„éŸ³`);
            }
            closeModal('confirmModal'); pendingAction = null;
        };

        function openEditModal() {
            const text = `ã€è©èªè¡¨ã€‘\n${words.map(w=>w.text).join('\n')}\n\nã€é‚„è¦ç·´ã€‘\n${reviewWords.map(w=>w.text).join('\n')}\n\nã€å·²å­¸è­˜ã€‘\n${masteredWords.map(w=>w.text).join('\n')}`;
            document.getElementById('importTextarea').value = text;
            document.getElementById('importModal').style.display = 'flex';
        }

        function selectAllImportText() { document.getElementById('importTextarea').select(); showToast("å·²å…¨é¸ï¼Œè«‹ç›´æ¥è²¼ä¸Š"); }

        function saveEdit() {
            const raw = document.getElementById('importTextarea').value;
            if (!raw.trim()) { closeModal('importModal'); return; }
            let currentSection = 'words';
            const newWords = [], newReview = [], newMastered = [];
            raw.split('\n').forEach(line => {
                line = line.trim(); if (!line) return;
                if (line.includes('ã€è©èªè¡¨ã€‘')) { currentSection = 'words'; return; }
                if (line.includes('ã€é‚„è¦ç·´ã€‘')) { currentSection = 'review'; return; }
                if (line.includes('ã€å·²å­¸è­˜ã€‘')) { currentSection = 'mastered'; return; }
                line.split(/[,ï¼Œ]+/).map(w => w.trim()).filter(w => w).forEach(w => {
                    const obj = { text: w, views: 0, hits: 0, audioBlob: null, roundId: 0 };
                    if (currentSection === 'words') newWords.push(obj);
                    else if (currentSection === 'review') newReview.push(obj);
                    else newMastered.push(obj);
                });
            });
            words = newWords; reviewWords = newReview; masteredWords = newMastered;
            currentRoundId = 1; currentIndex = 0;
            markDirty(); renderLists(); updateCard();
            closeModal('importModal'); showToast("å·²æ›´æ–°åˆ—è¡¨");
        }

        function exportData() {
            const text = `ã€è©èªè¡¨ã€‘\n${words.map(w=>w.text).join('\n')}\n\nã€é‚„è¦ç·´ã€‘\n${reviewWords.map(w=>w.text).join('\n')}\n\nã€å·²å­¸è­˜ã€‘\n${masteredWords.map(w=>w.text).join('\n')}`;
            navigator.clipboard.writeText(text).then(() => showToast("å·²è¤‡è£½æ–‡å­—ï¼")).catch(() => showToast("è¤‡è£½å¤±æ•—"));
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2500); }

        function triggerConfetti(originX, originY, intensity) {
            const canvas = document.getElementById('confetti-canvas'); const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particles = []; const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#9c27b0', '#ff9800'];
            for (let i = 0; i < Math.floor(150 * intensity); i++) {
                const isBurst = originX != null;
                particles.push({
                    x: isBurst ? originX : Math.random() * canvas.width, y: isBurst ? originY : Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 10 + 5, h: Math.random() * 5 + 5, color: colors[Math.floor(Math.random() * colors.length)],
                    vy: isBurst ? (Math.random() * -15 - 5) : (Math.random() * 3 + 2), vx: isBurst ? (Math.random() * 10 - 5) : (Math.random() * 2 - 1),
                    gravity: isBurst ? 0.5 : 0, r: Math.random() * 360, vr: Math.random() * 10 - 5
                });
            }
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height); let active = false;
                particles.forEach(p => {
                    p.vy += p.gravity; p.y += p.vy; p.x += p.vx; p.r += p.vr;
                    if (p.y < canvas.height) {
                        active = true; ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r * Math.PI / 180);
                        ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                    }
                });
                if (active) requestAnimationFrame(animate);
            }
            animate();
        }

        window.onload = init;
    </script>
</body>
</html>
