<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸­è‹±é–ƒå¡ v3.7 (Moiraç‰ˆ)</title>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;700;900&family=Noto+Serif+HK:wght@500;700;900&family=Nunito:wght@600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #e0f7fa;
            --bg-secondary: #ffffff;
            --text-primary: #37474f;
            --text-secondary: #78909c;
            
            --accent: #ff7043;
            --btn-speak: #42a5f5;
            --btn-record: #ef5350;
            --btn-pause: #ffca28;
            --btn-pause-text: #37474f;
            --btn-master: #66bb6a;
            --danger: #ef5350;
            --import-btn: #fdd835;
            --reset-btn: #78909c;
            
            --card-border: #b2ebf2;
            --font-ui: 'M PLUS Rounded 1c', sans-serif;
            --font-learn-zh: 'Kaiti TC', 'STKaiti', 'BiaoKai', 'Noto Serif HK', serif;
            --font-learn-en: 'Nunito', sans-serif;
            
            --progress-color: #c8e6c9;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }

        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }

        /* --- ä½ˆå±€ç³»çµ± --- */
        .main-layout {
            display: flex; gap: 20px; height: 100%; width: 100%;
            position: relative; z-index: 10;
            overflow: hidden;
        }

        .sidebar {
            flex: 0 0 380px;
            display: flex; flex-direction: column; gap: 10px;
            height: 100%; 
            min-height: 0;
        }

        .learning-area {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            justify-content: center; height: 100%; position: relative;
            background: rgba(255,255,255,0.3); border-radius: 24px; padding: 10px;
            min-width: 0;
        }

        .panel {
            background: var(--bg-secondary); 
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); border: 2px solid var(--card-border);
            display: flex; flex-direction: column; 
            overflow: hidden;
        }
        
        .panel-header {
            padding: 8px 12px; background: #fff; z-index: 5;
            border-bottom: 1px solid #eee; flex-shrink: 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .panel-body {
            flex: 1; overflow-y: auto; padding: 8px;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }

        .panel-words { flex: 3; min-height: 0; }     
        .panel-review { flex: 2; border-color: #ffe0b2; background-color: #fff3e0; min-height: 0; }
        .panel-review .panel-header { background-color: #fff3e0; border-bottom-color: #ffe0b2; }
        
        .panel-mastered { flex: 2; border-color: #a5d6a7; background-color: #f1f8e9; min-height: 0; }  
        .panel-mastered .panel-header { background-color: #f1f8e9; border-bottom-color: #dcedc8; }

        .panel-title {
            font-size: 1.0rem; color: var(--text-primary); font-weight: 800;
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }

        .word-grid {
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 4px;
            align-content: start;
            width: 100%;
        }

        .word-tag {
            background: #f5f5f5; aspect-ratio: 1 / 1; border-radius: 12px;
            border: 2px solid transparent; cursor: pointer; position: relative;
            transition: transform 0.1s, border-color 0.2s;
            display: flex; align-items: center; justify-content: center;
            text-align: center; font-family: var(--font-learn-zh);
            color: #333; font-weight: bold; padding: 2px; overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .word-tag:active { transform: scale(0.95); }
        .word-tag.active { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(255, 112, 67, 0.3); z-index: 2; }
        
        .has-audio-dot {
            position: absolute; top: 4px; right: 4px; width: 8px; height: 8px;
            background-color: var(--btn-record); border-radius: 50%; z-index: 3;
            box-shadow: 0 0 2px rgba(0,0,0,0.3); border: 1px solid white;
        }

        .word-tag-bg {
            position: absolute; bottom: 0; left: 0; width: 100%; background: var(--progress-color);
            z-index: 0; transition: height 0.5s ease; opacity: 0.6; pointer-events: none;
        }
        
        .word-tag-content { position: relative; z-index: 1; width: 100%; pointer-events: none; }
        .word-tag span { line-height: 1.1; width: 100%; display: block; }
        
        /* å­—é«”å¤§å°èª¿æ•´ */
        .len-1 span, .len-2 span { font-size: 1.2rem; }
        .len-3 span { font-size: 0.8rem; }
        .len-4 span { font-size: 0.9rem; display: flex; flex-direction: column; }
        .len-4 span i { font-style: normal; width: 100%; display: block; line-height: 1.0; }
        .len-long span { font-size: 0.7rem; word-break: break-word; }
        
        /* è‹±æ–‡ç‰¹åˆ¥è™•ç† */
        .is-english { font-family: var(--font-learn-en) !important; }
        .is-english.len-1 span, .is-english.len-2 span { font-size: 1.0rem; }
        .is-english.len-long span { font-size: 0.6rem; }

        .view-count {
            position: absolute; bottom: 1px; left: 3px; font-size: 0.55rem;
            color: #78909c; font-family: var(--font-ui); font-weight: 700; z-index: 2;
        }

        .add-tag {
            background: #eceff1; color: #90a4ae; font-size: 2.5rem; border: 2px dashed #cfd8dc;
        }
        .grid-input {
            width: 100%; height: 100%; border: none; background: #fff;
            text-align: center; font-size: 1.2rem; font-family: var(--font-learn-zh);
            outline: none; border-radius: 10px; color: var(--text-primary); padding: 0;
        }

        .progress-container { width: 100%; max-width: 500px; margin-bottom: 10px; text-align: center; flex-shrink: 0; }
        .progress-bar { height: 8px; background: #eceff1; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #ffca28, #ffa000); transition: width 0.3s; }
        .progress-text { font-size: 0.9rem; font-weight: bold; color: var(--text-secondary); margin-top: 5px; }

        .flashcard {
            background: rgba(255, 255, 255, 0.95);
            width: 100%; max-width: 700px; flex: 1; max-height: 50vh;
            border-radius: 24px; border: 4px solid var(--card-border);
            box-shadow: 0 8px 0 rgba(0,0,0,0.05);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin-bottom: 15px; position: relative; z-index: 20;
            min-height: 150px;
        }
        
        .word-display {
            font-size: 8rem; font-weight: 700; color: var(--text-primary);
            text-align: center; line-height: 1.2; font-family: var(--font-learn-zh);
            padding: 10px; width: 100%; word-break: break-word;
        }
        .word-display.en-font { font-family: var(--font-learn-en); font-weight: 800; }

        .status-badge {
            position: absolute; top: 15px; padding: 6px 16px; border-radius: 20px;
            font-weight: bold; font-size: 1.2rem; opacity: 0; transition: opacity 0.2s; pointer-events: none;
        }
        .status-waiting { background: #fff9c4; color: #f9a825; opacity: 1; border: 2px solid #fff59d; }
        .status-reading { background: #e3f2fd; color: #1565c0; opacity: 1; border: 2px solid #bbdefb; }
        .status-recording { background: #ffebee; color: #c62828; opacity: 1; border: 2px solid #ffcdd2; animation: pulse 1.5s infinite; }
        .status-paused { background: #ffe0b2; color: #e65100; opacity: 1; border: 2px solid #ffcc80; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .card-info-bl {
            position: absolute; bottom: 20px; left: 25px;
            font-size: 2rem;
            color: #90a4ae; font-weight: 800;
            display: flex; align-items: center; gap: 5px;
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
        }
        .card-info-br {
            position: absolute; bottom: 20px; right: 25px;
            font-size: 2rem;
            color: #90a4ae; font-weight: 800;
            display: flex; align-items: center; gap: 5px;
            text-shadow: 1px 1px 0 #fff, -1px -1px 0 #fff, 1px -1px 0 #fff, -1px 1px 0 #fff;
        }

        .controls-grid {
            display: grid; grid-template-columns: 1fr 0.4fr 1fr; gap: 10px;
            width: 100%; max-width: 600px; z-index: 20; flex-shrink: 0;
        }

        .big-btn {
            border: none; padding: 14px; border-radius: 18px; font-size: 1.1rem;
            font-weight: 800; cursor: pointer; color: white;
            display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.1s; position: relative; top: 0;
            font-family: var(--font-ui); box-shadow: 0 5px 0 rgba(0,0,0,0.15);
        }
        .big-btn:active { top: 5px; box-shadow: none !important; }
        .big-btn:disabled { background: #cfd8dc !important; box-shadow: none !important; color: #fff; cursor: not-allowed; top: 0; }

        .btn-speak { background: var(--btn-speak); box-shadow: 0 5px 0 #1e88e5; }
        .btn-speak.paused { background: var(--btn-pause); box-shadow: 0 5px 0 #ffb300; color: var(--btn-pause-text); }
        
        .btn-record { background: var(--btn-record); box-shadow: 0 5px 0 #c62828; font-size: 1.5rem; }
        .btn-record.recording { background: #b71c1c; box-shadow: inset 0 0 10px rgba(0,0,0,0.3); top: 5px; }
        
        .btn-master { background: var(--btn-master); box-shadow: 0 5px 0 #43a047; }
        
        .nav-row {
            display: flex; gap: 15px; width: 100%; max-width: 600px; margin-top: 10px;
        }
        .nav-btn {
            flex: 1; background: #fff; color: var(--text-primary); border: 2px solid #cfd8dc;
            box-shadow: 0 5px 0 #b0bec5; font-size: 1rem; padding: 10px;
        }

        .toggles-area {
            margin-top: 10px; display: flex; gap: 15px; background: rgba(255,255,255,0.6);
            padding: 8px 20px; border-radius: 16px; flex-wrap: wrap; justify-content: center; flex-shrink: 0;
        }
        .toggle-item { display: flex; align-items: center; gap: 6px; font-weight: bold; font-size: 0.9rem; cursor: pointer; }
        .toggle-item input { accent-color: var(--accent); width: 20px; height: 20px; }

        .parents-bar {
            margin-top: auto; display: flex; gap: 10px; justify-content: center; padding-top: 10px; flex-shrink: 0;
        }
        .mini-btn {
            padding: 10px 14px; font-size: 0.85rem; border-radius: 10px; border: 1px solid #cfd8dc;
            background: #fff; cursor: pointer; font-weight: bold; color: #546e7a;
        }

        /* Save Status Indicator (Updated) */
        .save-status {
            position: fixed; bottom: 10px; right: 10px; font-size: 0.75rem; 
            background: rgba(255,255,255,0.5); padding: 4px 8px; border-radius: 8px;
            color: #78909c; font-weight: bold; pointer-events: none; z-index: 1000;
            display: flex; align-items: center; gap: 4px; opacity: 0.5;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        /* Modal */
        .custom-modal {
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
            z-index: 3000; align-items: center; justify-content: center; backdrop-filter: blur(4px);
        }
        .modal-content {
            background: white; width: 90%; max-width: 500px; border-radius: 24px;
            padding: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.25);
            text-align: center; display: flex; flex-direction: column; max-height: 85vh;
            overflow-y: auto;
        }
        
        .import-textarea {
            width: 100%; height: 30vh;
            border: 2px solid #cfd8dc; border-radius: 12px;
            padding: 15px; font-size: 1.1rem; resize: none; font-family: var(--font-ui);
            margin: 10px 0;
        }
        
        .modal-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 0.95rem; cursor: pointer; white-space: nowrap;}
        .btn-save { background: var(--accent); color: white; }
        .btn-paste { background: var(--import-btn); color: #333; }
        .btn-no { background: #eceff1; color: #455a64; }
        .btn-reset { background: var(--reset-btn); color: white; width: 100%; margin-top: 10px; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; width: 100%; margin-top: 10px; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 1rem; cursor: pointer; }

        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; text-align: left; border-bottom: 1px solid #eee; padding-bottom: 10px;
            flex-wrap: wrap; gap: 5px;
        }
        .setting-label { flex: 1; padding-right: 10px; font-size: 0.95rem; font-weight: bold; color: #546e7a; min-width: 150px; }
        .setting-input { width: 80px; padding: 8px; border-radius: 10px; border: 1px solid #cfd8dc; text-align: center; font-size: 1.1rem; }
        .setting-input:focus { border-color: var(--accent); outline: none; background: #fff3e0; }
        
        .toast {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85); color: white; padding: 16px 30px;
            border-radius: 40px; font-weight: bold; font-size: 1.1rem; z-index: 4000; opacity: 0; pointer-events: none; transition: opacity 0.3s; text-align: center;
        }

        .select-mode-active .panel-words { border-color: var(--accent); box-shadow: 0 0 0 2px var(--accent) inset; }
        .delete-mode-active .panel-mastered { border-color: var(--danger); box-shadow: 0 0 0 2px var(--danger) inset; }
        .review-mode-active .panel-review { border-color: #ff9800; box-shadow: 0 0 0 2px #ff9800 inset; }
        
        .select-checkbox {
            position: absolute; top: 2px; right: 2px; width: 22px; height: 22px;
            z-index: 10; cursor: pointer;
        }
        .select-mode-active .word-tag, .delete-mode-active .word-tag, .review-mode-active .word-tag { cursor: default; }

        .mode-controls { display: none; gap: 5px; align-items: center; }
        .mode-btn { padding: 4px 8px; border-radius: 6px; border: none; font-size: 0.7rem; font-weight: bold; cursor: pointer; color: white; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 2500; }

        @media (orientation: portrait) {
            .main-layout { flex-direction: column; gap: 10px; }
            .sidebar { flex: none; height: 50%; width: 100%; }
            .learning-area { height: 50%; border-radius: 24px 24px 0 0; }
            .word-grid { grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); }
            .flashcard { max-height: 30vh; }
            .word-display { font-size: 6rem; }
            .controls-grid { margin-bottom: 5px; }
            .card-info-bl, .card-info-br { font-size: 1.5rem; bottom: 10px; }
        }

        @media (max-width: 600px) {
            .word-display { font-size: 4rem; }
            .big-btn { font-size: 0.9rem; padding: 10px; }
            .sidebar { height: 45%; }
            .learning-area { height: 55%; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="main-layout">
        <div class="sidebar">
            <!-- è©èªè¡¨ -->
            <div class="panel panel-words">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ“– è©èªè¡¨ <small id="wordCount">(0)</small></span>
                        <div id="wordSelectControls" class="mode-controls">
                            <button class="mode-btn" style="background:#90a4ae" onclick="toggleSelectAll('word')">å…¨é¸</button>
                            <button class="mode-btn" style="background:var(--btn-master)" onclick="confirmBatchMove()">ç§»è‡³å·²å­¸è­˜</button>
                            <button class="mode-btn" style="background:#cfd8dc; color:#555" onclick="exitWordSelectMode()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="word-grid" id="wordList"></div>
                </div>
            </div>

            <!-- é‚„è¦ç·´ -->
            <div class="panel panel-review">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ’ª é‚„è¦ç·´ <small id="reviewCount">(0)</small></span>
                        <div id="reviewControls" class="mode-controls">
                            <button class="mode-btn" style="background:#90a4ae" onclick="toggleSelectAll('review')">å…¨é¸</button>
                            <button class="mode-btn" style="background:var(--btn-speak)" onclick="confirmBatchMoveFromReviewToWords()">é€€å›</button>
                            <button class="mode-btn" style="background:var(--btn-master)" onclick="confirmBatchMoveFromReviewToMastered()">æ™‰ç´š</button>
                            <button class="mode-btn" style="background:#cfd8dc; color:#555" onclick="exitReviewMode()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="word-grid" id="reviewList"></div>
                </div>
            </div>

            <!-- å·²å­¸è­˜ -->
            <div class="panel panel-mastered">
                <div class="panel-header">
                    <div class="panel-title">
                        <span>ğŸ† å·²å­¸è­˜ <small id="masteredCount">(0)</small></span>
                        <div id="deleteControls" class="mode-controls">
                            <button class="mode-btn" style="background:#90a4ae" onclick="toggleSelectAll('mastered')">å…¨é¸</button>
                            <button class="mode-btn" style="background:var(--btn-speak)" onclick="confirmBatchRestore()">é‚„åŸ</button>
                            <button class="mode-btn" style="background:var(--danger)" onclick="confirmBatchDelete()">åˆªé™¤</button>
                            <button class="mode-btn" style="background:#cfd8dc; color:#555" onclick="exitDeleteMode()">å–æ¶ˆ</button>
                        </div>
                    </div>
                </div>
                <div class="panel-body">
                    <div class="word-grid" id="masteredList"></div>
                    <div style="text-align:center; font-size:0.75rem; color:#90a4ae; margin-top:8px;">(é•·æŒ‰ç®¡ç†)</div>
                </div>
            </div>

            <div class="parents-bar">
                <button class="mini-btn" onclick="openEditModal()">ğŸ“ ç·¨è¼¯/å°å…¥</button>
                <button class="mini-btn" onclick="exportData()">ğŸ“¤ å°å‡º</button>
                <button class="mini-btn" onclick="openSettingsModal()">âš™ï¸ è¨­å®š</button>
            </div>
        </div>

        <div class="learning-area">
            <div class="progress-container">
                <div class="progress-bar"><div id="progressFill" class="progress-fill" style="width: 0%"></div></div>
                <div class="progress-text" id="progressText">æº–å‚™é–‹å§‹</div>
            </div>

            <div class="flashcard" id="flashcard">
                <div class="status-badge" id="statusBadge">ğŸ‘€ æº–å‚™</div>
                <div class="word-display" id="currentWord">...</div>
                
                <!-- å·¦ä¸‹è§’ï¼šè½è®€æ¬¡æ•¸ -->
                <div class="card-info-bl" id="cardViewCount">ğŸ‘‚ 0</div>
                <!-- å³ä¸‹è§’ï¼šé–€æª»é€²åº¦ -->
                <div class="card-info-br" id="cardMasteryProgress">ğŸ¯ 0/2</div>
            </div>

            <div class="controls-grid">
                <button class="big-btn btn-speak" id="speakBtn" onclick="toggleSpeak()">
                    ğŸ”Š æœ—è®€
                </button>
                
                <!-- éŒ„éŸ³æŒ‰éˆ• -->
                <button class="big-btn btn-record" id="recordBtn">
                    ğŸ¤
                </button>

                <button class="big-btn btn-master" id="masteredBtn" onclick="handleMasteryClick(event)">
                    âœ… æˆ‘è­˜å’—å–‡ï¼
                </button>
            </div>
            
            <div class="nav-row">
                <button class="big-btn nav-btn" id="prevBtn" onclick="previousWord()">ğŸ‘ˆ ä¸Šä¸€å€‹</button>
                <button class="big-btn nav-btn" id="nextBtn" onclick="nextWord()">ä¸‹ä¸€å€‹ ğŸ‘‰</button>
            </div>

            <div class="toggles-area">
                <label class="toggle-item">
                    <input type="checkbox" id="autoPlayNext">
                    â–¶ï¸ è‡ªå‹•æ¨¡å¼
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="repeatThreeTimes">
                    ğŸ” è®€ä¸‰æ¬¡
                </label>
                <label class="toggle-item">
                    <input type="checkbox" id="randomOrder">
                    ğŸ”€ æ´—ç‰Œæ¨¡å¼
                </label>
            </div>
        </div>
    </div>

    <div id="saveStatus" class="save-status">â˜ï¸ æº–å‚™ä¸­...</div>
    <div id="toast" class="toast">æç¤ºè¨Šæ¯</div>

    <!-- ç·¨è¼¯è¦–çª— -->
    <div id="importModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">ğŸ“ ç·¨è¼¯/å°å…¥</div>
            <p style="font-size:0.9rem; color:#666; margin-bottom:5px;">ç›´æ¥ä¿®æ”¹æˆ–ç”±å‰ªè²¼ç°¿å°å…¥ã€‚</p>
            <textarea id="importTextarea" class="import-textarea"></textarea>
            <div class="modal-actions">
                <button class="modal-btn btn-paste" onclick="selectAllImportText()">âœ¨ å…¨é¸ (æ–¹ä¾¿è²¼ä¸Š)</button>
                <button class="modal-btn btn-save" onclick="saveEdit()">ğŸ’¾ ä¿å­˜</button>
                <button class="modal-btn btn-no" onclick="closeModal('importModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <!-- è¨­å®šè¦–çª— -->
    <div id="settingsModal" class="custom-modal">
        <div class="modal-content">
            <div class="modal-title">âš™ï¸ è¨­å®š</div>
            
            <div class="setting-row">
                <div class="setting-label">è‡ªå‹•æ¨¡å¼å€’æ•¸ (ç§’)</div>
                <input type="number" id="settingAutoDelay" class="setting-input" value="4" min="1" max="10" onchange="autoSaveSettings()" onfocus="this.select()">
            </div>
            
            <div class="setting-row">
                <div class="setting-label">é‡è¤‡æœ—è®€é–“éš” (ç§’)</div>
                <input type="number" id="settingRepeatDelay" class="setting-input" value="3" min="1" max="5" onchange="autoSaveSettings()" onfocus="this.select()">
            </div>

            <div class="setting-row">
                <div class="setting-label">ã€Œæˆ‘è­˜å’—å–‡ã€é–€æª» (æ¬¡)</div>
                <input type="number" id="settingMasteryThreshold" class="setting-input" value="2" min="1" max="20" onchange="autoSaveSettings()" onfocus="this.select()">
            </div>

            <div class="setting-row">
                <div class="setting-label">ã€Œç†Ÿç·´åº¦åˆ¤æ–·ã€è½è®€æ¬¡æ•¸ä¸Šé™<br><small style="font-weight:normal; color:#90a4ae">(å°‘éæ­¤æ•¸å»å·²å­¸è­˜ï¼Œå¤šéå‰‡å»é‚„è¦ç·´)</small></div>
                <input type="number" id="settingMasteryViewLimit" class="setting-input" value="1" min="1" max="50" onchange="autoSaveSettings()" onfocus="this.select()">
            </div>

            <button class="btn-reset" onclick="openConfirmModal()">ğŸ”„ é‡ç½®æ‰€æœ‰å­¸ç¿’çµ±è¨ˆ</button>
            <button class="btn-reset" style="background:#90a4ae" onclick="resetSettings()">â†©ï¸ é‚„åŸåˆå§‹è¨­å®š (4, 3, 2, 1)</button>
            <button class="btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™ (åŒ…æ‹¬éŒ„éŸ³)</button>

            <div class="modal-actions" style="margin-top: 20px;">
                <button class="modal-btn btn-no" onclick="closeModal('settingsModal')">é—œé–‰</button>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªè¦–çª— -->
    <div id="confirmModal" class="custom-modal" style="z-index: 3500;">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-title" style="font-size: 1.2rem; margin-bottom: 10px;">âš ï¸ ç¢ºèªé‡ç½®</div>
            <p style="color: #555; margin-bottom: 20px;">ç¢ºå®šè¦å°‡æ‰€æœ‰è©èªçš„è½è®€æ¬¡æ•¸å’Œç†Ÿç·´åº¦æ­¸é›¶å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚</p>
            <div class="modal-actions">
                <button class="modal-btn btn-reset" style="margin-top:0" onclick="executeReset()">ç¢ºå®šé‡ç½®</button>
                <button class="modal-btn btn-no" onclick="closeModal('confirmModal')">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <script>
        let words = [];
        let reviewWords = [];
        let masteredWords = [];
        
        // é è¨­è³‡æ–™
        const initialWords = ["éƒ½æ˜¯", "Apple", "é€™å€‹", "Banana", "åˆæˆ", "Orange", "å…±æœ‰"];
        const initialReview = [];
        const initialMastered = ["å’Œ", "é«˜", "Cat"];

        let currentIndex = 0;
        let cantoneseVoice = null;
        let englishVoice = null;
        let availableVoices = [];
        
        // éŒ„éŸ³ç›¸é—œ
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimerInterval = null;
        let recordingSeconds = 0;
        let globalAudioPlayer = new Audio();
        
        let state = {
            status: 'idle',
            timerId: null,
            countdownRemaining: 0,
            countdownCallback: null,
            countdownLabel: '',
            repeatCount: 0
        };
        
        let shuffleDeck = [];
        let isDeleteMode = false;
        let isWordSelectMode = false;
        let isReviewMode = false;
        
        // æ›´æ–°é è¨­è¨­å®š
        let settings = {
            autoDelay: 4,
            repeatDelay: 3,
            masteryThreshold: 2,
            masteryViewLimit: 1
        };

        // --- IndexedDB ç³»çµ± ---
        const DB_NAME = 'FlashcardDB_v3.7'; // å‡ç´š DB åç¨±ä»¥é˜²è¡çª
        const DB_VERSION = 1;
        let db = null;
        let isDirty = false;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => { console.error("Database error", event); reject(event.target.error); };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('data')) db.createObjectStore('data', { keyPath: 'id' });
                };
                request.onsuccess = (event) => { db = event.target.result; resolve(db); };
            });
        }

        async function loadDataFromDB() {
            if (!db) return false;
            return new Promise((resolve) => {
                const transaction = db.transaction(['data'], 'readonly');
                const store = transaction.objectStore('data');
                const getWords = store.get('words');
                const getReview = store.get('review');
                const getMastered = store.get('mastered');
                const getSettings = store.get('settings');

                transaction.oncomplete = () => {
                    if (getWords.result) words = getWords.result.value;
                    else words = initialWords.map(w => ({ text: w, views: 0, hits: 0, audioBlob: null }));

                    if (getReview.result) reviewWords = getReview.result.value;
                    else reviewWords = initialReview.map(w => ({ text: w, views: 0, hits: 0, audioBlob: null }));

                    if (getMastered.result) masteredWords = getMastered.result.value;
                    else masteredWords = initialMastered.map(w => ({ text: w, views: 0, hits: 0, audioBlob: null }));

                    if (getSettings.result) {
                        // åˆä½µè¨­å®šï¼Œé˜²æ­¢èˆŠè³‡æ–™è¦†è“‹æ–°æ¬„ä½
                        settings = { ...settings, ...getSettings.result.value };
                    }
                    resolve(true);
                };
                transaction.onerror = () => resolve(false);
            });
        }

        async function saveDataToDB() {
            if (!db) return;
            updateSaveStatus('saving');
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['data'], 'readwrite');
                const store = transaction.objectStore('data');
                store.put({ id: 'words', value: words });
                store.put({ id: 'review', value: reviewWords });
                store.put({ id: 'mastered', value: masteredWords });
                store.put({ id: 'settings', value: settings });
                transaction.oncomplete = () => { updateSaveStatus('saved'); isDirty = false; resolve(); };
                transaction.onerror = (e) => { updateSaveStatus('error'); reject(e); };
            });
        }

        function updateSaveStatus(status) {
            const el = document.getElementById('saveStatus');
            if (status === 'saving') { el.textContent = 'ğŸ’¾ å„²å­˜ä¸­...'; el.style.color = '#ffa000'; }
            else if (status === 'saved') { el.textContent = 'â˜ï¸ å·²å„²å­˜'; el.style.color = '#4caf50'; }
            else if (status === 'error') { el.textContent = 'âš ï¸ å„²å­˜å¤±æ•—'; el.style.color = '#f44336'; }
        }

        function markDirty() { isDirty = true; updateSaveStatus('saving'); }

        // --- åˆå§‹åŒ– ---
        async function init() {
            try {
                await initDB();
                await loadDataFromDB();
                updateSaveStatus('saved');
            } catch (e) {
                console.error("DB Init failed", e);
                alert("ç„¡æ³•å•Ÿå‹•è³‡æ–™åº«ï¼Œæ‚¨çš„é€²åº¦å¯èƒ½ç„¡æ³•å„²å­˜ã€‚");
            }

            renderLists();
            updateCard();
            
            if ('speechSynthesis' in window) {
                // iOS éœ€è¦æ™‚é–“åŠ è¼‰èªéŸ³
                window.speechSynthesis.onvoiceschanged = () => {
                    loadVoices();
                };
                loadVoices(); // å˜—è©¦ç«‹å³åŠ è¼‰
            }

            document.getElementById('autoPlayNext').addEventListener('change', (e) => {
                if (!e.target.checked) stopEverything();
                else if (words.length > 0) startSequence();
            });
            
            document.getElementById('randomOrder').addEventListener('change', () => { shuffleDeck = []; });

            const recBtn = document.getElementById('recordBtn');
            recBtn.addEventListener('mousedown', (e) => { e.preventDefault(); startRecording(); });
            recBtn.addEventListener('mouseup', (e) => { e.preventDefault(); stopRecording(); });
            recBtn.addEventListener('touchstart', (e) => { e.preventDefault(); startRecording(); });
            recBtn.addEventListener('touchend', (e) => { e.preventDefault(); stopRecording(); });
            recBtn.addEventListener('mouseleave', (e) => { if(isRecording) stopRecording(); });

            setInterval(() => { if (isDirty) saveDataToDB(); }, 5000);
            window.onbeforeunload = function (e) { if (isDirty) { saveDataToDB(); return "æ‚¨æœ‰æœªå„²å­˜çš„è®Šæ›´"; } };
        }

        function loadVoices() {
            availableVoices = window.speechSynthesis.getVoices();
            if (availableVoices.length === 0) return;

            // å»£æ±è©± (å„ªå…ˆ Google)
            cantoneseVoice = availableVoices.find(v => v.lang === 'zh-HK' && v.name.includes('Google')) || 
                             availableVoices.find(v => v.lang === 'zh-HK');
            
            // é–å®š Moira (en-IE)
            englishVoice = availableVoices.find(v => v.name.includes('Moira')) ||
                           availableVoices.find(v => v.lang === 'en-IE') ||
                           availableVoices.find(v => v.lang === 'en-GB' && v.name.includes('Female')) ||
                           availableVoices.find(v => v.lang === 'en-GB');
        }

        function isEnglish(text) {
            return /^[A-Za-z0-9\s\.,\?!'"]+$/.test(text);
        }

        // --- éŒ„éŸ³åŠŸèƒ½ ---
        function startRecording() {
            if (words.length === 0) return;
            if (isRecording) return;
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("âš ï¸ éŒ„éŸ³åŠŸèƒ½ç„¡æ³•å•Ÿå‹•ï¼è«‹ç¢ºä¿ä½¿ç”¨ HTTPS æˆ– Localhostã€‚");
                return;
            }
            window.speechSynthesis.cancel();
            stopEverything();

            let options = { mimeType: 'audio/webm' };
            if (MediaRecorder.isTypeSupported('audio/mp4')) options = { mimeType: 'audio/mp4' }; 
            else if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) options = { mimeType: 'audio/webm;codecs=opus' };

            navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                try { mediaRecorder = new MediaRecorder(stream, options); } 
                catch (e) { mediaRecorder = new MediaRecorder(stream); }

                audioChunks = [];
                mediaRecorder.ondataavailable = event => { if (event.data.size > 0) audioChunks.push(event.data); };
                
                mediaRecorder.onstop = () => {
                    const blobType = mediaRecorder.mimeType || 'audio/webm';
                    const audioBlob = new Blob(audioChunks, { type: blobType });
                    words[currentIndex].audioBlob = audioBlob;
                    showToast("éŒ„éŸ³å·²ä¿å­˜ï¼");
                    markDirty(); saveDataToDB(); renderLists();
                };

                mediaRecorder.start();
                isRecording = true;
                document.getElementById('recordBtn').classList.add('recording');
                recordingSeconds = 0;
                updateRecordingUI();
                recordingTimerInterval = setInterval(() => { recordingSeconds++; updateRecordingUI(); }, 1000);
            }).catch(err => { console.error("éŒ„éŸ³éŒ¯èª¤:", err); alert("ç„¡æ³•å­˜å–éº¥å…‹é¢¨ã€‚"); });
        }

        function updateRecordingUI() {
            const badge = document.getElementById('statusBadge');
            badge.textContent = `ğŸ”´ éŒ„éŸ³ä¸­ (${recordingSeconds}s)...`;
            badge.className = 'status-badge status-recording';
            badge.style.opacity = '1';
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            mediaRecorder.stop();
            isRecording = false;
            clearInterval(recordingTimerInterval);
            document.getElementById('recordBtn').classList.remove('recording');
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            updateStatusUI();
        }

        function stopEverything() {
            clearTimeout(state.timerId);
            clearInterval(state.timerId);
            window.speechSynthesis.cancel();
            globalAudioPlayer.pause();
            state.status = 'idle';
            state.repeatCount = 0;
            updateStatusUI();
        }

        function toggleSpeak() {
            if (words.length === 0) return;
            if (state.status === 'paused') resumeFlow();
            else if (state.status === 'countdown' || state.status === 'speaking') pauseFlow();
            else {
                if (document.getElementById('autoPlayNext').checked) startSequence();
                else speakWordFlow();
            }
        }

        function pauseFlow() {
            clearInterval(state.timerId);
            clearTimeout(state.timerId);
            window.speechSynthesis.cancel();
            globalAudioPlayer.pause();
            state.status = 'paused';
            updateStatusUI();
        }

        function resumeFlow() {
            if (state.countdownCallback) {
                state.status = 'countdown';
                runCountdown(state.countdownRemaining, state.countdownLabel, state.countdownCallback);
            } else speakWordFlow();
            updateStatusUI();
        }

        function startSequence() {
            stopEverything();
            state.repeatCount = 0;
            runCountdown(settings.autoDelay, "è©¦ä¸‹è‡ªå·±è®€", () => { speakWordFlow(); });
        }

        function runCountdown(seconds, text, callback) {
            state.status = 'countdown';
            state.countdownRemaining = seconds;
            state.countdownLabel = text;
            state.countdownCallback = callback;
            updateStatusUI();
            state.timerId = setInterval(() => {
                state.countdownRemaining--;
                if (state.countdownRemaining > 0) updateStatusUI();
                else {
                    clearInterval(state.timerId);
                    state.countdownCallback = null;
                    callback();
                }
            }, 1000);
        }

        function speakWordFlow() {
            if (words.length === 0) return;
            
            state.status = 'speaking';
            state.countdownCallback = null;
            updateStatusUI();

            if (state.repeatCount === 0) {
                words[currentIndex].views++;
                markDirty(); renderLists(); updateCard();
            }

            const currentItem = words[currentIndex];

            // --- éŸ³é‡ä¿®å¾©é—œéµæ­¥é©Ÿ ---
            window.speechSynthesis.cancel(); // 1. å¼·åˆ¶åœæ­¢ TTS
            globalAudioPlayer.pause();       // 2. å¼·åˆ¶åœæ­¢ Audio
            globalAudioPlayer.currentTime = 0;

            if (currentItem.audioBlob) {
                const audioUrl = URL.createObjectURL(currentItem.audioBlob);
                globalAudioPlayer.src = audioUrl;
                globalAudioPlayer.load();
                globalAudioPlayer.volume = 1.0; // 3. å¼·åˆ¶é‡ç½®éŸ³é‡

                globalAudioPlayer.onended = () => {
                    handleSpeakEnd();
                    URL.revokeObjectURL(audioUrl);
                };
                
                // 4. åŠ å…¥å¾®å°å»¶é²ï¼Œè®“ç€è¦½å™¨æœ‰æ™‚é–“é‡‹æ”¾ TTS è²é“
                setTimeout(() => {
                    const playPromise = globalAudioPlayer.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.error("æ’­æ”¾éŒ„éŸ³å¤±æ•—:", error);
                            if (state.repeatCount === 0) speakTTS(currentItem.text);
                            else handleSpeakEnd();
                        });
                    }
                }, 50); // 50ms å»¶é²

            } else {
                speakTTS(currentItem.text);
            }
        }

        function speakTTS(text) {
            const u = new SpeechSynthesisUtterance(text);
            
            if (isEnglish(text)) {
                u.lang = 'en-IE'; // å„ªå…ˆæ„›çˆ¾è˜­
                if (englishVoice) u.voice = englishVoice;
                u.rate = 0.9; // è‹±æ–‡ç¨å¾®æ…¢ä¸€é»é»æ›´è‡ªç„¶
            } else {
                u.lang = 'zh-HK';
                if (cantoneseVoice) u.voice = cantoneseVoice;
                u.rate = 0.8;
            }
            
            u.onend = () => handleSpeakEnd();
            window.speechSynthesis.speak(u);
        }

        function handleSpeakEnd() {
            if (state.status === 'paused') return;
            const repeatThree = document.getElementById('repeatThreeTimes').checked;
            
            if (repeatThree && state.repeatCount < 2) {
                state.repeatCount++;
                runCountdown(settings.repeatDelay, "æº–å‚™å†è®€", () => { speakWordFlow(); });
            } else {
                state.status = 'idle';
                state.repeatCount = 0;
                updateStatusUI();
                if (document.getElementById('autoPlayNext').checked) {
                    state.timerId = setTimeout(nextWord, 1000);
                }
            }
        }

        function updateStatusUI() {
            const badge = document.getElementById('statusBadge');
            const btn = document.getElementById('speakBtn');
            badge.className = 'status-badge';
            badge.style.opacity = '0';
            
            if (state.status === 'paused') {
                btn.innerHTML = "â–¶ï¸ ç¹¼çºŒ"; btn.classList.add('paused');
                badge.textContent = `â¸ å·²æš«åœ`; badge.classList.add('status-paused'); badge.style.opacity = '1';
            } else if (state.status === 'countdown') {
                btn.innerHTML = "â¸ æš«åœ"; btn.classList.add('paused');
                badge.textContent = `${state.countdownLabel} (${state.countdownRemaining})`; badge.classList.add('status-waiting'); badge.style.opacity = '1';
            } else if (state.status === 'speaking') {
                btn.innerHTML = "â¸ æš«åœ"; btn.classList.add('paused');
                badge.textContent = 'ğŸ”Š è½ä¸‹è®€éŸ³'; badge.classList.add('status-reading'); badge.style.opacity = '1';
            } else {
                btn.innerHTML = "ğŸ”Š æœ—è®€"; btn.classList.remove('paused');
            }
        }

        function renderLists() {
            const wordList = document.getElementById('wordList');
            const reviewList = document.getElementById('reviewList');
            const mList = document.getElementById('masteredList');
            
            document.getElementById('wordCount').textContent = `(${words.length})`;
            document.getElementById('reviewCount').textContent = `(${reviewWords.length})`;
            document.getElementById('masteredCount').textContent = `(${masteredWords.length})`;

            wordList.innerHTML = ''; reviewList.innerHTML = ''; mList.innerHTML = '';

            words.forEach((item, index) => {
                const tag = createTag(item, index, 'word');
                if (index === currentIndex && !isWordSelectMode) tag.classList.add('active');
                wordList.appendChild(tag);
            });

            if (!isWordSelectMode) {
                const addBtn = document.createElement('div');
                addBtn.className = 'word-tag add-tag';
                addBtn.innerHTML = '<span>+</span>';
                addBtn.onclick = () => convertToAddInput(addBtn);
                wordList.appendChild(addBtn);
            }

            reviewWords.forEach((item, index) => reviewList.appendChild(createTag(item, index, 'review')));
            masteredWords.forEach((item, index) => mList.appendChild(createTag(item, index, 'mastered')));
        }

        function createTag(item, index, type) {
            const div = document.createElement('div');
            div.className = 'word-tag';
            const word = item.text;
            
            const pct = Math.min(100, (item.hits / settings.masteryThreshold) * 100);
            const bg = document.createElement('div');
            bg.className = 'word-tag-bg';
            bg.style.height = `${pct}%`;
            div.appendChild(bg);

            if (item.audioBlob) {
                const dot = document.createElement('div');
                dot.className = 'has-audio-dot';
                div.appendChild(dot);
            }

            const content = document.createElement('div');
            content.className = 'word-tag-content';
            
            // åˆ¤æ–·æ˜¯å¦è‹±æ–‡ä¸¦çµ¦äºˆæ¨£å¼
            if (isEnglish(word)) div.classList.add('is-english');

            const len = word.length;
            if (len <= 2) div.classList.add('len-2');
            else if (len === 3) div.classList.add('len-3');
            else if (len === 4) div.classList.add('len-4');
            else div.classList.add('len-long');

            content.innerHTML = len === 4 && !isEnglish(word)
                ? `<span><i>${word.substring(0,2)}</i><i>${word.substring(2,4)}</i></span>`
                : `<span>${word}</span>`;
            
            div.appendChild(content);

            const viewCount = document.createElement('div');
            viewCount.className = 'view-count';
            viewCount.textContent = item.views;
            div.appendChild(viewCount);

            handleInteraction(div, index, item, type);
            return div;
        }

        function convertToAddInput(element) {
            element.innerHTML = '';
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'grid-input';
            input.placeholder = 'è¼¸å…¥';
            element.appendChild(input);
            input.focus();
            const save = () => {
                const val = input.value.trim();
                if (val) {
                    words.push({ text: val, views: 0, hits: 0, audioBlob: null });
                    markDirty(); saveDataToDB(); renderLists(); updateCard();
                } else renderLists();
            };
            input.addEventListener('blur', save);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') input.blur(); });
        }

        function handleInteraction(div, index, item, type) {
            let isModeActive = false;
            if (type === 'word') isModeActive = isWordSelectMode;
            if (type === 'review') isModeActive = isReviewMode;
            if (type === 'mastered') isModeActive = isDeleteMode;

            if (isModeActive) {
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox'; checkbox.className = 'select-checkbox'; checkbox.dataset.index = index;
                div.appendChild(checkbox);
                div.onclick = (e) => { if(e.target !== checkbox) checkbox.checked = !checkbox.checked; };
            } else {
                if (type === 'word') {
                    div.onclick = () => {
                        if (state.status === 'idle' || state.status === 'paused') {
                            currentIndex = index; updateCard();
                        }
                    };
                }
                let pressTimer;
                const startPress = () => { pressTimer = setTimeout(() => {
                    if (type === 'word') enterWordSelectMode();
                    if (type === 'review') enterReviewMode();
                    if (type === 'mastered') enterDeleteMode();
                }, 600); };
                const cancelPress = () => clearTimeout(pressTimer);
                div.addEventListener('touchstart', startPress); div.addEventListener('touchend', cancelPress);
                div.addEventListener('mousedown', startPress); div.addEventListener('mouseup', cancelPress);
            }
        }

        function enterWordSelectMode() { isWordSelectMode = true; document.body.classList.add('select-mode-active'); document.getElementById('wordSelectControls').style.display = 'flex'; renderLists(); showToast("å·²é€²å…¥æ‰¹é‡ç§»å‹•æ¨¡å¼"); }
        function exitWordSelectMode() { isWordSelectMode = false; document.body.classList.remove('select-mode-active'); document.getElementById('wordSelectControls').style.display = 'none'; renderLists(); }
        function enterReviewMode() { isReviewMode = true; document.body.classList.add('review-mode-active'); document.getElementById('reviewControls').style.display = 'flex'; renderLists(); showToast("å·²é€²å…¥ç®¡ç†æ¨¡å¼"); }
        function exitReviewMode() { isReviewMode = false; document.body.classList.remove('review-mode-active'); document.getElementById('reviewControls').style.display = 'none'; renderLists(); }
        function enterDeleteMode() { isDeleteMode = true; document.body.classList.add('delete-mode-active'); document.getElementById('deleteControls').style.display = 'flex'; renderLists(); showToast("å·²é€²å…¥ç®¡ç†æ¨¡å¼"); }
        function exitDeleteMode() { isDeleteMode = false; document.body.classList.remove('delete-mode-active'); document.getElementById('deleteControls').style.display = 'none'; renderLists(); }

        function confirmBatchMove() {
            const checkboxes = document.querySelectorAll('#wordList .select-checkbox:checked');
            if (checkboxes.length === 0) return;
            const indices = Array.from(checkboxes).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            indices.forEach(idx => { masteredWords.push(words[idx]); words.splice(idx, 1); });
            if (currentIndex >= words.length) currentIndex = 0;
            showToast(`å·²ç§»å‹• ${indices.length} å€‹åˆ°å·²å­¸è­˜`); markDirty(); exitWordSelectMode(); updateCard();
        }
        function confirmBatchMoveFromReviewToWords() {
            const checkboxes = document.querySelectorAll('#reviewList .select-checkbox:checked');
            if (checkboxes.length === 0) return;
            const indices = Array.from(checkboxes).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            indices.forEach(idx => { let w = reviewWords[idx]; w.views = 0; w.hits = 0; words.push(w); reviewWords.splice(idx, 1); });
            showToast(`å·²é€€å› ${indices.length} å€‹åˆ°è©èªè¡¨`); markDirty(); exitReviewMode(); updateCard();
        }
        function confirmBatchMoveFromReviewToMastered() {
            const checkboxes = document.querySelectorAll('#reviewList .select-checkbox:checked');
            if (checkboxes.length === 0) return;
            const indices = Array.from(checkboxes).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            indices.forEach(idx => { masteredWords.push(reviewWords[idx]); reviewWords.splice(idx, 1); });
            showToast(`å·²æ™‰ç´š ${indices.length} å€‹åˆ°å·²å­¸è­˜`); markDirty(); exitReviewMode();
        }
        function confirmBatchDelete() {
            const checkboxes = document.querySelectorAll('#masteredList .select-checkbox:checked');
            if (checkboxes.length === 0) return;
            const indices = Array.from(checkboxes).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            indices.forEach(idx => masteredWords.splice(idx, 1));
            showToast(`å·²åˆªé™¤ ${indices.length} å€‹è©èª`); markDirty(); exitDeleteMode();
        }
        function confirmBatchRestore() {
            const checkboxes = document.querySelectorAll('#masteredList .select-checkbox:checked');
            if (checkboxes.length === 0) return;
            const indices = Array.from(checkboxes).map(c => parseInt(c.dataset.index)).sort((a,b) => b-a);
            indices.forEach(idx => { let w = masteredWords[idx]; w.views = 0; w.hits = 0; words.push(w); masteredWords.splice(idx, 1); });
            showToast(`å·²é‚„åŸ ${indices.length} å€‹åˆ°è©èªè¡¨`); markDirty(); exitDeleteMode(); updateCard();
        }
        function toggleSelectAll(type) {
            let selector = '';
            if (type === 'word') selector = '#wordList .select-checkbox';
            if (type === 'review') selector = '#reviewList .select-checkbox';
            if (type === 'mastered') selector = '#masteredList .select-checkbox';
            const checkboxes = document.querySelectorAll(selector);
            const allChecked = Array.from(checkboxes).every(c => c.checked);
            checkboxes.forEach(c => c.checked = !allChecked);
        }

        function updateCard() {
            const display = document.getElementById('currentWord');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const viewCountDisplay = document.getElementById('cardViewCount');
            const masteryDisplay = document.getElementById('cardMasteryProgress');
            
            if (words.length === 0) {
                display.textContent = "åŠ å­—å…ˆï¼"; display.style.fontSize = "3rem"; display.classList.remove('en-font');
                document.getElementById('speakBtn').disabled = true; document.getElementById('recordBtn').disabled = true; document.getElementById('masteredBtn').disabled = true;
                progressFill.style.width = `100%`; progressText.textContent = `å…¨éƒ¨å®Œæˆï¼`;
                viewCountDisplay.textContent = ""; masteryDisplay.textContent = "";
                renderLists(); return;
            }

            document.getElementById('speakBtn').disabled = false; document.getElementById('recordBtn').disabled = false; document.getElementById('masteredBtn').disabled = false;
            const item = words[currentIndex];
            display.textContent = item.text;
            
            // è‹±æ–‡é¡¯ç¤ºå„ªåŒ–
            if (isEnglish(item.text)) {
                display.classList.add('en-font');
                display.style.fontSize = item.text.length > 8 ? "4rem" : "6rem";
            } else {
                display.classList.remove('en-font');
                display.style.fontSize = item.text.length > 3 ? "5rem" : "8rem";
            }

            const pct = ((currentIndex + 1) / words.length) * 100;
            progressFill.style.width = `${pct}%`; progressText.textContent = `${currentIndex + 1} / ${words.length}`;
            viewCountDisplay.textContent = `ğŸ‘‚ ${item.views}`;
            masteryDisplay.textContent = `ğŸ¯ ${item.hits}/${settings.masteryThreshold}`;
            renderLists();
        }

        function nextWord() {
            if (words.length === 0) return;
            stopEverything();
            if (document.getElementById('randomOrder').checked) {
                if (shuffleDeck.length === 0) {
                    shuffleDeck = words.map((_, i) => i).filter(i => i !== currentIndex);
                    if (shuffleDeck.length === 0 && words.length > 0) shuffleDeck = [0];
                    for (let i = shuffleDeck.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [shuffleDeck[i], shuffleDeck[j]] = [shuffleDeck[j], shuffleDeck[i]];
                    }
                }
                currentIndex = shuffleDeck.pop();
            } else currentIndex = (currentIndex + 1) % words.length;
            updateCard();
            if (document.getElementById('autoPlayNext').checked) startSequence();
        }

        function previousWord() {
            if (words.length === 0) return;
            stopEverything();
            currentIndex = (currentIndex - 1 + words.length) % words.length;
            updateCard();
        }

        function handleMasteryClick(e) {
            if (words.length === 0) return;
            const item = words[currentIndex];
            item.hits++;
            
            if (item.hits >= settings.masteryThreshold) {
                words.splice(currentIndex, 1);
                if (item.views > settings.masteryViewLimit) {
                    reviewWords.push(item);
                    showToast(`ğŸ‘ è­˜å’—ï¼Œä½†è¦å¤šç·´ä¸‹ã€Œ${item.text}ã€`);
                } else {
                    masteredWords.push(item);
                    showToast(`ğŸ‰ å¤ªæ£’äº†ï¼è¼•é¬†å­¸è­˜ã€Œ${item.text}ã€`);
                    triggerConfetti(null, null, 1.0);
                }
                if (words.length === 0) currentIndex = 0;
                else if (currentIndex >= words.length) currentIndex = 0;
                markDirty(); renderLists(); updateCard();
            } else {
                const rect = e.target.getBoundingClientRect();
                triggerConfetti(rect.left + rect.width / 2, rect.top + rect.height / 2, 0.4);
                markDirty(); renderLists(); updateCard();
            }
        }

        function openSettingsModal() {
            document.getElementById('settingAutoDelay').value = settings.autoDelay;
            document.getElementById('settingRepeatDelay').value = settings.repeatDelay;
            document.getElementById('settingMasteryThreshold').value = settings.masteryThreshold;
            document.getElementById('settingMasteryViewLimit').value = settings.masteryViewLimit;
            
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function autoSaveSettings() {
            settings.autoDelay = parseInt(document.getElementById('settingAutoDelay').value) || 4;
            settings.repeatDelay = parseInt(document.getElementById('settingRepeatDelay').value) || 3;
            settings.masteryThreshold = parseInt(document.getElementById('settingMasteryThreshold').value) || 2;
            settings.masteryViewLimit = parseInt(document.getElementById('settingMasteryViewLimit').value) || 1;
            
            markDirty(); saveDataToDB(); renderLists(); updateCard(); showToast("è¨­å®šå·²æ›´æ–°");
        }

        function resetSettings() {
            settings.autoDelay = 4;
            settings.repeatDelay = 3;
            settings.masteryThreshold = 2;
            settings.masteryViewLimit = 1;
            
            openSettingsModal(); // Refresh UI
            markDirty(); saveDataToDB();
            showToast("è¨­å®šå·²é‚„åŸç‚ºåˆå§‹å€¼");
        }

        function openConfirmModal() { document.getElementById('confirmModal').style.display = 'flex'; }

        function executeReset() {
            words.forEach(w => { w.views = 0; w.hits = 0; });
            reviewWords.forEach(w => { w.views = 0; w.hits = 0; });
            masteredWords.forEach(w => { w.views = 0; w.hits = 0; });
            markDirty(); saveDataToDB(); renderLists(); updateCard();
            closeModal('confirmModal'); closeModal('settingsModal'); showToast("çµ±è¨ˆå·²é‡ç½®");
        }

        function clearAllData() {
            if(confirm("âš ï¸ åš´é‡è­¦å‘Šï¼šé€™æœƒåˆªé™¤æ‰€æœ‰è©èªã€éŒ„éŸ³å’Œé€²åº¦ï¼ç¢ºå®šå—ï¼Ÿ")) {
                words = []; reviewWords = []; masteredWords = [];
                markDirty(); saveDataToDB(); renderLists(); updateCard();
                closeModal('settingsModal'); showToast("æ‰€æœ‰è³‡æ–™å·²æ¸…ç©º");
            }
        }

        function openEditModal() {
            const text = `ã€è©èªè¡¨ã€‘\n${words.map(w=>w.text).join('\n')}\n\nã€é‚„è¦ç·´ã€‘\n${reviewWords.map(w=>w.text).join('\n')}\n\nã€å·²å­¸è­˜ã€‘\n${masteredWords.map(w=>w.text).join('\n')}`;
            document.getElementById('importTextarea').value = text;
            document.getElementById('importModal').style.display = 'flex';
        }

        function selectAllImportText() {
            const textarea = document.getElementById('importTextarea');
            textarea.focus(); textarea.select(); showToast("å·²å…¨é¸ï¼Œè«‹ç›´æ¥è²¼ä¸Š");
        }

        function saveEdit() {
            const raw = document.getElementById('importTextarea').value;
            if (!raw.trim()) { closeModal('importModal'); return; }
            let currentSection = 'words';
            const newWords = [], newReview = [], newMastered = [];
            const lines = raw.split('\n');
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                if (line.includes('ã€è©èªè¡¨ã€‘')) { currentSection = 'words'; return; }
                if (line.includes('ã€é‚„è¦ç·´ã€‘')) { currentSection = 'review'; return; }
                if (line.includes('ã€å·²å­¸è­˜ã€‘')) { currentSection = 'mastered'; return; }
                const items = line.split(/[,ï¼Œ]+/).map(w => w.trim()).filter(w => w);
                items.forEach(w => {
                    const obj = { text: w, views: 0, hits: 0, audioBlob: null };
                    if (currentSection === 'words') newWords.push(obj);
                    else if (currentSection === 'review') newReview.push(obj);
                    else newMastered.push(obj);
                });
            });
            words = newWords; reviewWords = newReview; masteredWords = newMastered;
            currentIndex = 0; markDirty(); saveDataToDB(); renderLists(); updateCard();
            closeModal('importModal'); showToast("å·²æ›´æ–°åˆ—è¡¨ (éŒ„éŸ³å·²é‡ç½®)");
        }

        function exportData() {
            const text = `ã€è©èªè¡¨ã€‘\n${words.map(w=>w.text).join('\n')}\n\nã€é‚„è¦ç·´ã€‘\n${reviewWords.map(w=>w.text).join('\n')}\n\nã€å·²å­¸è­˜ã€‘\n${masteredWords.map(w=>w.text).join('\n')}`;
            navigator.clipboard.writeText(text).then(() => showToast("å·²è¤‡è£½æ–‡å­—ï¼(éŒ„éŸ³ç„¡æ³•å°å‡º)")).catch(() => showToast("è¤‡è£½å¤±æ•—"));
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg; t.style.opacity = 1;
            setTimeout(() => t.style.opacity = 0, 2500);
        }

        function triggerConfetti(originX, originY, intensity) {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth; canvas.height = window.innerHeight;
            let particles = [];
            const colors = ['#f44336', '#2196f3', '#ffeb3b', '#4caf50', '#9c27b0', '#ff9800'];
            const count = Math.floor(150 * intensity); 
            for (let i = 0; i < count; i++) {
                const isBurst = originX != null;
                particles.push({
                    x: isBurst ? originX : Math.random() * canvas.width,
                    y: isBurst ? originY : Math.random() * canvas.height - canvas.height,
                    w: Math.random() * 10 + 5, h: Math.random() * 5 + 5,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    vy: isBurst ? (Math.random() * -15 - 5) : (Math.random() * 3 + 2), 
                    vx: isBurst ? (Math.random() * 10 - 5) : (Math.random() * 2 - 1),
                    gravity: isBurst ? 0.5 : 0,
                    r: Math.random() * 360, vr: Math.random() * 10 - 5
                });
            }
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let active = false;
                particles.forEach(p => {
                    p.vy += p.gravity; p.y += p.vy; p.x += p.vx; p.r += p.vr;
                    if (p.y < canvas.height) {
                        active = true;
                        ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.r * Math.PI / 180);
                        ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                    }
                });
                if (active) requestAnimationFrame(animate);
            }
            animate();
        }

        window.onload = init;
    </script>
</body>
</html>
